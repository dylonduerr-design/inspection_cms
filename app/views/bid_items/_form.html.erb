<%# The form now takes an array [@project, bid_item] to build the correct nested URL %>
<%= form_with(model: [@project, bid_item], class: "contents") do |form| %>
  
  <% if bid_item.errors.any? %>
    <div class="error-explanation">
      <h2><%= pluralize(bid_item.errors.count, "error") %> prohibited saving:</h2>
      <ul><% bid_item.errors.each do |error| %><li><%= error.full_message %></li><% end %></ul>
    </div>
  <% end %>

  <div class="form-card" style="max-width: 600px; margin: 0 auto;">
    
    <div style="margin-bottom: 20px; background: #f9fafb; padding: 10px; border-radius: 6px;">
      <strong>Project:</strong> <%= @project.name %>
    </div>

    <div class="form-group">
      <%= form.label :code, "Project Item Code" %>
      <%= form.text_field :code, placeholder: "e.g. CD-12 or P-401" %>
      <small class="text-muted">This is the code used in the contract documents.</small>
    </div>

    <div class="form-group">
      <%= form.label :spec_item_id, "Link to FAA Specification (Universal)" %>
      <%# This is the 'Rosetta Stone' link %>
      <%= form.collection_select :spec_item_id, SpecItem.all.order(:code), :id, :description, { prompt: "Select FAA Spec..." }, { class: "form-control" } %>
    </div>

    <div class="form-group">
      <%= form.label :description, "Item Description" %>
      <%= form.text_field :description %>
    </div>

    <div class="form-group">
      <%= form.label :unit %>
      <%= form.text_field :unit, placeholder: "e.g. SY, CY, EA" %>
    </div>

    <hr style="margin: 20px 0;">

    <div class="form-group">
      <%= form.label :questions_text, "Override Checklist (Optional)" %>
      <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">
        <em>Leave blank to use the standard FAA Spec checklist.</em>
      </div>
      <%= form.text_area :questions_text, rows: 5 %>
    </div>

    <div style="margin-top: 20px;">
      <%= form.submit "Save to Project Library", class: "btn btn-primary", style: "width: 100%;" %>
    </div>
    
    <div style="text-align: center; margin-top: 15px;">
       <%= link_to "Cancel", project_bid_items_path(@project) %>
    </div>

  </div>
<% end %>