<%# app/views/reports/_spec_check_card.html.erb %>
<div class="form-card" 
     data-controller="spec-drilldown" 
     data-spec-drilldown-report-id-value="<%= report.id %>">
     
  <div class="spec-header-row">
    <h2 class="form-section-title" style="margin-bottom: 0;">Specification Checklists</h2>
    <button type="button" 
            class="btn-secondary" 
            data-action="click->spec-drilldown#openModal">
      + Add Spec Checklist
    </button>
  </div>

  <%# --- 1. ACTIVE CHECKLISTS GRID --- %>
  <%# We use the existing 'gallery-grid' class from application.css %>
  <div id="active-checklists-list" class="gallery-grid">
    <% if report.checklist_entries.any? %>
      <% report.checklist_entries.each do |entry| %>
        <%# This renders existing saved entries %>
        <div class="gallery-card" 
             style="padding: 15px; text-align: left;" 
             data-spec-code="<%= entry.spec_item.code %>"
             data-spec-id="<%= entry.spec_item.id %>"
             data-answers="<%= entry.checklist_answers.to_json %>">
             
          <div style="font-weight: bold; color: var(--primary); margin-bottom: 5px;">
            <%= entry.spec_item.code %>
          </div>
          <div class="text-muted-sm" style="margin-bottom: 10px; height: 40px; overflow: hidden;">
            <%= entry.spec_item.description %>
          </div>
          
          <button type="button" 
                  class="btn-secondary w-full text-muted-sm"
                  data-action="click->spec-drilldown#editSpec">
            ✎ Edit Checklist
          </button>
          
          <%# Hidden field to ensure existing records are kept/updated if needed (handled by Rails normally) %>
        </div>
      <% end %>
    <% else %>
      <%# Empty State %>
      <div class="spec-empty-state">
        No specification checklists added yet.<br>
        Click <strong>+ Add Spec Checklist</strong> to select required inspections.
      </div>
    <% end %>
  </div>

  <%# --- 2. DATA STORE --- %>
  <script id="spec-data-store" type="application/json">
    <%= SpecItem.all.select(:id, :code, :description, :division, :checklist_questions).to_json.html_safe %>
  </script>

  <%# --- 3. DRILL-DOWN MODAL --- %>
  <dialog data-spec-drilldown-target="modal" class="spec-modal">
    
    <div class="spec-modal-header">
      <h3 data-spec-drilldown-target="modalTitle" style="margin: 0;">Select Division</h3>
      <button type="button" class="btn-clear" data-action="click->spec-drilldown#closeModal">✕</button>
    </div>

    <div class="spec-modal-body">
      
      <%# VIEW A: DIVISIONS LIST %>
      <div data-spec-drilldown-target="viewDivisions">
        <% SpecItem.select(:division).distinct.order(:division).each do |s| %>
            <button type="button" 
                    class="spec-selection-btn"
                    data-action="click->spec-drilldown#selectDivision"
                    data-division="<%= s.division %>">
              <strong><%= s.division %></strong>
              <span>›</span>
            </button>
        <% end %>
      </div>

      <%# VIEW B: SPEC LIST %>
      <div data-spec-drilldown-target="viewSpecs" style="display: none;">
         <button type="button" class="btn-clear mb-2" data-action="click->spec-drilldown#showDivisions">← Back</button>
         <div data-spec-drilldown-target="specListContainer"></div>
      </div>

      <%# VIEW C: FORM %>
      <div data-spec-drilldown-target="viewForm" style="display: none;">
         <button type="button" class="btn-clear mb-2" data-action="click->spec-drilldown#showSpecs">← Back</button>
         <div data-spec-drilldown-target="checklistFormPlaceholder"></div>
      </div>

    </div>
  </dialog>
</div>