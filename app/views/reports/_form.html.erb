<%= form_with(model: report, id: "report-form", multipart: true) do |form| %>
  
  <%# --- 1. ERROR HANDLING BLOCK (Corrected) --- %>
  <% if report.errors.any? %>
    <div class="error-explanation">
      <h2><%= pluralize(report.errors.count, "error") %> prohibited this report from being saved:</h2>
      <ul>
        <% report.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# --- 2. MAIN FORM CONTENT --- %>
  <div class="form-card">
    <h2>1. General Information</h2>

    <div class="form-row">
      <div class="form-group">
        <label>Inspection Date</label>
        <%= form.date_field :inspection_date %>
      </div>
      <div class="form-group">
        <label>Inspector</label>
        <%= form.text_field :inspector %> 
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Contractor</label>
        <%= form.text_field :contractor %>
      </div>
      <div class="form-group">
        <label>Project</label>
        <%= form.collection_select :project_id, Project.all, :id, :name, {}, {} %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group full-width">
        <label>Phase</label>
        <%= form.collection_select :phase_id, Phase.all, :id, :name, {}, {} %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Shift Start</label>
        <%= form.select :shift_start, ["06:00 AM", "07:00 AM", "08:00 AM", "06:00 PM", "07:00 PM"], {include_blank: true}, {} %>
      </div>
      <div class="form-group">
        <label>Shift End</label>
        <%= form.select :shift_end, ["02:00 PM", "03:00 PM", "04:00 PM", "05:00 PM", "02:00 AM"], {include_blank: true}, {} %>
      </div>
      <div class="form-group">
        <label>Temp (Â°F)</label>
        <%= form.number_field :temperature %>
      </div>
      <div class="form-group">
        <label>Weather</label>
        <%= form.text_field :weather %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Start Station</label>
        <%= form.text_field :station_start, placeholder: "e.g. 100+00" %>
      </div>
      <div class="form-group">
        <label>End Station</label>
        <%= form.text_field :station_end, placeholder: "e.g. 105+50" %>
      </div>
    </div>
  </div>

 <div class="form-card">
  <h2>2. Inspection Checklist</h2>

  <%# --- HELPER: MAP DATABASE KEYS TO CLEAN LABELS --- %>
  <% 
    deficiency_labels = { "no_deficiency" => "No", "yes_deficiency" => "Yes", "cdr" => "CDR", "ncr" => "NCR" }
    safety_labels     = { "safety_no" => "No", "safety_yes" => "Yes", "safety_na" => "N/A" }
    
    pretty_label = ->(key) {
      k = key.to_s.downcase
      return "N/A" if k.include?("na")
      return "No" if k.include?("no")
      return "Yes" if k.include?("yes")
      key.humanize
    }
  %>

  <div class="form-row">
    <div class="form-group full-width">
      <label>Deficiencies Identified?</label>
      <div class="radio-group">
        <% Report.deficiency_statuses.keys.each do |k| %>
          <label class="radio-label">
            <%= form.radio_button :deficiency_status, k, class: "deficiency-trigger" %> 
            <span><%= deficiency_labels[k] || pretty_label.call(k) %></span>
          </label>
        <% end %>
      </div>
      
      <div id="deficiency-note" class="conditional-field" style="display: none;">
        <label>Description of Deficiency</label>
        <%= form.text_area :deficiency_desc, rows: 3, placeholder: "Describe the deficiency here..." %>
      </div>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group full-width">
      <label>Safety Incidents?</label>
      <div class="radio-group">
        <% Report.safety_incidents.keys.each do |k| %>
          <label class="radio-label">
            <%= form.radio_button :safety_incident, k, class: "safety-trigger" %> 
            <span><%= safety_labels[k] || pretty_label.call(k) %></span>
          </label>
        <% end %>
      </div>

      <div id="safety-note" class="conditional-field" style="display: none;">
        <label>Describe Incident</label>
        <%= form.text_area :safety_desc, rows: 3, placeholder: "Describe the safety incident..." %>
      </div>
    </div>
  </div>

  <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 1.5rem 0;">

  <div class="form-row">
    <div class="form-group">
      <label>Traffic Control Compliance?</label>
      <div class="radio-group vertical">
        <% Report.traffic_controls.keys.each do |k| %>
          <label class="radio-label">
            <%= form.radio_button :traffic_control, k %> 
            <span><%= pretty_label.call(k) %></span>
          </label>
        <% end %>
      </div>
    </div>

    <div class="form-group">
      <label>Environmental/SWPPP Compliance?</label>
      <div class="radio-group vertical">
        <% Report.environmentals.keys.each do |k| %>
          <label class="radio-label">
            <%= form.radio_button :environmental, k %> 
            <span><%= pretty_label.call(k) %></span>
          </label>
        <% end %>
      </div>
    </div>

    <div class="form-group">
      <label>Security and Air Ops Compliance?</label>
      <div class="radio-group vertical">
        <% Report.securities.keys.each do |k| %>
          <label class="radio-label">
            <%= form.radio_button :security, k %> 
            <span><%= pretty_label.call(k) %></span>
          </label>
        <% end %>
      </div>
    </div>
  </div>

  <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 1.5rem 0;">

  <div class="form-row">
    <div class="form-group full-width">
      <label style="font-size: 1.1rem; color: var(--text-main); cursor: pointer;">
        <%= form.check_box :qa_activity, id: "qa_check", style: "width: auto; margin-right: 10px;" %> 
        QA Testing Performed?
      </label>

      <div id="qa-section" class="qa-panel" style="display: none;">
        <div class="form-row">
          <div class="form-group">
            <label>Item</label>
            <%= form.collection_select :qa_bid_item_id, BidItem.all, :id, :code, {include_blank: true} %>
          </div>
          <div class="form-group">
            <label>Type</label>
            <%= form.select :qa_type, Report.qa_types.keys.map{|k| [k.humanize, k]}, {include_blank: true} %>
          </div>
          <div class="form-group">
            <label>Result</label>
            <%= form.select :qa_result, Report.qa_results.keys.map{|k| [k.humanize, k]}, {include_blank: true} %>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

  <div class="form-card">
  <h2>3. Crew & Equipment</h2>

  <div class="form-row">
    <div class="form-group full-width">
      <label>Foreman Name</label>
      <%= form.text_field :foreman, placeholder: "e.g. John Doe" %>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group">
      <label>Laborers</label>
      <%= form.number_field :laborer_count, min: 0 %>
    </div>
    <div class="form-group">
      <label>Operators</label>
      <%= form.number_field :operator_count, min: 0 %>
    </div>
    <div class="form-group">
      <label>Surveyors</label>
      <%= form.number_field :survey_count, min: 0 %>
    </div>
  </div>

  <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 2rem 0;">

  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h3 style="margin: 0; font-size: 1.1rem; color: var(--text-main);">ðŸšœ Equipment Log</h3>
  </div>

  <div class="equipment-header" style="display: flex; gap: 10px; margin-bottom: 5px; font-weight: 600; color: var(--text-muted); font-size: 0.9rem;">
    <div style="flex: 3;">Make / Model</div>
    <div style="flex: 1;">Hours</div>
    <div style="width: 40px; text-align: center;"></div> </div>

  <div id="equipment-fields-container">
    <%= form.fields_for :equipment_entries do |eq_form| %>
      <div class="equipment-row">
        <%= eq_form.text_field :make_model, placeholder: "e.g. Cat D6 Dozer", style: "flex: 3;" %>
        <%= eq_form.number_field :hours, step: 0.5, placeholder: "0.0", style: "flex: 1;" %>
        
        <% if eq_form.object.persisted? %>
          <div style="width: 40px; display: flex; justify-content: center;">
            <label class="delete-icon" title="Delete Line">
              <%= eq_form.check_box :_destroy, style: "display: none;" %> 
              âœ•
            </label>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <button type="button" id="add-equipment-btn" class="btn-secondary">
    + Add Piece of Equipment
  </button>
</div>

  <div class="form-card">
  <h2>4. Quantities & Documents</h2>

  <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem; color: var(--text-main);">ðŸ“Š Quantities Reported</h3>
  
  <div class="equipment-header" style="display: flex; gap: 10px; margin-bottom: 5px; font-weight: 600; color: var(--text-muted); font-size: 0.9rem;">
    <div style="flex: 2;">Bid Item</div>
    <div style="flex: 1;">Location / Station</div>
    <div style="flex: 1;">Quantity</div>
    <div style="width: 40px;"></div>
  </div>

  <div id="quantity-fields-container">
    <%= form.fields_for :inspection_entries do |entry_form| %>
      <div class="quantity-row">
        <div style="flex: 2;">
          <%= entry_form.collection_select :bid_item_id, BidItem.all, :id, :code, {include_blank: "Select Item..."}, {} %>
        </div>
        <div style="flex: 1;">
          <%= entry_form.text_field :location, placeholder: "Station" %>
        </div>
        <div style="flex: 1;">
          <%= entry_form.number_field :quantity, step: 0.01, placeholder: "0.00" %>
        </div>
        
        <% if entry_form.object.persisted? %>
          <div style="width: 40px; display: flex; justify-content: center;">
             <label class="delete-icon" title="Delete Line">
               <%= entry_form.check_box :_destroy, style: "display: none;" %> âœ•
             </label>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <button type="button" id="add-quantity-btn" class="btn-secondary">
    + Add Bid Item Quantity
  </button>

  <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 2rem 0;">

  <div class="form-row">
    <div class="form-group">
      <label>Plan Sheet Ref</label>
      <%= form.text_field :plan_sheet, placeholder: "e.g. C-102" %>
    </div>
    <div class="form-group">
      <label>Relevant Docs</label>
      <%= form.text_field :relevant_docs, placeholder: "e.g. RFI #402" %>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group full-width">
      <label>General Commentary / Notes</label>
      <%= form.text_area :commentary, rows: 4, placeholder: "Enter daily summary..." %>
    </div>
  </div>

  <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 2rem 0;">

  <h3 style="margin-bottom: 1rem; font-size: 1.1rem; color: var(--text-main);">ðŸ“· Photos & Attachments</h3>

  <div class="attachment-gallery">
    <%= form.fields_for :report_attachments do |attachment_form| %>
      <% if attachment_form.object.persisted? %>
        <div class="attachment-card">
          <div class="img-preview">
            <% if attachment_form.object.file.representable? %>
               <%= image_tag attachment_form.object.file.variant(resize_to_limit: [300, 200]) %>
            <% else %>
               <div class="file-icon" style="font-size: 2rem;">ðŸ“„</div>
            <% end %>
          </div>
          
          <div class="caption-input">
             <%= attachment_form.text_field :caption, placeholder: "Caption..." %>
          </div>

          <label class="delete-btn-text">
            <%= attachment_form.check_box :_destroy %> Delete
          </label>
        </div>
      <% end %>
    <% end %>
  </div>

  <div id="new-attachments-container" style="margin-top: 15px;"></div>

  <button type="button" id="add-attachment-btn" class="btn-secondary" style="background-color: var(--border-focus); color: white; border-color: var(--border-focus);">
    + Upload New Photo/Document
  </button>
</div>

<div class="actions" style="margin-top: 2rem; text-align: right;">
  <%= form.submit "Save & Submit Report", class: "btn-primary-action" %>
</div> 
<% end %>
    
    

<template id="attachment-template">
  <div class="attachment-row" style="border: 1px dashed var(--border-color); padding: 10px; margin-bottom: 10px; background: var(--bg-hover); display: flex; align-items: flex-start; gap: 10px;">
    <div style="flex: 1;">
      <label style="color: var(--text-main);">Select File:</label>
      <input type="file" name="report[report_attachments_attributes][NEW_RECORD][file]" accept="image/*,.pdf,.doc,.docx" required>
    </div>
    <div style="flex: 2;">
      <label style="color: var(--text-main);">Caption:</label>
      <input type="text" name="report[report_attachments_attributes][NEW_RECORD][caption]" placeholder="Describe this photo..." style="width: 100%; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-main);">
    </div>
    <button type="button" class="remove-row-btn" style="background: none; border: none; color: #dc3545; cursor: pointer; font-weight: bold;">X</button>
  </div>
</template>

<template id="quantity-template">
  <div class="quantity-row">
    <div style="flex: 2;">
      <select name="report[inspection_entries_attributes][NEW_RECORD][bid_item_id]">
         <option value="">Select Item...</option>
         <%= options_from_collection_for_select(BidItem.all, :id, :code) %>
      </select>
    </div>
    <div style="flex: 1;">
      <input type="text" name="report[inspection_entries_attributes][NEW_RECORD][location]" placeholder="Station">
    </div>
    <div style="flex: 1;">
      <input type="number" step="0.01" name="report[inspection_entries_attributes][NEW_RECORD][quantity]" placeholder="0.00">
    </div>
    <div style="width: 40px; display: flex; justify-content: center;">
      <button type="button" class="remove-row-btn" style="border:none; background:none; color:red; font-weight:bold; cursor:pointer;">âœ•</button>
    </div>
  </div>
</template>

<template id="equipment-template">
  <div class="equipment-row">
    <input style="flex: 3" placeholder="Make/Model" type="text" 
           name="report[equipment_entries_attributes][NEW_RECORD][make_model]" 
           class="form-control">
           
    <input style="flex: 1" placeholder="0.0" step="0.5" type="number" 
           name="report[equipment_entries_attributes][NEW_RECORD][hours]" 
           class="form-control">

    <div style="width: 40px; display: flex; justify-content: center;">
      <button type="button" class="remove-row-btn" style="border:none; background:none; color:red; font-weight:bold; cursor:pointer; font-size:1.2rem;">âœ•</button>
    </div>
  </div>
</template>

<script>
function initializeFormLogic() {
  console.log("Initializing form logic...");

  // ==========================================
  // 1. EQUIPMENT SECTION LOGIC
  // ==========================================
  const addEqBtn = document.getElementById("add-equipment-btn");
  const eqContainer = document.getElementById("equipment-fields-container");
  const eqTemplate = document.getElementById("equipment-template");

  // A. Logic for "Existing" rows (Server rendered)
  document.querySelectorAll('input[name*="_destroy"]').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      if (this.checked) {
        // Find the row and hide it (handles both equipment and attachment rows)
        const row = this.closest('.equipment-row') || this.closest('.attachment-card') || this.closest('.quantity-row'); 
        if(row) row.style.display = 'none';
      }
    });
  });

  // B. Logic for "New" Equipment rows
  if(addEqBtn && eqTemplate && eqContainer) {
    const newBtn = addEqBtn.cloneNode(true);
    addEqBtn.parentNode.replaceChild(newBtn, addEqBtn);
    
    newBtn.addEventListener("click", function(e) {
      e.preventDefault();
      const clone = eqTemplate.content.cloneNode(true);
      const uniqueId = new Date().getTime();
      
      clone.querySelectorAll("input").forEach(input => {
        input.name = input.name.replace("NEW_RECORD", uniqueId);
      });

      const removeBtn = clone.querySelector(".remove-row-btn");
      if(removeBtn) {
        removeBtn.addEventListener("click", function(e) {
          e.target.closest(".equipment-row").remove();
        });
      }
      eqContainer.appendChild(clone);
    });
  }

  // ==========================================
  // 2. QUANTITY ADDER LOGIC
  // ==========================================
  const addQtyBtn = document.getElementById("add-quantity-btn");
  const qtyContainer = document.getElementById("quantity-fields-container");
  const qtyTemplate = document.getElementById("quantity-template");

  if(addQtyBtn && qtyTemplate && qtyContainer) {
    const newQtyBtn = addQtyBtn.cloneNode(true);
    addQtyBtn.parentNode.replaceChild(newQtyBtn, addQtyBtn);

    newQtyBtn.addEventListener("click", function(e) {
      e.preventDefault();
      const clone = qtyTemplate.content.cloneNode(true);
      const uniqueId = new Date().getTime();

      clone.querySelectorAll("select, input").forEach(input => {
        input.name = input.name.replace("NEW_RECORD", uniqueId);
      });

      const removeBtn = clone.querySelector(".remove-row-btn");
      if(removeBtn) {
        removeBtn.addEventListener("click", function(e) {
          e.target.closest(".quantity-row").remove();
        });
      }
      qtyContainer.appendChild(clone);
    });
  }

  // ==========================================
  // 3. CHECKLIST TOGGLES (Deficiency & Safety)
  // ==========================================
  function updateToggles() {
    // Deficiency Logic
    const defStatus = document.querySelector('.deficiency-trigger:checked')?.value;
    const defDiv = document.getElementById('deficiency-note');
    if (defDiv) {
      if(["yes_deficiency", "cdr", "ncr"].includes(defStatus)) {
        defDiv.style.display = 'block';
      } else {
        defDiv.style.display = 'none';
      }
    }

    // Safety Logic
    const safetyStatus = document.querySelector('.safety-trigger:checked')?.value;
    const safetyDiv = document.getElementById('safety-note');
    if (safetyDiv) {
      if(safetyStatus === 'safety_yes') {
        safetyDiv.style.display = 'block';
      } else {
        safetyDiv.style.display = 'none';
      }
    }
  }

  document.querySelectorAll('.deficiency-trigger, .safety-trigger').forEach(input => {
    input.addEventListener('change', updateToggles);
  });
  updateToggles(); // Run on load

  // ==========================================
  // 4. QA CHECKBOX LOGIC
  // ==========================================
  const qaCheck = document.getElementById('qa_check');
  const qaSection = document.getElementById('qa-section');
  if(qaCheck && qaSection) {
    qaCheck.addEventListener('change', function() {
      qaSection.style.display = this.checked ? 'block' : 'none';
    });
    qaSection.style.display = qaCheck.checked ? 'block' : 'none';
  }

  // ==========================================
  // 5. ATTACHMENT ADDER LOGIC
  // ==========================================
  const addAttachBtn = document.getElementById("add-attachment-btn");
  const attachContainer = document.getElementById("new-attachments-container");
  const attachTemplate = document.getElementById("attachment-template");

  if(addAttachBtn && attachTemplate && attachContainer) {
    const newAttachBtn = addAttachBtn.cloneNode(true);
    addAttachBtn.parentNode.replaceChild(newAttachBtn, addAttachBtn);

    newAttachBtn.addEventListener("click", function(e) {
      e.preventDefault();
      
      const clone = attachTemplate.content.cloneNode(true);
      const uniqueId = new Date().getTime();
      
      clone.querySelectorAll("input").forEach(input => {
        input.name = input.name.replace("NEW_RECORD", uniqueId);
      });

      const removeBtn = clone.querySelector(".remove-row-btn");
      if(removeBtn) {
        removeBtn.addEventListener("click", function(e) {
          e.target.closest(".attachment-row").remove(); 
        });
      }
      
      attachContainer.appendChild(clone);
    });
  }
}

// LISTEN FOR BOTH STANDARD LOAD AND TURBO LOAD
document.addEventListener("turbo:load", initializeFormLogic);
document.addEventListener("DOMContentLoaded", initializeFormLogic);
</script>