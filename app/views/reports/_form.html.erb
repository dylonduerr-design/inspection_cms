<%# CONNECTING STIMULUS CONTROLLER %>
<%= form_with(model: report, id: "report-form", multipart: true, data: { controller: "report-form" }) do |form| %>
  
  <%# --- 1. ERROR HANDLING --- %>
  <% if report.errors.any? %>
    <div class="error-explanation">
      <h2><%= pluralize(report.errors.count, "error") %> prohibited this report from being saved:</h2>
      <ul>
        <% report.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# --- 2. GENERAL INFO --- %>
  <div class="form-card">
    <h2>1. General Information</h2>

    <div class="form-row">
      <div class="form-group">
        <label>Start Date</label>
        <%= form.date_field :start_date %>
      </div>
      <div class="form-group">
        <label>End Date</label>
        <%= form.date_field :end_date %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Contractor (Prime)</label>
        <%# Added ID 'main-contractor-input' so JS can find it for auto-populating %>
        <%= form.text_field :contractor, id: "main-contractor-input" %>
      </div>
      <div class="form-group">
        <label>Project</label>
        <%= form.collection_select :project_id, Project.all, :id, :name, {prompt: "Select Project"}, {} %>
      </div>
      <div class="form-group full-width">
        <label>Phase</label>
        <%= form.collection_select :phase_id, Phase.all, :id, :name, {prompt: "Select Phase"}, {} %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Shift Start</label>
        <%= form.time_field :shift_start %>
      </div>
      <div class="form-group">
        <label>Shift End</label>
        <%= form.time_field :shift_end %>
      </div>
    </div>

    <%# --- WEATHER TRIO SECTION --- %>
    <hr style="margin: 20px 0; border-top: 1px solid #e5e7eb;">
    <h3 style="font-size: 1rem; color: #4b5563; margin-bottom: 10px;">Weather Readings</h3>
    
    <div class="weather-grid">
      <%# --- COLUMN 1: START --- %>
      <div class="weather-col" style="position: relative;">
        <label>Start of Shift</label>
        <%= form.number_field :temp_1, placeholder: "Temp (¬∞F)", class: "mb-2" %>
        <%= form.text_field :weather_summary_1, placeholder: "Cond. (e.g. Sunny)", class: "mb-2" %>
        <%= form.text_field :wind_1, placeholder: "Wind (e.g. 5mph N)", class: "mb-2" %>
        <%= form.text_field :precip_1, placeholder: "Precipitation" %>
        
        <button type="button" class="btn-secondary weather-fetch-btn" data-suffix="1" style="margin-top: 10px; width: 100%; font-size: 0.8rem;">
          üìç Get Current Weather
        </button>
      </div>

      <%# --- COLUMN 2: MIDDLE --- %>
      <div class="weather-col" style="position: relative;">
        <label>Mid Shift</label>
        <%= form.number_field :temp_2, placeholder: "Temp (¬∞F)", class: "mb-2" %>
        <%= form.text_field :weather_summary_2, placeholder: "Cond. (e.g. Cloudy)", class: "mb-2" %>
        <%= form.text_field :wind_2, placeholder: "Wind", class: "mb-2" %>
        <%= form.text_field :precip_2, placeholder: "Precipitation" %>

        <button type="button" class="btn-secondary weather-fetch-btn" data-suffix="2" style="margin-top: 10px; width: 100%; font-size: 0.8rem;">
          üìç Get Current Weather
        </button>
      </div>

      <%# --- COLUMN 3: END --- %>
      <div class="weather-col" style="position: relative;">
        <label>End of Shift</label>
        <%= form.number_field :temp_3, placeholder: "Temp (¬∞F)", class: "mb-2" %>
        <%= form.text_field :weather_summary_3, placeholder: "Cond. (e.g. Rain)", class: "mb-2" %>
        <%= form.text_field :wind_3, placeholder: "Wind", class: "mb-2" %>
        <%= form.text_field :precip_3, placeholder: "Precipitation" %>

        <button type="button" class="btn-secondary weather-fetch-btn" data-suffix="3" style="margin-top: 10px; width: 100%; font-size: 0.8rem;">
          üìç Get Current Weather
        </button>
      </div>
    </div>

  <%# --- 3. CHECKLIST --- %>
  <div class="form-card">
    <h2>2. Inspection Checklist</h2>

    <% pretty_label = ->(key) { 
      k = key.to_s
      return "No"  if k.include?("no_deficiency") || k.end_with?("_no") || k == "safety_no"
      return "Yes" if k.include?("yes_deficiency") || k.end_with?("_yes") || k == "safety_yes"
      return "N/A" if k.end_with?("_na") || k.end_with?("_na")
      return "CDR" if k == "cdr"
      return "NCR" if k == "ncr"
      k.humanize.gsub(/Tc |Env |Sec |Air |Swppp /, "") 
    } %>

    <div class="form-row">
      <div class="form-group full-width">
        <label>Deficiencies Identified?</label>
        <div class="radio-group">
          <% Report.deficiency_statuses.keys.each do |k| %>
            <label class="radio-label">
              <%= form.radio_button :deficiency_status, k, class: "deficiency-trigger" %> 
              <span><%= pretty_label.call(k) %></span>
            </label>
          <% end %>
        </div>
        <div id="deficiency-note" class="conditional-field" style="display: none;">
          <label class="text-danger">Description of Deficiency</label>
          <%= form.text_area :deficiency_desc, rows: 3 %>
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group full-width">
        <label>Safety Incidents?</label>
        <div class="radio-group">
          <% Report.safety_incidents.keys.each do |k| %>
            <label class="radio-label">
              <%= form.radio_button :safety_incident, k, class: "safety-trigger" %> 
              <span><%= pretty_label.call(k) %></span>
            </label>
          <% end %>
        </div>
        <div id="safety-note" class="conditional-field" style="display: none;">
          <label class="text-danger">Describe Incident</label>
          <%= form.text_area :safety_desc, rows: 3 %>
        </div>
      </div>
    </div>

    <hr style="margin: 1.5rem 0;">

    <div class="form-row">
      <div class="form-group">
        <label>Traffic Control</label>
        <div class="radio-group vertical">
          <% Report.traffic_controls.keys.each do |k| %>
            <label class="radio-label"><%= form.radio_button :traffic_control, k %> <span><%= pretty_label.call(k) %></span></label>
          <% end %>
        </div>
      </div>
      <div class="form-group">
        <label>Environmental</label>
        <div class="radio-group vertical">
          <% Report.environmentals.keys.each do |k| %>
            <label class="radio-label"><%= form.radio_button :environmental, k %> <span><%= pretty_label.call(k) %></span></label>
          <% end %>
        </div>
      </div>
      <div class="form-group">
        <label>Security</label>
        <div class="radio-group vertical">
          <% Report.securities.keys.each do |k| %>
            <label class="radio-label"><%= form.radio_button :security, k %> <span><%= pretty_label.call(k) %></span></label>
          <% end %>
        </div>
      </div>
    </div>
    
    <div class="form-row" style="margin-top: 15px;">
      <div class="form-group">
        <label>Air Ops Coordination</label>
        <div class="radio-group vertical">
          <% Report.air_ops_coordinations.keys.each do |k| %>
            <label class="radio-label"><%= form.radio_button :air_ops_coordination, k %> <span><%= pretty_label.call(k) %></span></label>
          <% end %>
        </div>
      </div>
      <div class="form-group">
        <label>SWPPP Controls</label>
        <div class="radio-group vertical">
          <% Report.swppp_controls.keys.each do |k| %>
            <label class="radio-label"><%= form.radio_button :swppp_controls, k %> <span><%= pretty_label.call(k) %></span></label>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# --- 4. QUALITY ASSURANCE --- %>
  <div class="form-card">
    <h2>Quality Assurance & Control</h2>
    <table class="modern-table" style="width: 100%; margin-bottom: 15px;">
      <thead>
        <tr>
          <th style="width: 25%;">Test Performed</th>
          <th style="width: 25%;">Location</th>
          <th style="width: 20%;">Result</th>
          <th style="width: 25%;">Remarks</th>
          <th style="width: 5%;"></th>
        </tr>
      </thead>
      <tbody id="qa-fields-container">
        <%= form.fields_for :qa_entries do |qa_form| %>
          <tr class="nested-fields">
            <td>
              <%= qa_form.select :qa_type, 
                  QaEntry.qa_types.keys.map { |k| [k.humanize.titleize, k] }, 
                  { prompt: "Select Test..." }, 
                  class: "form-input" %>
            </td>
            <td><%= qa_form.text_field :location, placeholder: "Location", class: "form-input" %></td>
            <td>
              <%= qa_form.select :result, 
                  QaEntry.results.keys.map { |k| [k.humanize.gsub("Qa ", "").titleize, k] }, 
                  { prompt: "Result..." }, 
                  class: "form-input" %>
            </td>
            <td><%= qa_form.text_field :note, placeholder: "Remarks", class: "form-input" %></td>
            <td style="text-align: center;">
              <% if qa_form.object&.persisted? %>
                <label style="color:red; cursor:pointer;">Del <%= qa_form.check_box :_destroy %></label>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    <button type="button" id="add-qa-btn" class="btn-secondary">+ Add QA Test</button>
  </div>

  <%# --- 5. WORKFORCE & EQUIPMENT --- %>
  <div class="form-card">
    <h2>3. Workforce & Equipment</h2>

    <%# --- WORKFORCE LOG --- %>
    <h3>Workforce Log</h3>
    <div id="crew-fields-container">
      <%= form.fields_for :crew_entries do |crew_form| %>
        <div class="nested-entry-card nested-fields" style="margin-bottom: 15px; padding: 15px; border: 1px solid #eee; border-radius: 5px;">
          <div class="form-row">
             <div class="form-group">
               <label>Contractor</label>
               <%= crew_form.text_field :contractor, placeholder: "Contractor Name", class: "auto-contractor" %>
             </div>
             <div class="form-group">
               <label>Superintendent</label>
               <%= crew_form.number_field :superintendent, placeholder: "no." %>
             </div>
             <div class="form-group">
               <label>Foreman</label>
               <%= crew_form.number_field :foreman, placeholder: "no." %>
             </div>
             <div class="form-group">
               <label>Surveyors</label>
               <%= crew_form.number_field :survey_count, placeholder: "no." %>
             </div>
          </div>
          <div class="form-row">
             <div class="form-group">
               <label>Operators</label>
               <%= crew_form.number_field :operator_count, placeholder: "no." %>
             </div>
             <div class="form-group">
               <label>Laborers</label>
               <%= crew_form.number_field :laborer_count, placeholder: "no." %>
             </div>
             <div class="form-group">
               <label>Electricians</label>
               <%= crew_form.number_field :electrician_count, placeholder: "no." %>
             </div>
             <div class="form-group" style="display:flex; align-items:flex-end;">
               <% if crew_form.object&.persisted? %>
                 <label style="color: red; cursor: pointer;">
                   Delete <%= crew_form.check_box :_destroy %>
                 </label>
               <% end %>
             </div>
          </div>
        </div>
      <% end %>
    </div>
    <button type="button" id="add-crew-btn" class="btn-secondary" onclick="autoPopulate('crew')">+ Add Workforce Row</button>

    <hr style="margin: 20px 0;">

    <%# --- EQUIPMENT LOG --- %>
    <h3 style="margin-top: 15px;">Equipment Log</h3>
    <div id="equipment-fields-container">
      <%= form.fields_for :equipment_entries do |eq_form| %>
        <div class="nested-entry-card nested-fields" style="margin-bottom: 10px; padding: 15px; border: 1px solid #eee; border-radius: 5px;">
          <div class="form-row">
            <div class="form-group" style="flex: 2;">
              <label class="text-muted-sm">Contractor</label>
              <%= eq_form.text_field :contractor, placeholder: "Contractor", class: "auto-contractor", style: "width: 100%;" %>
            </div>
            <div class="form-group" style="flex: 3;">
              <label class="text-muted-sm">Make/Model</label>
              <%= eq_form.text_field :make_model, placeholder: "Description", style: "width: 100%;" %>
            </div>
            <div class="form-group" style="flex: 0.5;">
              <label class="text-muted-sm">Qty</label>
              <%= eq_form.number_field :quantity, placeholder: "1", style: "width: 100%;" %>
            </div>
            <div class="form-group" style="flex: 1;">
              <label class="text-muted-sm">Hours</label>
              <%= eq_form.number_field :hours, step: 0.5, placeholder: "Hrs", style: "width: 100%;" %>
            </div>
            
            <div class="form-group" style="display: flex; align-items: flex-end;">
              <% if eq_form.object&.persisted? %>
                <label style="color: red; cursor: pointer; margin-bottom: 10px;">
                  Del <%= eq_form.check_box :_destroy %>
                </label>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
    <button type="button" id="add-equipment-btn" class="btn-secondary" onclick="autoPopulate('equipment')">+ Add Equipment</button>
  </div>

  <%# --- 6. INSPECTION ENTRIES --- %>
  <div class="form-card">
    <h2>4. Inspection Entries (Bid Items)</h2>
    <div id="quantity-fields-container">
      <%= form.fields_for :inspection_entries do |entry_form| %>
        <div class="nested-entry-card nested-fields">
           <div class="form-row" style="margin-bottom: 10px;">
             <div class="form-group" style="flex: 2;">
               <label class="text-muted-sm">Bid Item</label>
               <%= entry_form.select :bid_item_id, 
                     BidItem.all.map { |bi| [bi.code + " - " + bi.description, bi.id, { 'data-questions': bi.checklist_questions.to_json }] }, 
                     { prompt: "Select Item..." }, 
                     { class: "w-full", data: { action: "change->report-form#selectBidItem" } } 
               %>
             </div>
             <%# Note: Location field removed per requirements %>
             <div class="form-group">
               <label class="text-muted-sm">Quantity</label>
               <%= entry_form.number_field :quantity, step: 0.01, placeholder: "Qty" %>
             </div>
           </div>

           <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
             <%= entry_form.hidden_field :checklist_answers, class: "checklist-answers-field" %>
             <button type="button" 
                     class="checklist-btn btn-secondary opacity-50 cursor-not-allowed" 
                     data-action="click->report-form#openChecklist">
               Open Checklist
             </button>
             
             <% if entry_form.object&.persisted? %>
               <label style="margin-left: auto;">Delete <%= entry_form.check_box :_destroy %></label>
             <% end %>
           </div>

           <div class="form-group">
             <%= entry_form.text_field :notes, placeholder: "Daily notes for this item...", class: "w-full" %>
           </div>
        </div>
      <% end %>
    </div>
    <button type="button" id="add-quantity-btn" class="btn-secondary">+ Add Quantity</button>
  </div>

  <%# --- 7. ADDITIONAL INFORMATION --- %>
  <div class="form-card">
    <h2>5. Additional Information</h2>

    <div style="margin-bottom: 15px;">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
        <%= check_box_tag "toggle_activities", "1", report.additional_activities.present?, 
            data: { action: "change->report-form#toggleAdditional", target_id: "box-activities" } %>
        <label for="toggle_activities" style="font-weight: bold; cursor: pointer;">Include "Additional Activities" section?</label>
      </div>
      <div id="box-activities" style="<%= report.additional_activities.present? ? '' : 'display:none;' %>">
        <%= form.text_area :additional_activities, rows: 4, placeholder: "Describe extra work..." %>
      </div>
    </div>

    <div>
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
        <%= check_box_tag "toggle_info", "1", report.additional_info.present?, 
            data: { action: "change->report-form#toggleAdditional", target_id: "box-info" } %>
        <label for="toggle_info" style="font-weight: bold; cursor: pointer;">Include "Additional Information" section?</label>
      </div>
      <div id="box-info" style="<%= report.additional_info.present? ? '' : 'display:none;' %>">
        <%= form.text_area :additional_info, rows: 4, placeholder: "Any other details..." %>
      </div>
    </div>
    
    <hr>
    
    <div class="form-row">
      <div class="form-group full-width">
        <label>General Commentary</label>
        <%= form.text_area :commentary, rows: 4 %>
      </div>
    </div>
  </div>

 <%# --- 8. PHOTOS & ATTACHMENTS --- %>
  <div class="form-card">
    <h2>6. Photos & Attachments</h2>

    <div class="gallery-grid">
      <%= form.fields_for :report_attachments do |attachment_form| %>
        <div class="gallery-card">
          <div class="thumbnail-area">
            <% if attachment_form.object.file.attached? %>
              <% if attachment_form.object.file.representable? %>
                <%= image_tag attachment_form.object.file.representation(resize_to_limit: [400, 400]) %>
              <% else %>
                <span class="doc-icon">üìÑ</span>
              <% end %>
            <% end %>
          </div>
          <div style="padding: 10px;">
            <%= attachment_form.text_field :caption, placeholder: "Enter caption...", class: "form-group input", style: "width: 100%; margin-bottom: 5px;" %>
            <div style="text-align: left; margin-top: 5px; font-size: 0.85rem; color: var(--danger);">
              <label><%= attachment_form.check_box :_destroy %> Delete</label>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <div class="conditional-field" style="margin-top: 20px;">
      <label style="font-weight: bold; display: block; margin-bottom: 10px;">+ Upload New Photos/Documents</label>
      <%= file_field_tag "report[report_attachments_attributes][][file]", multiple: true, class: "form-group input" %>
      <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;"><i>Select multiple files. You can add captions after clicking "Save".</i></p>
    </div>
  </div>

  <div class="actions" style="margin-top: 2rem; text-align: right;">
    <%= form.submit "Save & Submit Report", class: "btn-primary-action" %>
  </div>

  <%# --- MODAL FOR CHECKLIST --- %>
  <dialog data-report-form-target="checklistModal">
    <div class="modal-header"><h3>Inspection Checklist</h3></div>
    <div class="modal-body" data-report-form-target="questionsContainer"></div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" data-action="click->report-form#closeModal">Cancel</button>
      <button type="button" class="btn-primary-action" data-action="click->report-form#saveChecklist">Save Answers</button>
    </div>
  </dialog>

<% end %>

<%# --- TEMPLATES --- %>
<template id="qa-template">
  <tr class="nested-fields">
    <td>
      <select class="form-input" name="report[qa_entries_attributes][NEW_RECORD][qa_type]">
        <option value="">Select Test...</option>
        <% QaEntry.qa_types.keys.each do |k| %>
          <option value="<%= k %>"><%= k.humanize.titleize %></option>
        <% end %>
      </select>
    </td>
    <td><input class="form-input" type="text" placeholder="Location" name="report[qa_entries_attributes][NEW_RECORD][location]"></td>
    <td>
      <select class="form-input" name="report[qa_entries_attributes][NEW_RECORD][result]">
        <option value="">Result...</option>
        <% QaEntry.results.keys.each do |k| %>
          <option value="<%= k %>"><%= k.humanize.gsub("Qa ", "").titleize %></option>
        <% end %>
      </select>
    </td>
    <td><input class="form-input" type="text" placeholder="Remarks" name="report[qa_entries_attributes][NEW_RECORD][note]"></td>
    <td style="text-align: center;"><button type="button" class="remove-row-btn" style="color: red; border: none; background: none;">‚úï</button></td>
  </tr>
</template>

<template id="crew-template">
  <div class="nested-entry-card nested-fields" style="margin-bottom: 15px; padding: 15px; border: 1px solid #eee; border-radius: 5px;">
    <div class="form-row">
       <div class="form-group">
         <label>Contractor</label>
         <input type="text" placeholder="Contractor Name" class="auto-contractor" name="report[crew_entries_attributes][NEW_RECORD][contractor]">
       </div>
       <div class="form-group"><label>Superintendent</label><input type="text" name="report[crew_entries_attributes][NEW_RECORD][superintendent]"></div>
       <div class="form-group"><label>Foreman</label><input type="text" name="report[crew_entries_attributes][NEW_RECORD][foreman]"></div>
       <div class="form-group"><label>Surveyors</label><input type="number" name="report[crew_entries_attributes][NEW_RECORD][survey_count]"></div>
    </div>
    <div class="form-row">
       <div class="form-group"><label>Operators</label><input type="number" name="report[crew_entries_attributes][NEW_RECORD][operator_count]"></div>
       <div class="form-group"><label>Laborers</label><input type="number" name="report[crew_entries_attributes][NEW_RECORD][laborer_count]"></div>
       <div class="form-group"><label>Electricians</label><input type="number" name="report[crew_entries_attributes][NEW_RECORD][electrician_count]"></div>
       <div class="form-group" style="display:flex; align-items:flex-end;">
         <button type="button" class="remove-row-btn" style="color: red;">Delete</button>
       </div>
    </div>
  </div>
</template>

<template id="equipment-template">
  <div class="nested-entry-card nested-fields" style="margin-bottom: 10px; padding: 15px; border: 1px solid #eee; border-radius: 5px;">
    <div class="form-row">
      <div class="form-group" style="flex: 2;">
        <label class="text-muted-sm">Contractor</label>
        <input style="width: 100%;" placeholder="Contractor" class="auto-contractor" type="text" name="report[equipment_entries_attributes][NEW_RECORD][contractor]">
      </div>
      <div class="form-group" style="flex: 3;">
        <label class="text-muted-sm">Make/Model</label>
        <input style="width: 100%;" placeholder="Description" type="text" name="report[equipment_entries_attributes][NEW_RECORD][make_model]">
      </div>
      <div class="form-group" style="flex: 0.5;">
        <label class="text-muted-sm">Qty</label>
        <input style="width: 100%;" placeholder="1" type="number" name="report[equipment_entries_attributes][NEW_RECORD][quantity]">
      </div>
      <div class="form-group" style="flex: 1;">
        <label class="text-muted-sm">Hours</label>
        <input style="width: 100%;" placeholder="Hrs" step="0.5" type="number" name="report[equipment_entries_attributes][NEW_RECORD][hours]">
      </div>
      <div class="form-group" style="display: flex; align-items: flex-end;">
        <button type="button" class="remove-row-btn" style="color: red; margin-bottom: 5px;">Delete</button>
      </div>
    </div>
  </div>
</template>

<template id="quantity-template">
  <div class="nested-entry-card nested-fields">
    <div class="form-row" style="margin-bottom: 10px;">
      <div class="form-group" style="flex: 2;">
        <label class="text-muted-sm">Bid Item</label>
        <select name="report[inspection_entries_attributes][NEW_RECORD][bid_item_id]" class="w-full" data-action="change->report-form#selectBidItem">
            <option value="">Select Item</option>
            <% BidItem.all.each do |bi| %>
              <option value="<%= bi.id %>" data-questions="<%= bi.checklist_questions.to_json %>">
                <%= bi.code %> - <%= bi.description %>
              </option>
            <% end %>
        </select>
      </div>
      <div class="form-group">
        <label class="text-muted-sm">Quantity</label>
        <input class="w-full" type="number" step="0.01" placeholder="Qty" name="report[inspection_entries_attributes][NEW_RECORD][quantity]">
      </div>
    </div>
    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
      <input type="hidden" name="report[inspection_entries_attributes][NEW_RECORD][checklist_answers]" class="checklist-answers-field" value="{}">
      <button type="button" class="checklist-btn btn-secondary opacity-50 cursor-not-allowed" data-action="click->report-form#openChecklist">Open Checklist</button>
      <button type="button" class="remove-row-btn" style="color: red; margin-left: auto;">Delete</button>
    </div>
    <div class="form-group">
      <input type="text" placeholder="Daily notes..." name="report[inspection_entries_attributes][NEW_RECORD][notes]" class="w-full">
    </div>
  </div>
</template>

<script>
document.addEventListener("turbo:load", function() {

  // =========================================================
  // 1. TOGGLE LOGIC (Checkbox/Radio visibility)
  // =========================================================
  function toggleSection(triggerSelector, targetId, validValues = []) {
    document.querySelectorAll(triggerSelector).forEach(input => {
      input.addEventListener('change', () => checkToggle(triggerSelector, targetId, validValues));
    });
    checkToggle(triggerSelector, targetId, validValues);
  }

  function checkToggle(triggerSelector, targetId, validValues) {
    const target = document.getElementById(targetId);
    if(!target) return;

    const checkbox = document.querySelector(triggerSelector + '[type="checkbox"]');
    if(checkbox) {
      target.style.display = checkbox.checked ? 'block' : 'none';
      return;
    }

    const checked = document.querySelector(triggerSelector + ':checked');
    if (checked && validValues.includes(checked.value)) {
      target.style.display = 'block';
    } else {
      target.style.display = 'none';
    }
  }

  // --- ACTIVATE TOGGLES ---
  toggleSection('.deficiency-trigger', 'deficiency-note', ['yes_deficiency', 'cdr', 'ncr']);
  toggleSection('.safety-trigger', 'safety-note', ['safety_yes']);
  toggleSection('#toggle_activities', 'box-activities');
  toggleSection('#toggle_info', 'box-info');


  // =========================================================
  // 2. DYNAMIC ROW ADDER (Crew, Equipment, etc)
  // =========================================================
  function setupAdder(btnId, containerId, templateId) {
    const btn = document.getElementById(btnId);
    if(!btn) return;

    // Clone button to remove old listeners (prevents duplicates)
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);

    newBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const template = document.getElementById(templateId);
      const container = document.getElementById(containerId);
      const clone = template.content.cloneNode(true);
      const uniqueId = new Date().getTime();

      clone.querySelectorAll('input, select').forEach(el => {
        el.name = el.name.replace('NEW_RECORD', uniqueId);
      });

      clone.querySelector('.remove-row-btn')?.addEventListener('click', (e) => {
        e.target.closest('.nested-fields, .equipment-row, tr').remove();
      });

      container.appendChild(clone);
      
      // Auto-populate trigger
      if(btnId === 'add-crew-btn') autoPopulate('crew');
      if(btnId === 'add-equipment-btn') autoPopulate('equipment');
    });
  }

  setupAdder('add-equipment-btn', 'equipment-fields-container', 'equipment-template');
  setupAdder('add-quantity-btn', 'quantity-fields-container', 'quantity-template');
  setupAdder('add-qa-btn', 'qa-fields-container', 'qa-template');
  setupAdder('add-crew-btn', 'crew-fields-container', 'crew-template');


  // =========================================================
  // 3. AUTO-POPULATE LOGIC (Contractor Name)
  // =========================================================
  window.autoPopulate = function(type) {
    setTimeout(() => {
      const mainContractor = document.getElementById("main-contractor-input")?.value || "";
      const container = document.getElementById(type + "-fields-container");
      
      const allInputs = container.querySelectorAll(".auto-contractor");
      const lastInput = allInputs[allInputs.length - 1];

      if(lastInput && mainContractor && lastInput.value === "") {
        lastInput.value = mainContractor;
      }
    }, 50);
  };


  // =========================================================
  // 4. WEATHER AUTOMATION (Open-Meteo)
  // =========================================================
  let activeWeatherSuffix = null;

  // Debugging check:
  const weatherBtns = document.querySelectorAll('.weather-fetch-btn');
  if(weatherBtns.length === 0) console.warn("Maestro Warning: No weather buttons found. Check HTML.");

  weatherBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      
      // 1. Identify Column
      activeWeatherSuffix = btn.dataset.suffix;
      const originalText = btn.innerText;

      if (!navigator.geolocation) {
        alert("Geolocation not supported by this browser.");
        return;
      }

      // 2. Loading State
      btn.innerText = "Locating...";
      btn.disabled = true;

      // 3. Fetch Location
      navigator.geolocation.getCurrentPosition(
        (position) => {
          fetchWeatherData(position, btn, originalText);
        }, 
        (error) => {
          console.error(error);
          alert("Unable to retrieve location. Ensure you are on localhost or HTTPS.");
          btn.innerText = originalText;
          btn.disabled = false;
        }
      );
    });
  });

  function fetchWeatherData(position, btn, originalText) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    btn.innerText = "Fetching...";

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation,weather_code,wind_speed_10m,wind_direction_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        const current = data.current;
        const s = activeWeatherSuffix; 

        // 1. Target Fields
        const tempField = document.querySelector(`[name="report[temp_${s}]"]`);
        const windField = document.querySelector(`[name="report[wind_${s}]"]`);
        const precipField = document.querySelector(`[name="report[precip_${s}]"]`);
        const condField = document.querySelector(`[name="report[weather_summary_${s}]"]`);

        // 2. Populate
        if(tempField) tempField.value = Math.round(current.temperature_2m);
        
        if(windField) {
          const windDir = getCardinalDirection(current.wind_direction_10m);
          windField.value = `${Math.round(current.wind_speed_10m)} mph ${windDir}`;
        }

        if(precipField) precipField.value = current.precipitation;
        
        if(condField) condField.value = decodeWeatherCode(current.weather_code);

        // 3. Reset
        btn.innerText = "‚úì Updated";
        setTimeout(() => {
          btn.innerText = originalText;
          btn.disabled = false;
        }, 2000);
      })
      .catch(err => {
        console.error(err);
        alert("Error connecting to Weather API.");
        btn.innerText = originalText;
        btn.disabled = false;
      });
  }

  // --- Weather Helpers ---
  function getCardinalDirection(angle) {
    const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
    return directions[Math.round(angle / 45) % 8];
  }

  function decodeWeatherCode(code) {
    const codes = {
      0: "Clear sky", 1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
      45: "Fog", 48: "Depositing rime fog",
      51: "Light drizzle", 53: "Moderate drizzle", 55: "Dense drizzle",
      61: "Slight rain", 63: "Moderate rain", 65: "Heavy rain",
      71: "Slight snow", 73: "Moderate snow", 75: "Heavy snow",
      80: "Slight showers", 81: "Moderate showers", 82: "Violent showers",
      95: "Thunderstorm", 96: "Thunderstorm + hail"
    };
    return codes[code] || "Unknown";
  }

}); // <--- END OF TURBO LOAD
</script>