<%= form_with(model: report, id: "report-form", multipart: true) do |form| %>
  
  <%# --- 1. ERROR HANDLING --- %>
  <% if report.errors.any? %>
    <div class="error-explanation">
      <h2><%= pluralize(report.errors.count, "error") %> prohibited this report from being saved:</h2>
      <ul>
        <% report.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# --- 2. GENERAL INFO --- %>
  <div class="form-card">
    <h2>1. General Information</h2>

    <div class="form-row">
      <div class="form-group">
        <label>Inspection Date</label>
        <%= form.date_field :inspection_date %>
      </div>
      <div class="form-group">
        <label>Contractor</label>
        <%= form.text_field :contractor %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Project</label>
        <%= form.collection_select :project_id, Project.all, :id, :name, {}, {} %>
      </div>
      <div class="form-group full-width">
        <label>Phase</label>
        <%= form.collection_select :phase_id, Phase.all, :id, :name, {}, {} %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Shift Start</label>
        <%= form.select :shift_start, ["06:00 AM", "07:00 AM", "08:00 AM", "06:00 PM", "07:00 PM"], {include_blank: true}, {} %>
      </div>
      <div class="form-group">
        <label>Shift End</label>
        <%= form.select :shift_end, ["02:00 PM", "03:00 PM", "04:00 PM", "05:00 PM", "02:00 AM"], {include_blank: true}, {} %>
      </div>
      <div class="form-group">
        <label>Temp (Â°F)</label>
        <%= form.number_field :temperature %>
      </div>
      <div class="form-group">
        <label>Weather</label>
        <%= form.text_field :weather %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Start Station</label>
        <%= form.text_field :station_start, placeholder: "e.g. 100+00" %>
      </div>
      <div class="form-group">
        <label>End Station</label>
        <%= form.text_field :station_end, placeholder: "e.g. 105+50" %>
      </div>
    </div>
  </div>

  <%# --- 3. CHECKLIST --- %>
  <div class="form-card">
    <h2>2. Inspection Checklist</h2>

    <%# Helper Lambda for labels %>
    <% pretty_label = ->(key) { key.to_s.humanize.gsub("Tc ", "").gsub("Env ", "").gsub("Sec ", "") } %>

    <%# --- PROBLEM 1 FIX: Deficiency Section with Alert Styling --- %>
    <div class="form-row">
      <div class="form-group full-width">
        <label>Deficiencies Identified?</label>
        <div class="radio-group">
          <% Report.deficiency_statuses.keys.each do |k| %>
            <label class="radio-label">
              <%= form.radio_button :deficiency_status, k, class: "deficiency-trigger" %> 
              <span><%= pretty_label.call(k) %></span>
            </label>
          <% end %>
        </div>
        
        <div id="deficiency-note" class="conditional-field" style="display: none; background-color: var(--bg-alert); border-left: 4px solid var(--border-alert); padding: 15px;">
          <label style="color: var(--danger); font-weight: bold;">Description of Deficiency</label>
          <%= form.text_area :deficiency_desc, rows: 3, style: "background-color: white;" %>
        </div>
      </div>
    </div>

    <%# --- PROBLEM 1 FIX: Safety Section with Alert Styling --- %>
    <div class="form-row">
      <div class="form-group full-width">
        <label>Safety Incidents?</label>
        <div class="radio-group">
          <% Report.safety_incidents.keys.each do |k| %>
            <label class="radio-label">
              <%= form.radio_button :safety_incident, k, class: "safety-trigger" %> 
              <span><%= pretty_label.call(k) %></span>
            </label>
          <% end %>
        </div>

        <div id="safety-note" class="conditional-field" style="display: none; background-color: var(--bg-alert); border-left: 4px solid var(--border-alert); padding: 15px;">
          <label style="color: var(--danger); font-weight: bold;">Describe Incident</label>
          <%= form.text_area :safety_desc, rows: 3, style: "background-color: white;" %>
        </div>
      </div>
    </div>

    <hr style="margin: 1.5rem 0;">

    <div class="form-row">
      <div class="form-group">
        <label>Traffic Control?</label>
        <div class="radio-group vertical">
          <% Report.traffic_controls.keys.each do |k| %>
            <label class="radio-label"><%= form.radio_button :traffic_control, k %> <span><%= pretty_label.call(k) %></span></label>
          <% end %>
        </div>
      </div>
      <div class="form-group">
        <label>Environmental?</label>
        <div class="radio-group vertical">
          <% Report.environmentals.keys.each do |k| %>
            <label class="radio-label"><%= form.radio_button :environmental, k %> <span><%= pretty_label.call(k) %></span></label>
          <% end %>
        </div>
      </div>
      <div class="form-group">
        <label>Security?</label>
        <div class="radio-group vertical">
          <% Report.securities.keys.each do |k| %>
            <label class="radio-label"><%= form.radio_button :security, k %> <span><%= pretty_label.call(k) %></span></label>
          <% end %>
        </div>
      </div>
    </div>
    
    <hr style="margin: 1.5rem 0;">
    
<%# --- PROBLEM 2 FIX: QA Layout (Corrected) --- %>
    <div class="qa-wrapper" style="margin-bottom: 1rem;">
      <label style="display: flex; align-items: center; gap: 10px; font-weight: bold; font-size: 1.1em; color: var(--primary); cursor: pointer;">
        <%= form.check_box :qa_activity, id: "qa_check", style: "width: auto; margin: 0; cursor: pointer;" %> 
        QA Testing Performed?
      </label>
      
      <div id="qa-section" style="display: none; margin-top: 15px; padding: 20px; background: var(--bg-header); border: 1px solid var(--border-color); border-radius: 6px;">
        <div class="form-row" style="display: flex; gap: 20px; align-items: flex-start;">
          
          <div class="form-group" style="flex: 1;">
            <label>Item</label>
            <%= form.collection_select :qa_bid_item_id, BidItem.all, :id, :code, {include_blank: true}, {class: "form-control", style: "width: 100%"} %>
          </div>
          
          <div class="form-group" style="flex: 1;">
            <label>Type</label>
            <%= form.select :qa_type, Report.qa_types.keys.map{|k| [k.humanize, k]}, {include_blank: true}, {class: "form-control", style: "width: 100%"} %>
          </div>
          
          <div class="form-group" style="flex: 1;">
            <label>Result</label>
            <%= form.select :qa_result, Report.qa_results.keys.map{|k| [k.humanize, k]}, {include_blank: true}, {class: "form-control", style: "width: 100%"} %>
          </div>
          
        </div>
      </div>
    </div>
  </div>

  <%# --- 4. CREW & EQUIPMENT (Nested Forms) --- %>
  <div class="form-card">
    <h2>3. Crew & Equipment</h2>
    
    <div class="form-row">
       <div class="form-group"><label>Foreman</label><%= form.text_field :foreman %></div>
       <div class="form-group"><label>Laborers</label><%= form.number_field :laborer_count %></div>
       <div class="form-group"><label>Operators</label><%= form.number_field :operator_count %></div>
       <div class="form-group"><label>Surveyors</label><%= form.number_field :survey_count %></div>
    </div>

    <h3>Equipment Log</h3>
    <div id="equipment-fields-container">
      <%= form.fields_for :equipment_entries do |eq_form| %>
        <div class="equipment-row" style="display: flex; gap: 10px; margin-bottom: 5px;">
          <%= eq_form.text_field :make_model, placeholder: "Make/Model", style: "flex: 3" %>
          <%= eq_form.number_field :hours, step: 0.5, placeholder: "Hours", style: "flex: 1" %>
          <% if eq_form.object.persisted? %>
            <label>Delete <%= eq_form.check_box :_destroy %></label>
          <% end %>
        </div>
      <% end %>
    </div>
    <button type="button" id="add-equipment-btn" class="btn-secondary">+ Add Equipment</button>
  </div>

  <%# --- 5. QUANTITIES (Nested Forms) --- %>
  <div class="form-card">
    <h2>4. Quantities</h2>
    <div id="quantity-fields-container">
      <%= form.fields_for :inspection_entries do |entry_form| %>
        <div class="quantity-row" style="display: flex; gap: 10px; margin-bottom: 5px;">
           <div style="flex: 2">
             <%= entry_form.collection_select :bid_item_id, BidItem.all, :id, :code, {include_blank: "Select Item"} %>
           </div>
           <div style="flex: 1">
             <%= entry_form.text_field :location, placeholder: "Location" %>
           </div>
           <div style="flex: 1">
             <%= entry_form.number_field :quantity, step: 0.01, placeholder: "Qty" %>
           </div>
           <% if entry_form.object.persisted? %>
             <label>Delete <%= entry_form.check_box :_destroy %></label>
           <% end %>
        </div>
      <% end %>
    </div>
    <button type="button" id="add-quantity-btn" class="btn-secondary">+ Add Quantity</button>
  
    <hr>
    
    <div class="form-row">
      <div class="form-group full-width">
        <label>Notes / Commentary</label>
        <%= form.text_area :commentary, rows: 4 %>
      </div>
    </div>
  </div>

 <%# --- 6. PHOTOS & ATTACHMENTS --- %>
  <div class="form-card">
    <h2>5. Photos & Attachments</h2>

    <div class="gallery-grid">
      <%= form.fields_for :report_attachments do |attachment_form| %>
        <div class="gallery-card">
          
          <div class="thumbnail-area">
            <% if attachment_form.object.file.attached? %>
              <% if attachment_form.object.file.representable? %>
                <%= image_tag attachment_form.object.file.representation(resize_to_limit: [300, 300]) %>
              <% else %>
                <span class="doc-icon">ðŸ“„</span>
              <% end %>
            <% end %>
          </div>

          <div style="padding: 10px;">
            <%= attachment_form.text_field :caption, 
                placeholder: "Enter caption...", 
                class: "form-group input", 
                style: "width: 100%; margin-bottom: 5px;" %>
            
            <div class="download-link">
              <% if attachment_form.object.file.attached? %>
                <%= link_to attachment_form.object.file.filename.to_s, rails_blob_path(attachment_form.object.file, disposition: "attachment"), target: "_blank" %>
              <% end %>
            </div>
            
            <div style="text-align: left; margin-top: 5px; font-size: 0.85rem; color: var(--danger);">
              <label>
                <%= attachment_form.check_box :_destroy %> 
                Delete
              </label>
            </div>
          </div>
        </div>
      <% end %>
    </div>

    <div class="conditional-field" style="margin-top: 20px;">
      <label style="font-weight: bold; display: block; margin-bottom: 10px;">
        + Upload New Photos/Documents
      </label>
      
      <%= file_field_tag "report[report_attachments_attributes][][file]", 
          multiple: true, 
          class: "form-group input" %>
          
      <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 5px;">
        <i>Select multiple files. You can add captions after clicking "Save".</i>
      </p>
    </div>
  </div>



  <div class="actions" style="margin-top: 2rem; text-align: right;">
    <%= form.submit "Save & Submit Report", class: "btn-primary-action" %>
  </div>

<% end %>

<%# --- TEMPLATES FOR JS ADDERS --- %>
<template id="equipment-template">
  <div class="equipment-row" style="display: flex; gap: 10px; margin-bottom: 5px;">
    <input style="flex: 3" placeholder="Make/Model" type="text" name="report[equipment_entries_attributes][NEW_RECORD][make_model]">
    <input style="flex: 1" placeholder="Hours" step="0.5" type="number" name="report[equipment_entries_attributes][NEW_RECORD][hours]">
    <button type="button" class="remove-row-btn" style="color: red;">âœ•</button>
  </div>
</template>

<template id="quantity-template">
  <div class="quantity-row" style="display: flex; gap: 10px; margin-bottom: 5px;">
    <div style="flex: 2">
      <select name="report[inspection_entries_attributes][NEW_RECORD][bid_item_id]">
          <option value="">Select Item</option>
          <%= options_from_collection_for_select(BidItem.all, :id, :code) %>
      </select>
    </div>
    <input style="flex: 1" type="text" placeholder="Location" name="report[inspection_entries_attributes][NEW_RECORD][location]">
    <input style="flex: 1" type="number" step="0.01" placeholder="Qty" name="report[inspection_entries_attributes][NEW_RECORD][quantity]">
    <button type="button" class="remove-row-btn" style="color: red;">âœ•</button>
  </div>
</template>

<script>
document.addEventListener("turbo:load", function() {
  
  // 1. Toggles for Deficiency / Safety / QA
  function toggleSection(triggerSelector, targetId, validValues = []) {
    document.querySelectorAll(triggerSelector).forEach(input => {
      input.addEventListener('change', () => checkToggle(triggerSelector, targetId, validValues));
    });
    checkToggle(triggerSelector, targetId, validValues);
  }

  function checkToggle(triggerSelector, targetId, validValues) {
    const target = document.getElementById(targetId);
    if(!target) return;
    
    // For Checkbox
    const checkbox = document.querySelector(triggerSelector + '[type="checkbox"]');
    if(checkbox) {
      target.style.display = checkbox.checked ? 'block' : 'none';
      return;
    }

    // For Radio
    const checked = document.querySelector(triggerSelector + ':checked');
    if (checked && validValues.includes(checked.value)) {
      target.style.display = 'block';
    } else {
      target.style.display = 'none';
    }
  }

  toggleSection('.deficiency-trigger', 'deficiency-note', ['yes_deficiency', 'cdr', 'ncr']);
  toggleSection('.safety-trigger', 'safety-note', ['safety_yes']);
  toggleSection('#qa_check', 'qa-section');


  // 2. Dynamic Row Adder (Generic)
  function setupAdder(btnId, containerId, templateId) {
    const btn = document.getElementById(btnId);
    if(!btn) return;

    // Clone button to remove old event listeners
    const newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);

    newBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const template = document.getElementById(templateId);
      const container = document.getElementById(containerId);
      const clone = template.content.cloneNode(true);
      const uniqueId = new Date().getTime();

      clone.querySelectorAll('input, select').forEach(el => {
        el.name = el.name.replace('NEW_RECORD', uniqueId);
      });

      clone.querySelector('.remove-row-btn')?.addEventListener('click', (e) => {
        e.target.closest('div').remove();
      });

      container.appendChild(clone);
    });
  }

  setupAdder('add-equipment-btn', 'equipment-fields-container', 'equipment-template');
  setupAdder('add-quantity-btn', 'quantity-fields-container', 'quantity-template');
});
</script>