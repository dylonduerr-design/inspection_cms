<%# app/views/reports/_form.html.erb %>
<%= form_with(model: report, id: "report-form", multipart: true, data: { controller: "report-form" }) do |form| %>
  
  <%# --- ERROR HANDLING --- %>
  <% if report.errors.any? %>
    <div class="error-explanation">
      <h2><%= pluralize(report.errors.count, "error") %> prohibited this report from being saved:</h2>
      <ul>
        <% report.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# =========================================================================
      SECTION 1: GENERAL INFORMATION
      ========================================================================= %>
  <div class="form-card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
      <h2 style="margin:0; border:none;">1. General Information</h2>
      <div style="font-size:0.9rem; color:#666;">DIR #<%= report.dir_number %></div>
    </div>

    <%# =========================================================================
      SECTION 1: GENERAL INFORMATION
      ========================================================================= %>
  <div class="form-card">
    <%# --- HEADER WITH CONTEXT --- %>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
      <div>
        <h2 style="margin:0; border:none; display: inline-block; margin-right: 15px;">1. General Information</h2>
        <%# READ-ONLY PROJECT CONTEXT %>
        <% if report.project %>
          <span style="font-size: 1rem; color: var(--primary); font-weight: 600; background: #eff6ff; padding: 4px 10px; border-radius: 6px; border: 1px solid #dbeafe;">
            üìÇ <%= report.project.name %>
          </span>
          <%# Hidden field ensures the ID is submitted even though we removed the dropdown %>
          <%= form.hidden_field :project_id %>
        <% else %>
          <span style="color: var(--danger);">‚ö† No Project Selected</span>
        <% end %>
      </div>
      <div style="font-size:0.9rem; color:#666; font-family: monospace; background: #f3f4f6; padding: 4px 8px; border-radius: 4px;">
        DIR #<%= report.dir_number %>
      </div>
    </div>

    <%# --- ROW 1: PHASE & CONTRACTOR --- %>
    <div class="form-row">
      <div class="form-group" style="flex: 1;">
        <label>Phase / Area</label>
        <%= form.collection_select :phase_id, Phase.all, :id, :name, {prompt: "Select Phase"}, { class: "form-control" } %>
      </div>
      <div class="form-group" style="flex: 2;">
        <label>Prime Contractor</label>
        <%= form.text_field :contractor, id: "main-contractor-input", placeholder: "Enter Prime Contractor Name", style: "font-weight: 500;" %>
      </div>
    </div>

    <%# --- ROW 2: DATES (Restored Split) & TIMES --- %>
    <div class="form-row">
      <div class="form-group">
        <label>Start Date</label>
        <%= form.date_field :start_date %>
      </div>
      <div class="form-group">
        <label>End Date</label>
        <%= form.date_field :end_date %>
      </div>
      <div class="form-group">
        <label>Shift Start</label>
        <%= form.time_field :shift_start %>
      </div>
      <div class="form-group">
        <label>Shift End</label>
        <%= form.time_field :shift_end %>
      </div>
    </div>

    <%# --- WEATHER TRIO (Vertical Layout) --- %>
    <div style="margin-top: 25px;">
      <label style="font-size: 0.85rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Weather Conditions</label>
      
      <div class="weather-grid">
        <%# --- COLUMN 1: START --- %>
        <div class="weather-col">
          <label>Start of Shift</label>
          <%= form.number_field :temp_1, placeholder: "Temp (¬∞F)", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :weather_summary_1, placeholder: "Condition (e.g. Sunny)", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :wind_1, placeholder: "Wind (e.g. 5mph N)", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :precip_1, placeholder: "Precipitation", style: "width: 100%;" %>
          
          <button type="button" class="btn-secondary weather-fetch-btn" 
                  data-action="click->report-form#fetchWeather" 
                  data-suffix="1" 
                  style="margin-top: 10px; width: 100%; font-size: 0.8rem;">
            üìç Auto-Fill
          </button>
        </div>

        <%# --- COLUMN 2: MID --- %>
        <div class="weather-col">
          <label>Mid Shift</label>
          <%= form.number_field :temp_2, placeholder: "Temp (¬∞F)", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :weather_summary_2, placeholder: "Condition", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :wind_2, placeholder: "Wind", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :precip_2, placeholder: "Precipitation", style: "width: 100%;" %>

          <button type="button" class="btn-secondary weather-fetch-btn" 
                  data-action="click->report-form#fetchWeather" 
                  data-suffix="2" 
                  style="margin-top: 10px; width: 100%; font-size: 0.8rem;">
            üìç Auto-Fill
          </button>
        </div>

        <%# --- COLUMN 3: END --- %>
        <div class="weather-col">
          <label>End of Shift</label>
          <%= form.number_field :temp_3, placeholder: "Temp (¬∞F)", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :weather_summary_3, placeholder: "Condition", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :wind_3, placeholder: "Wind", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :precip_3, placeholder: "Precipitation", style: "width: 100%;" %>

          <button type="button" class="btn-secondary weather-fetch-btn" 
                  data-action="click->report-form#fetchWeather" 
                  data-suffix="3" 
                  style="margin-top: 10px; width: 100%; font-size: 0.8rem;">
            üìç Auto-Fill
          </button>
        </div>
      </div>
    </div>
  </div>

  <%# =========================================================================
      SECTION 2: COMPLIANCE & SPECIFICATIONS (Consolidated)
      ========================================================================= %>
  <div class="form-card">
    <h2 style="margin-top:0;">2. Compliance & Checklists</h2>

    <%# --- A. CRITICAL ALERTS --- %>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
      <%# Deficiencies %>
      <div style="background: var(--bg-alert); border: 1px solid var(--border-alert); padding: 15px; border-radius: 8px;">
         <label style="color: var(--danger); font-weight: bold; display: block; margin-bottom: 8px;">Deficiencies / NCRs?</label>
         <div class="radio-group">
            <% Report.deficiency_statuses.keys.each do |k| %>
              <label class="radio-label" style="background:white; border:1px solid #ddd;">
                <%= form.radio_button :deficiency_status, k, 
                    data: { action: "change->report-form#toggleSection", target_id: "deficiency-note", valid_values: ['yes_deficiency', 'cdr', 'ncr'].to_json } %> 
                <span style="font-size:0.8rem;"><%= k.humanize.gsub(' deficiency', '') %></span>
              </label>
            <% end %>
         </div>
         <div id="deficiency-note" style="display: none; margin-top: 10px;">
           <%= form.text_area :deficiency_desc, rows: 2, placeholder: "Describe deficiency...", style: "width:100%;" %>
         </div>
      </div>

      <%# Safety %>
      <div style="background: #fff7ed; border: 1px solid #fed7aa; padding: 15px; border-radius: 8px;">
         <label style="color: #c2410c; font-weight: bold; display: block; margin-bottom: 8px;">Safety Issues?</label>
         <div class="radio-group">
            <% Report.safety_incidents.keys.each do |k| %>
              <label class="radio-label" style="background:white; border:1px solid #ddd;">
                <%= form.radio_button :safety_incident, k, 
                    data: { action: "change->report-form#toggleSection", target_id: "safety-note", valid_values: ['safety_yes'].to_json } %> 
                <span style="font-size:0.8rem;"><%= k == 'safety_yes' ? 'Yes' : (k == 'safety_no' ? 'No' : 'N/A') %></span>
              </label>
            <% end %>
         </div>
         <div id="safety-note" style="display: none; margin-top: 10px;">
           <%= form.text_area :safety_desc, rows: 2, placeholder: "Describe incident...", style: "width:100%;" %>
         </div>
      </div>
    </div>

    <%# --- B. STANDARD COMPLIANCE GRID (Compact) --- %>
    <h3 style="font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 15px;">Site Conditions</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
      
      <%# Helper for small radio groups %>
      <% render_toggle = ->(field_name, label_text, enum_keys) { %>
        <div style="border: 1px solid #eee; padding: 10px; border-radius: 6px;">
          <label style="display:block; font-size:0.8rem; font-weight:700; margin-bottom:8px;"><%= label_text %></label>
          <div style="display:flex; gap:10px;">
            <% enum_keys.each do |k| %>
               <label style="font-size:0.8rem; display:flex; align-items:center; gap:4px; cursor:pointer;">
                 <%= form.radio_button field_name, k %>
                 <%= k.split('_').last.capitalize %>
               </label>
            <% end %>
          </div>
        </div>
      <% } %>

      <% render_toggle.call(:traffic_control, "Traffic Control", Report.traffic_controls.keys) %>
      <% render_toggle.call(:environmental, "Environmental", Report.environmentals.keys) %>
      <% render_toggle.call(:security, "Security", Report.securities.keys) %>
      <% render_toggle.call(:air_ops_coordination, "Air Ops Coord", Report.air_ops_coordinations.keys) %>
      <% render_toggle.call(:swppp_controls, "SWPPP Controls", Report.swppp_controls.keys) %>
    </div>

    <hr style="border-top: 1px solid #e5e7eb; margin: 30px 0;">

    <%# --- C. SPEC CHECKLISTS (Moved Here!) --- %>
    <%= render "spec_check_card", report: report %>

  </div>

  <%# =========================================================================
      SECTION 3: WORKFORCE & EQUIPMENT
      ========================================================================= %>
  <div class="form-card">
    <h2 style="margin-top:0;">3. Workforce & Equipment</h2>

    <%# Crew %>
    <label style="display:block; font-weight:bold; margin-bottom:10px;">Workforce Log</label>
    <div id="crew-fields-container">
      <%= form.fields_for :crew_entries do |crew_form| %>
        <%= render "crew_entry_fields", f: crew_form %>
      <% end %>
    </div>
    <button type="button" class="btn-secondary" data-action="click->report-form#addAssociation" data-template-id="crew-template" data-container-id="crew-fields-container" data-populate-contractor="true" style="margin-bottom:20px;">+ Add Workforce</button>

    <%# Equipment %>
    <label style="display:block; font-weight:bold; margin-bottom:10px; margin-top:20px;">Equipment Log</label>
    <div id="equipment-fields-container">
      <%= form.fields_for :equipment_entries do |eq_form| %>
        <%= render "equipment_entry_fields", f: eq_form %>
      <% end %>
    </div>
    <button type="button" class="btn-secondary" data-action="click->report-form#addAssociation" data-template-id="equipment-template" data-container-id="equipment-fields-container" data-populate-contractor="true">+ Add Equipment</button>
  </div>

  <%# =========================================================================
      SECTION 4: QA & QUANTITIES
      ========================================================================= %>
  <div class="form-card">
    <h2 style="margin-top:0;">4. QA & Quantities</h2>
    
    <%# QA Section %>
    <div style="margin-bottom: 30px;">
      <label style="display:block; font-weight:bold; margin-bottom:10px;">Quality Assurance Tests</label>
      <div id="qa-entries-container">
        <%= form.fields_for :qa_entries do |qa_form| %>
          <%= render "qa_entry_fields", f: qa_form %>
        <% end %>
      </div>
      <button type="button" class="btn-secondary" data-action="click->report-form#addAssociation" data-template-id="qa-template" data-container-id="qa-entries-container">+ Add Test</button>
    </div>

    <hr style="border-top: 1px solid #e5e7eb; margin: 25px 0;">

    <%# Quantities Section %>
    <div style="margin-bottom: 10px;">
      <label style="display:block; font-weight:bold; margin-bottom:10px;">Placed Quantities (Bid Items)</label>
      <div id="quantity-fields-container">
        <%= form.fields_for :placed_quantities do |entry_form| %>
          <div class="nested-entry-card nested-fields">
             <div class="form-row" style="margin-bottom: 10px;">
               <div class="form-group" style="flex: 2;">
                 <label class="text-muted-sm">Bid Item</label>
                 <% collection = report.project ? report.project.bid_items.order(:code) : [] %>
                 <%= entry_form.select :bid_item_id, 
                       collection.map { |bi| [bi.code + " - " + bi.description, bi.id, { 'data-questions': bi.active_questions.to_json }] }, 
                       { prompt: "Select Item..." }, 
                       { class: "w-full", data: { action: "change->report-form#selectBidItem" } } %>
                 <% if report.project.nil? %><small style="color: red;">(Save Project to load items)</small><% end %>
               </div>
               <div class="form-group">
                 <label class="text-muted-sm">Qty</label>
                 <%= entry_form.number_field :quantity, step: 0.01, placeholder: "Qty" %>
               </div>
             </div>
             <div class="nested-row-container" style="margin-bottom: 10px;">
               <%= entry_form.hidden_field :checklist_answers, class: "checklist-answers-field", value: (entry_form.object.checklist_answers || {}).to_json %>
               <button type="button" class="checklist-btn btn-secondary opacity-50 cursor-not-allowed" data-action="click->report-form#openChecklist">Open Checklist</button>
               <% if entry_form.object&.persisted? %>
                 <div style="display:none;"><%= entry_form.check_box :_destroy %></div>
                 <button type="button" class="remove-row-btn" data-action="click->report-form#removeAssociation">‚úï Delete</button>
               <% end %>
             </div>
             <div class="form-group">
               <%= entry_form.text_field :notes, placeholder: "Daily notes for this item...", class: "w-full" %>
             </div>
          </div>
        <% end %>
      </div>
      <button type="button" class="btn-secondary" data-action="click->report-form#addAssociation" data-template-id="placed-quantity-template" data-container-id="quantity-fields-container">+ Add Quantity</button>
    </div>
  </div>

  <%# =========================================================================
      SECTION 5: COMMENTARY & NOTES (Reordered)
      ========================================================================= %>
  <div class="form-card">
    <h2 style="margin-top:0;">5. Commentary & Notes</h2>

    <%# 1. GENERAL COMMENTARY (Now First) %>
    <div class="form-group full-width" style="margin-bottom: 25px;">
      <label style="font-size:1.1rem; color:var(--primary);">General Commentary</label>
      <small style="display:block; color:#666; margin-bottom:5px;">Summary of the day's events, issues, and progress.</small>
      <%= form.text_area :commentary, rows: 6, style: "font-size:1rem; padding:15px;" %>
    </div>

    <hr style="border-top: 1px solid #e5e7eb; margin: 25px 0;">

    <%# 2. ADDITIONAL ACTIVITIES %>
    <div style="margin-bottom: 15px;">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
        <%= check_box_tag "toggle_activities", "1", report.additional_activities.present?, 
            data: { action: "change->report-form#toggleSection", target_id: "box-activities" } %>
        <label for="toggle_activities" style="font-weight: bold; cursor: pointer;">Include "Additional Activities"?</label>
      </div>
      <div id="box-activities" style="<%= report.additional_activities.present? ? '' : 'display:none;' %>">
        <%= form.text_area :additional_activities, rows: 4, placeholder: "Describe extra work..." %>
      </div>
    </div>

    <%# 3. ADDITIONAL INFO %>
    <div>
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
        <%= check_box_tag "toggle_info", "1", report.additional_info.present?, 
            data: { action: "change->report-form#toggleSection", target_id: "box-info" } %>
        <label for="toggle_info" style="font-weight: bold; cursor: pointer;">Include "Additional Information"?</label>
      </div>
      <div id="box-info" style="<%= report.additional_info.present? ? '' : 'display:none;' %>">
        <%= form.text_area :additional_info, rows: 4, placeholder: "Any other details..." %>
      </div>
    </div>
  </div>

  <%# =========================================================================
      SECTION 6: PHOTOS
      ========================================================================= %>
  <div class="form-card">
    <h2 style="margin-top:0;">6. Photos & Attachments</h2>
    <div id="attachments-container" class="gallery-grid">
      <%= form.fields_for :report_attachments do |attachment_form| %>
        <div class="gallery-card nested-fields">
          <div class="thumbnail-area">
            <% if attachment_form.object.file.attached? %>
              <% if attachment_form.object.file.representable? %>
                <%= image_tag attachment_form.object.file.representation(resize_to_limit: [400, 400]) %>
              <% else %>
                <span class="doc-icon">üìÑ</span>
              <% end %>
            <% end %>
          </div>
          <div style="padding: 10px;">
            <%= attachment_form.text_field :caption, placeholder: "Enter caption...", class: "form-group input", style: "width: 100%; margin-bottom: 5px;" %>
            <div style="text-align: left; margin-top: 5px; font-size: 0.85rem; color: var(--danger);">
              <label><%= attachment_form.check_box :_destroy %> Delete</label>
            </div>
          </div>
        </div>
      <% end %>
    </div>
    <button type="button" class="btn-secondary" data-action="click->report-form#addAssociation" data-template-id="attachment-template" data-container-id="attachments-container" style="margin-top: 20px;">+ Add Photo/Document</button>
  </div>

  <%# --- ACTION BAR --- %>
  <div class="actions" style="margin-top: 2rem; text-align: right; position:sticky; bottom:20px; z-index:100;">
    <%= form.submit "Save & Submit Report", class: "btn-primary-action", style: "box-shadow: 0 4px 12px rgba(0,0,0,0.15);" %>
  </div>

  <%# --- DIALOGS & TEMPLATES --- %>
  <dialog data-report-form-target="checklistModal">
    <div class="modal-header"><h3>Inspection Checklist</h3></div>
    <div class="modal-body" data-report-form-target="questionsContainer"></div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" data-action="click->report-form#closeModal">Cancel</button>
      <button type="button" class="btn-primary-action" data-action="click->report-form#saveChecklist">Save Answers</button>
    </div>
  </dialog>

  <%# NOTE: Templates (qa-template, crew-template, etc.) are rendered below, identical to previous version but omitted here for brevity if unchanged. 
      Ensure you keep the <template> tags from the previous file at the bottom! %>
  
  <%# ... [KEEP YOUR <template> TAGS HERE] ... %>
  <%# To save space in this response, I am assuming you will retain the existing templates at the bottom of the file. %>
  <%= render "form_templates" %> 

<% end %>