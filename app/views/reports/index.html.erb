<button id="detective-toggle-btn" title="Toggle Debugger" 
        style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; border: none; background: none; font-size: 2rem; cursor: pointer; opacity: 0.7;"
        onclick="toggleDetective()"> 
  üêû
</button>

<div id="detective-window" style="display: none; background-color: #222; color: #0f0; padding: 20px; margin-bottom: 20px; border: 2px solid #0f0; font-family: monospace;">
  <h3 style="margin-top: 0; color: #0f0;">üïµÔ∏è Detective Report</h3>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <div>
      <p><strong>1. Total Reports in DB:</strong> <%= Report.count %></p>
      <p><strong>2. Reports in this List:</strong> <%= @reports.count %></p>
      <p><strong>3. Current Status Filter:</strong> "<%= params[:status] %>"</p>
    </div>
    <div>
      <p><strong>4. Current Params:</strong></p>
      <code style="color: #ccc; word-break: break-all;"><%= params.to_json %></code>
    </div>
  </div>
  
  <div style="border-top: 1px solid #444; margin-top: 15px; padding-top: 10px; color: #add8e6;">
    <p><strong>5. Who am I?</strong> 
      <% if user_signed_in? %>
        ‚úÖ Logged in as: <strong><%= current_user.email %></strong> (User ID: <%= current_user.id %>)
      <% else %>
        ‚ùå Not Logged In (Guest)
      <% end %>
    </p>
    
    <% if user_signed_in? %>
        <div style="margin-top: 5px;">
          <%= button_to "Log Out (Test Login Flow)", destroy_user_session_path, method: :delete, form: {style: "display:inline-block"}, style: "background-color: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; font-weight: bold;" %>
        </div>
    <% end %>
  </div>
</div>

<div class="dashboard-container">

  <div class="dashboard-header">
    <h1>Inspection Dashboard</h1>
    <div class="header-actions">
      <%= link_to "Export to Excel", reports_path(request.query_parameters.merge(format: :csv)), class: "btn btn-secondary" %>
      <%= link_to "Create New Report", new_report_path, class: "btn btn-primary" %>
    </div>
  </div>

  <div class="dashboard-tabs">
    <% statuses = ['creating', 'qc_review', 'revise', 'authorization', 'all'] %>
    
    <% statuses.each do |status| %>
      <%= link_to status.humanize.titleize, 
          reports_path(params.permit(:inspector, :project_id, :start_date, :end_date, :bid_item_id, :result).merge(status: status)), 
          class: "tab-link #{'active' if params[:status] == status || (params[:status].blank? && status == 'creating')}" 
      %>
    <% end %>
  </div>

  <div class="filter-card">
    <%= form_with url: reports_path, method: :get, local: true, class: "search-form" do |form| %>
      <%= hidden_field_tag :status, params[:status] %>

      <div class="filter-grid">
        <div class="filter-group">
          <label>Date Range</label>
          <div class="date-inputs">
            <%= form.date_field :start_date, value: params[:start_date], class: "form-input", placeholder: "From" %>
            <span class="range-sep">-</span>
            <%= form.date_field :end_date, value: params[:end_date], class: "form-input", placeholder: "To" %>
          </div>
        </div>

        <div class="filter-group">
          <label>Inspector</label>
          <%= form.text_field :inspector, value: params[:inspector], placeholder: "Name...", class: "form-input" %>
        </div>

        <div class="filter-group">
          <label>Result</label>
          <%= select_tag :result, 
              options_for_select([['Pass', 'pass'], ['Fail', 'fail'], ['Pending', 'pending']], params[:result]), 
              prompt: "All Results", 
              class: "form-input" %>
        </div>

        <div class="filter-group">
          <label>Segment</label>
          <%= form.collection_select :project_id, Project.all, :id, :name, { include_blank: "All Projects" }, { selected: params[:project_id], class: "form-input" } %>
        </div>

        <div class="filter-group">
          <label>Contains Bid Item</label>
          <%= form.collection_select :bid_item_id, BidItem.all, :id, :code, { include_blank: "All Items" }, { selected: params[:bid_item_id], class: "form-input" } %>
        </div>

        <div class="filter-actions">
          <%= form.submit "Search", class: "btn btn-search" %>
          <%= link_to "Clear", reports_path(status: params[:status]), class: "btn btn-clear" %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="table-card">
    <table class="modern-table dashboard-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Inspector</th>
          <th>Project</th>
          <th>Phase</th>
          <th>Result</th>
          <th>Status</th>
          <th class="text-right">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if @reports.any? %>
          <% @reports.each do |report| %>
            <tr class="clickable-row">
              <td><%= report.inspection_date %></td>
              <td class="font-medium"><%= report.inspector %></td>
              <td><%= report.project&.name %></td>
              <td><%= report.phase&.name %></td>
              <td>
                <% if report.result == 'pass' %>
                  <span class="text-success">Pass</span>
                <% elsif report.result == 'fail' %>
                  <span class="text-danger">Fail</span>
                <% else %>
                  <span class="text-muted">Pending</span>
                <% end %>
              </td>
              <td>
                <span class="status-badge status-<%= report.status %>">
                  <%= report.status&.humanize %>
                </span>
              </td>
              <td class="text-right">
                <%= link_to "View", report_path(report), class: "link-primary" %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="7" class="text-center py-5" style="padding: 30px; text-align: center; color: #888;">
              <div class="empty-state-message">
                No reports found matching these criteria.
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  
  <div class="dashboard-footer">
    Showing <%= @reports.count %> reports
  </div>

</div>

<script>
  function toggleDetective() {
    var x = document.getElementById("detective-window");
    if (x.style.display === "none") {
      x.style.display = "block";
    } else {
      x.style.display = "none";
    }
  }
</script>