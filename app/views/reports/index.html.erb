<div class="dashboard-container">

  <%# --- 1. CONTEXT HEADER (The "Basket" Selector) --- %>
  <div style="background: var(--bg-card); padding: 20px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-radius: 12px; box-shadow: var(--shadow-sm);">
    
    <div style="display: flex; align-items: center; gap: 15px;">
      <%# A. Label %>
      <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">
        Current Project
      </div>
      
      <%# B. The "Big" Dropdown %>
      <%# We use a simple form that submits on change to "set the context" %>
      <%= form_with url: reports_path, method: :get, local: true, style: "margin:0;" do |f| %>
        <%# Keep existing status/filters if possible, or reset them. Here we keep status. %>
        <%= hidden_field_tag :status, params[:status] %>
        
        <%= f.collection_select :project_id, Project.all, :id, :name, 
            { include_blank: "All Projects (Global View)", selected: params[:project_id] }, 
            { 
              onchange: "this.form.submit()", 
              style: "font-size: 1.25rem; font-weight: 600; padding: 8px 15px; border: 1px solid var(--border-color); border-radius: 6px; color: var(--primary); background: var(--bg-hover); cursor: pointer; min-width: 300px;" 
            } 
        %>
      <% end %>
    </div>

    <div class="header-actions">
      <%# C. Context-Aware Buttons %>
      <%= link_to "Export CSV", reports_path(request.query_parameters.merge(format: :csv)), class: "btn btn-secondary" %>
      
      <%# This button uses the ID from the URL params, which the dropdown above sets %>
      <%= link_to "+ New Report", new_report_path(project_id: params[:project_id]), class: "btn btn-primary", style: "margin-left: 10px;" %>
      
      <%= link_to "Directory", projects_path, class: "btn btn-clear", style: "margin-left: 5px;" %>
    </div>
  </div>

  <%# --- 2. TABS --- %>
  <div class="dashboard-tabs">
    <% statuses = ['creating', 'qc_review', 'revise', 'authorization', 'all'] %>
    <% statuses.each do |status| %>
      <%= link_to status.humanize.titleize, 
          reports_path(params.permit(:inspector, :project_id, :start_date, :end_date, :bid_item_id, :result).merge(status: status)), 
          class: "tab-link #{'active' if params[:status] == status || (params[:status].blank? && status == 'creating')}" 
      %>
    <% end %>
  </div>

  <%# --- 3. SECONDARY FILTERS (Collapsed Project Filter removed from here) --- %>
  <div class="filter-card">
    <%= form_with url: reports_path, method: :get, local: true, class: "search-form" do |form| %>
      <%= hidden_field_tag :status, params[:status] %>
      <%# Keep the project_id hidden here so searching doesn't reset the context %>
      <%= hidden_field_tag :project_id, params[:project_id] %>

      <div class="filter-grid">
        <div class="filter-group">
          <label>Date Range</label>
          <div class="date-inputs">
            <%= form.date_field :start_date, value: params[:start_date], class: "form-input" %>
            <span class="range-sep">-</span>
            <%= form.date_field :end_date, value: params[:end_date], class: "form-input" %>
          </div>
        </div>

        <div class="filter-group">
          <label>Inspector</label>
          <%= form.text_field :inspector, value: params[:inspector], placeholder: "Search email...", class: "form-input" %>
        </div>

        <div class="filter-group">
          <label>Result</label>
          <%= select_tag :result, options_for_select([['Pass', 'pass'], ['Fail', 'fail'], ['Pending', 'pending']], params[:result]), prompt: "All Results", class: "form-input" %>
        </div>

        <div class="filter-group">
          <label>Contains Item</label>
          <%# Only show Bid Items for the selected project to keep it clean %>
          <% items = params[:project_id].present? ? BidItem.where(project_id: params[:project_id]) : BidItem.all %>
          <%= form.collection_select :bid_item_id, items, :id, :code, { include_blank: "Any Item" }, { selected: params[:bid_item_id], class: "form-input" } %>
        </div>

        <div class="filter-actions">
          <%= form.submit "Search", class: "btn btn-search" %>
          <%= link_to "Clear", reports_path(status: params[:status], project_id: params[:project_id]), class: "btn btn-clear" %>
        </div>
      </div>
    <% end %>
  </div>

  <%# --- 4. TABLE (Unchanged) --- %>
  <div class="table-card">
    <table class="modern-table dashboard-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Inspector</th>
          <th>Project</th>
          <th>Phase</th>
          <th>Result</th>
          <th>Status</th>
          <th class="text-right">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if @reports.any? %>
          <% @reports.each do |report| %>
            <tr class="clickable-row">
              <td><%= report.start_date&.strftime("%b %d") %></td>
              <td class="font-medium"><%= report.user.email.split('@').first.titleize %></td>
              <td><%= report.project&.name || "-" %></td>
              <td><%= report.phase&.name || "-" %></td>
              <td>
                <% if report.result == 'pass' %>
                  <span class="text-success">Pass</span>
                <% elsif report.result == 'fail' %>
                  <span class="text-danger">Fail</span>
                <% else %>
                  <span class="text-muted">Pending</span>
                <% end %>
              </td>
              <td><span class="status-badge status-<%= report.status %>"><%= report.status&.humanize %></span></td>
              <td class="text-right"><%= link_to "View", report_path(report), class: "link-primary" %></td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="7" class="text-center py-5" style="padding: 30px; text-align: center; color: #888;">
              No reports found in this project context.
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  
  <div class="dashboard-footer">
    Showing <%= @reports.count %> reports
  </div>
</div>