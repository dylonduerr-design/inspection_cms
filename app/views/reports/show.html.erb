<div class="report-container">
  
  <% if notice %>
    <div class="alert alert-success"><%= notice %></div>
  <% end %>
  <% if alert %>
    <div class="alert alert-danger"><%= alert %></div>
  <% end %>

  <div class="report-header">
    <div class="header-title">
      <h1>Daily Inspection Report #<%= @report.dir_number %></h1>
      <span class="status-badge status-<%= @report.status %>">
        <%= @report.status&.humanize || "Unknown" %>
      </span>
    </div>
    
    <div class="meta-data-grid">
      <div class="meta-item">
        <label>Date</label>
        <div class="value"><%= @report.inspection_date %></div>
      </div>
      <div class="meta-item">
        <label>Inspector</label>
        <div class="value"><%= @report.user.email %></div>
      </div>
      <div class="meta-item">
        <label>Project</label>
        <div class="value"><%= @report.project&.name %></div>
      </div>
      <div class="meta-item">
        <label>Phase</label>
        <div class="value"><%= @report.phase&.name %></div>
      </div>
      <div class="meta-item">
        <label>Result</label>
        <div class="value"><%= @report.result&.humanize || "Pending" %></div>
      </div>
    </div>
  </div>

  <div class="report-section">
    <h3>Quantities Reported</h3>
    <% if @report.inspection_entries.any? %>
      <table class="modern-table">
        <thead>
          <tr>
            <th>Bid Item</th>
            <th>Description</th>
            <th>Location</th>
            <th class="text-right">Quantity</th>
            <th class="text-center">Unit</th>
          </tr>
        </thead>
        <tbody>
          <% @report.inspection_entries.each do |entry| %>
            <tr>
              <td class="code-font"><%= entry.bid_item&.code %></td>
              <td><%= entry.bid_item&.description %></td>
              <td><%= entry.location %></td>
              <td class="text-right font-bold"><%= entry.quantity %></td>
              <td class="text-center text-muted"><%= entry.bid_item&.unit %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <div class="empty-state">No quantities recorded for this report.</div>
    <% end %>
  </div>

  <div class="action-bar-container">
    
    <% if @report.creating? || @report.revise? %>
      <div class="primary-actions">
        <%= button_to "Submit for QC Review", submit_for_qc_report_path(@report), method: :post, class: "btn btn-primary" %>
        <span class="hint-text">(Moves report to QC Tab)</span>
      </div>
    <% end %>

    <% if @report.qc_review? %>
      <div class="qc-panel">
        <div class="qc-header-row">
          <h4>QC Decision</h4>
          <%= button_to "Approve & Authorize", approve_report_path(@report), method: :post, class: "btn btn-success" %>
        </div>
        
        <div class="qc-divider"></div>
        
        <div class="qc-revision-row">
          <%= form_with url: request_revision_report_path(@report), method: :post, local: true, class: "revision-form" do |f| %>
            <label class="revision-label">Return for Revision:</label>
            <div class="input-group">
              <%= text_area_tag 'note', nil, placeholder: "Enter reason for rejection...", rows: 1, class: "form-input revision-input" %>
              <%= f.submit "Return to Inspector", class: "btn btn-danger" %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <div class="nav-links">
      <%= link_to "ðŸ“¥ Export to Word", export_word_report_path(@report), class: "btn-link" %>
      <span class="divider">|</span>
      <%= link_to "Edit Details", edit_report_path(@report) %>
      <span class="divider">|</span>
      <%= link_to "Back to List", reports_path %>
    </div>
  </div>

  <div class="report-section">
    <h3>Attached Documents & Photos</h3>
    
    <%# FIX 2: Use native .attached? check %>
    <% if @report.attachments.attached? %>
      <div class="gallery-grid">
        <%# FIX 3: Iterate over native attachments %>
        <% @report.attachments.each do |file| %>
          <div class="gallery-card">
            <div class="thumbnail-area">
              <% if file.representable? %>
                <%= link_to rails_blob_path(file, disposition: "attachment"), target: "_blank" do %>
                  <% if file.image? %>
                    <%= image_tag file.variant(resize_to_limit: [300, 300]) %>
                  <% else %>
                    <div class="doc-icon">ðŸ“„</div>
                  <% end %>
                <% end %>
              <% else %>
                <div class="doc-icon">ðŸ“‚</div>
              <% end %>
            </div>
            
            <%# FIX 4: Use filename since we don't have captions anymore %>
            <div class="caption"><%= file.filename %></div>
            
            <div class="download-link">
              <%= link_to "Download", rails_blob_path(file, disposition: "attachment") %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="empty-text">No attachments found.</p>
    <% end %>
  </div>

  <div class="report-section">
    <h3>Activity Log</h3>
    <% if @report.activity_logs.any? %>
      <div class="activity-feed">
        <% @report.activity_logs.order(created_at: :desc).each do |log| %>
          <div class="feed-item">
            <div class="feed-user"><strong><%= log.user.email %></strong></div>
            <div class="feed-date"><%= log.created_at.strftime("%b %d, %I:%M %p") %></div>
            <div class="feed-note"><%= log.note %></div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="empty-text">No activity recorded yet.</p>
    <% end %>
  </div>

</div>