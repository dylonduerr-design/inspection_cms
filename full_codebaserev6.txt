INSPECTION CMS CODEBASE EXPORT - REVISION 6 - 2026-01-11 06:09:51 -0800


================================================================================
FILE: Gemfile
================================================================================
source "https://rubygems.org"

ruby "3.2.2"

# Bundle edge Rails instead: gem "rails", github: "rails/rails", branch: "main"
gem "rails", "~> 7.1.3"

# The original asset pipeline for Rails [https://github.com/rails/sprockets-rails]
gem "sprockets-rails"

# Use postgresql as the database for Active Record
gem "pg", "~> 1.1"

# Use the Puma web server [https://github.com/puma/puma]
gem "puma", ">= 5.0"

# Use JavaScript with ESM import maps [https://github.com/rails/importmap-rails]
gem "importmap-rails"

# Hotwire's SPA-like page accelerator [https://turbo.hotwired.dev]
gem "turbo-rails"

# Hotwire's modest JavaScript framework [https://stimulus.hotwired.dev]
gem "stimulus-rails"

# Build JSON APIs with ease [https://github.com/rails/jbuilder]
gem "jbuilder"

# Use Redis adapter to run Action Cable in production
# gem "redis", ">= 4.0.1"

# Use Kredis to get higher-level data types in Redis [https://github.com/rails/kredis]
# gem "kredis"

# Use Active Model has_secure_password [https://guides.rubyonrails.org/active_model_basics.html#securepassword]
# gem "bcrypt", "~> 3.1.7"

# Windows does not include zoneinfo files, so bundle the tzinfo-data gem
gem "tzinfo-data", platforms: %i[ windows jruby ]

# Reduces boot times through caching; required in config/boot.rb
gem "bootsnap", require: false

# Use Active Storage variants [https://guides.rubyonrails.org/active_storage_overview.html#transforming-images]
 gem "image_processing", "~> 1.2"

group :development, :test do
  # See https://guides.rubyonrails.org/debugging_rails_applications.html#debugging-with-the-debug-gem
  gem "debug", platforms: %i[ mri windows ]
end

group :development do
  # Use console on exceptions pages [https://github.com/rails/web-console]
  gem "web-console"

  # Add speed badges [https://github.com/MiniProfiler/rack-mini-profiler]
  # gem "rack-mini-profiler"

  # Speed up commands on slow machines / big apps [https://github.com/rails/spring]
  # gem "spring"
end

group :test do
  # Use system testing [https://guides.rubyonrails.org/testing.html#system-testing]
  gem "capybara"
  gem "selenium-webdriver"
end

gem "devise", "~> 4.9"

gem "docx"

gem "rubyzip"

================================================================================
FILE: config.ru
================================================================================
# This file is used by Rack-based servers to start the application.

require_relative "config/environment"

run Rails.application
Rails.application.load_server


================================================================================
FILE: app/assets/config/manifest.js
================================================================================
//= link_tree ../images
//= link_directory ../stylesheets .css
//= link_tree ../../javascript .js
//= link_tree ../../../vendor/javascript .js


================================================================================
FILE: app/assets/stylesheets/application.css
================================================================================
/*
 * APPLICATION.CSS - The Master Stylesheet (Maestro Enhanced Edition)
 * Contains: Variables, Global Layout, Dashboard, Form, and Report View Styles
 */

/* =========================================
   0. IMPORTS (Typography)
   ========================================= */
/* The 'Inter' font is the industry standard for clean, legible UI */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

/* =========================================
   1. ROOT VARIABLES & THEME CONFIGURATION
   ========================================= */
:root {
  /* Light Mode (Default) */
  --bg-body: #f3f4f6;       /* Slightly cooler gray */
  --bg-card: #ffffff;
  --bg-header: #f9fafb;     /* Very subtle off-white for headers */
  --bg-input: #ffffff;
  --bg-hover: #f3f4f6;
  --bg-alert: #fef2f2;
  
  /* Text Colors - softer than pure black */
  --text-main: #111827;     /* Dark Gray, almost black */
  --text-muted: #6b7280;    /* Medium Gray */
  --text-light: #9ca3af;    /* Light Gray */
  
  --border-color: #e5e7eb;
  --border-focus: #3b82f6;  /* Bright Blue */
  --border-alert: #ef4444;
  
  /* Modern Shadows (Smoother diffusion) */
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-float: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

  /* Brand Colors */
  --primary: #2563eb;       /* Royal Blue */
  --primary-hover: #1d4ed8;
  --success: #059669;       /* Emerald */
  --danger: #dc2626;        /* Red */
  --warning: #d97706;       /* Amber */

  /* QC Panel Specifics */
  --qc-bg: #fffbeb;
  --qc-border: #fcd34d;
  --qc-text: #92400e;
  
  /* Status Colors (Pastel backgrounds, dark text) */
  --status-creating-bg: #eff6ff; --status-creating-text: #1e40af;
  --status-pending-bg: #fffbeb;  --status-pending-text: #92400e;
  --status-approved-bg: #ecfdf5; --status-approved-text: #065f46;
  --status-revise-bg: #fef2f2;   --status-revise-text: #991b1b;
}

/* Dark Mode Overrides */
[data-theme="dark"] {
  --bg-body: #111827;
  --bg-card: #1f2937;
  --bg-header: #374151;
  --bg-input: #374151;
  --bg-hover: #4b5563;
  --bg-alert: #7f1d1d;
  
  --text-main: #f9fafb;
  --text-muted: #d1d5db;
  --text-light: #9ca3af;
  
  --border-color: #4b5563;
  --border-focus: #60a5fa;
  --border-alert: #f87171;
  
  --shadow-sm: none;
  --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
  --shadow-float: 0 20px 25px -5px rgba(0, 0, 0, 0.5);

  --primary: #3b82f6;
  --primary-hover: #60a5fa;

  /* QC Panel Dark Mode */
  --qc-bg: #451a03;
  --qc-border: #d97706;
  --qc-text: #fcd34d;
}

body {
  background-color: var(--bg-body);
  color: var(--text-main);
  /* Use the Inter font, fallback to system sans */
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  margin: 0;
  padding-bottom: 80px;
  line-height: 1.6; /* Slightly more breathing room for text */
  -webkit-font-smoothing: antialiased; /* Makes text look sharper */
}

/* =========================================
   2. FLOATING ACTIONS
   ========================================= */
.floating-actions {
  position: fixed;
  bottom: 25px;
  left: 25px;
  z-index: 10000;
  display: flex;
  gap: 15px;
}

.float-btn {
  background: var(--bg-card);
  color: var(--text-main);
  border: 1px solid var(--border-color);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  font-size: 20px;
  cursor: pointer;
  box-shadow: var(--shadow-float);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.float-btn:hover {
  transform: translateY(-3px); /* Subtle lift effect */
  background-color: var(--bg-hover);
  border-color: var(--primary);
  color: var(--primary);
}

/* =========================================
   3. GLOBAL COMPONENTS
   ========================================= */
.btn { 
  padding: 10px 24px; 
  border: 1px solid transparent; 
  border-radius: 6px; 
  cursor: pointer; 
  color: white; 
  font-weight: 500; 
  text-decoration: none; 
  display: inline-flex; 
  align-items: center; 
  justify-content: center;
  font-size: 0.95rem;
  transition: all 0.2s ease;
  box-shadow: var(--shadow-sm);
}

.btn:active { transform: translateY(0); } /* Press down effect */

.btn-primary { background-color: var(--primary); }
.btn-primary:hover { background-color: var(--primary-hover); transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }

.btn-secondary { background-color: var(--bg-card); color: var(--text-main); border-color: var(--border-color); }
.btn-secondary:hover { background-color: var(--bg-hover); border-color: var(--text-muted); }

.btn-success { background-color: var(--success); }
.btn-success:hover { background-color: #047857; transform: translateY(-1px); }

.btn-danger { background-color: var(--danger); }
.btn-danger:hover { background-color: #b91c1c; transform: translateY(-1px); }

.btn-search { background: var(--primary); color: white; border: none; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; }
.btn-clear { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); padding: 8px 16px; border-radius: 6px; text-decoration: none; font-size: 0.9rem; }
.btn-clear:hover { background: var(--bg-hover); color: var(--text-main); }

/* =========================================
   4. DASHBOARD STYLES
   ========================================= */
.dashboard-container { max-width: 1280px; margin: 0 auto; padding: 40px 20px; }
.dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }

.dashboard-tabs { display: flex; gap: 8px; border-bottom: 1px solid var(--border-color); margin-bottom: 0; }
.tab-link {
  padding: 12px 24px; text-decoration: none; color: var(--text-muted);
  font-weight: 500; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.2s;
  font-size: 0.95rem;
}
.tab-link:hover { color: var(--primary); }
.tab-link.active { color: var(--primary); border-bottom-color: var(--primary); }

.filter-card {
  background: var(--bg-card); border: 1px solid var(--border-color);
  border-top: none; padding: 24px; border-radius: 0 0 12px 12px; margin-bottom: 40px;
  box-shadow: var(--shadow-sm);
}
.filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 24px; align-items: end; }
.filter-group { display: flex; flex-direction: column; }
.filter-group label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; color: var(--text-muted); }

.table-card {
  background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow-card);
  overflow: hidden; border: 1px solid var(--border-color);
}
.dashboard-table { width: 100%; border-collapse: collapse; }
.dashboard-table th {
  background-color: var(--bg-header); border-bottom: 1px solid var(--border-color);
  text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.08em;
  color: var(--text-muted); padding: 16px 24px; text-align: left; font-weight: 600;
}
.dashboard-table td { padding: 16px 24px; border-bottom: 1px solid var(--border-color); vertical-align: middle; font-size: 0.95rem; }
.dashboard-table tr:hover { background-color: var(--bg-hover); } /* Hover effect for rows */

/* Status Badges */
.status-badge { 
  padding: 4px 10px; border-radius: 6px; 
  font-size: 0.75rem; font-weight: 600; 
  display: inline-flex; align-items: center; 
  line-height: 1;
}
.status-creating { background: var(--status-creating-bg); color: var(--status-creating-text); border: 1px solid rgba(37,99,235,0.2); }
.status-qc_review { background: var(--status-pending-bg); color: var(--status-pending-text); border: 1px solid rgba(217,119,6,0.2); }
.status-revise { background: var(--status-revise-bg); color: var(--status-revise-text); border: 1px solid rgba(220,38,38,0.2); }
.status-authorization { background: var(--status-approved-bg); color: var(--status-approved-text); border: 1px solid rgba(5,150,105,0.2); }

/* =========================================
   5. FORM STYLES (Cleaned Up)
   ========================================= */
.form-card {
  background: var(--bg-card); border-radius: 12px; box-shadow: var(--shadow-card);
  padding: 2.5rem; margin-bottom: 2rem; border: 1px solid var(--border-color); 
  max-width: 1000px; margin-left: auto; margin-right: auto;
}
.form-card h2 {
  margin-top: 0; margin-bottom: 2rem; font-size: 1.25rem; font-weight: 600; color: var(--text-main);
  border-bottom: 1px solid var(--border-color); padding-bottom: 1rem;
}
.form-row { display: flex; flex-wrap: wrap; gap: 2rem; margin-bottom: 2rem; }
.form-group { flex: 1; display: flex; flex-direction: column; min-width: 240px; }
.full-width { flex-basis: 100%; }

.form-group label { 
  font-weight: 600; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-main); 
}
.form-group input, .form-group select, .form-group textarea {
  padding: 12px; border: 1px solid var(--border-color); border-radius: 8px;
  font-size: 1rem; background-color: var(--bg-input); color: var(--text-main);
  width: 100%; box-sizing: border-box; 
  transition: all 0.2s ease;
}
/* The "Glow" Focus Effect */
.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
  border-color: var(--border-focus); 
  outline: none; 
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); /* Soft Blue Ring */
}

.radio-group { display: flex; gap: 20px; align-items: center; margin-top: 5px; flex-wrap: wrap; }
.radio-group.vertical { flex-direction: column; align-items: flex-start; gap: 12px; }
.radio-label { 
  display: flex; align-items: center; gap: 10px; cursor: pointer; 
  font-weight: 500; padding: 8px 12px; border-radius: 6px; 
  border: 1px solid transparent; transition: all 0.2s; 
}
.radio-label:hover { background: var(--bg-hover); border-color: var(--border-color); }
.radio-label span { font-size: 0.95rem; }

/* Dynamic Fields */
.conditional-field {
  margin-top: 20px; padding: 20px; background-color: var(--bg-alert);
  border: 1px solid var(--border-alert); border-left-width: 4px; border-radius: 6px;
}
.conditional-field label { color: var(--danger); }

/* =========================================
   6. REPORT VIEW (Show Page)
   ========================================= */
.report-container { max-width: 900px; margin: 0 auto; padding: 40px 20px; }

.report-header {
  background: var(--bg-card);
  border-top: 4px solid var(--primary);
  box-shadow: var(--shadow-card);
  padding: 30px; margin-bottom: 30px; border-radius: 12px; border: 1px solid var(--border-color);
  border-top-width: 0;
}

.header-title {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 25px; border-bottom: 1px solid var(--border-color); padding-bottom: 25px;
}
.header-title h1 { margin: 0; font-size: 1.8rem; font-weight: 700; color: var(--text-main); }

.meta-data-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 30px; }
.meta-item label {
  display: block; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em;
  color: var(--text-muted); margin-bottom: 6px; font-weight: 700;
}
.meta-item .value { font-size: 1.1rem; font-weight: 500; color: var(--text-main); }

.report-section { 
  margin-bottom: 40px; background: var(--bg-card); padding: 30px; 
  border-radius: 12px; border: 1px solid var(--border-color); box-shadow: var(--shadow-card); 
}
.report-section h3 { 
  margin-top: 0; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); 
  font-size: 1.1rem; font-weight: 600; color: var(--text-main); margin-bottom: 20px; 
  text-transform: uppercase; letter-spacing: 0.05em;
}

.modern-table { width: 100%; border-collapse: collapse; }
.modern-table th { 
  text-align: left; background: var(--bg-header); padding: 12px 16px; 
  border-bottom: 1px solid var(--border-color); color: var(--text-muted); 
  font-size: 0.8rem; font-weight: 600; text-transform: uppercase; 
}
.modern-table td { padding: 12px 16px; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
.text-right { text-align: right; }
.text-center { text-align: center; }

/* QC Panel */
.action-bar-container { margin-bottom: 30px; }
.qc-panel {
  background-color: var(--qc-bg); border: 1px solid var(--qc-border);
  border-radius: 8px; padding: 25px; color: var(--qc-text);
  box-shadow: var(--shadow-sm);
}
.qc-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.qc-header-row h4 { margin: 0; font-size: 1.2rem; font-weight: 600; }
.qc-divider { height: 1px; background: var(--qc-border); margin: 20px 0; opacity: 0.4; }

.input-group { display: flex; gap: 12px; }
.revision-input { flex: 1; border-color: var(--qc-border); background: rgba(255,255,255,0.5); }

/* Attachments Grid */
.gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
.gallery-card {
  border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-card);
  overflow: hidden; text-align: center; padding-bottom: 12px; transition: all 0.2s ease;
}
.gallery-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-float); }
.thumbnail-area {
  height: 300px; background: var(--bg-hover); display: flex; align-items: center; justify-content: center;
  border-bottom: 1px solid var(--border-color); margin-bottom: 10px; overflow: hidden;
}
.thumbnail-area img { width: 100%; height: 100%; object-fit: cover; }
.doc-icon { font-size: 3.5rem; opacity: 0.6; color: var(--text-muted); }

/* Activity Feed */
.activity-feed { border-left: 2px solid var(--border-color); padding-left: 25px; margin-left: 10px; margin-top: 20px; }
.feed-item { position: relative; margin-bottom: 30px; }
.feed-item::before {
  content: ""; position: absolute; left: -32px; top: 4px; width: 12px; height: 12px;
  background: var(--bg-card); border: 3px solid var(--primary); border-radius: 50%;
}
.feed-user { font-size: 0.95rem; font-weight: 600; color: var(--text-main); margin-bottom: 2px; }
.feed-date { font-size: 0.8rem; color: var(--text-light); margin-bottom: 8px; }
.feed-note { 
  background: var(--bg-header); padding: 15px; border-radius: 8px; 
  font-size: 0.95rem; color: var(--text-main); border: 1px solid var(--border-color); 
}

/* =========================================
   7. UTILS & ERROR MESSAGES
   ========================================= */
.error-explanation {
  background-color: var(--bg-alert); padding: 20px; margin-bottom: 25px;
  border-radius: 8px; border: 1px solid var(--border-alert); color: var(--text-main);
}
.error-explanation h2 { color: var(--danger); font-size: 1.1rem; margin-top: 0; }
.alert { padding: 15px 20px; margin-bottom: 25px; border-radius: 8px; font-weight: 500; display: flex; align-items: center; gap: 10px; }
.alert-success { background-color: var(--status-approved-bg); color: var(--status-approved-text); border: 1px solid rgba(5,150,105,0.3); }
.alert-danger { background-color: var(--status-revise-bg); color: var(--status-revise-text); border: 1px solid rgba(220,38,38,0.3); }

/* =========================================
   8. NEW FEATURES (Weather, Modals, Checklists)
   ========================================= */

/* --- A. Weather Trio Grid --- */
.weather-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  margin-top: 15px;
}
@media (max-width: 768px) {
  .weather-grid { grid-template-columns: 1fr; }
}
.weather-col {
  background: var(--bg-header);
  padding: 20px;
  border-radius: 12px;
  border: 1px solid var(--border-color);
  text-align: center;
  transition: border-color 0.2s;
}
.weather-col:hover { border-color: var(--primary); }
.weather-col label {
  display: block; font-weight: 700; margin-bottom: 12px;
  color: var(--primary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em;
}

/* --- B. Nested Entry Card (Bid Items) --- */
.nested-entry-card {
  background-color: var(--bg-body);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  position: relative;
  transition: all 0.2s;
}
.nested-entry-card:hover {
  border-color: var(--border-focus);
  box-shadow: var(--shadow-sm);
}

/* --- C. Modal / Dialog Styles --- */
dialog {
  border: none;
  border-radius: 12px;
  box-shadow: var(--shadow-float);
  max-width: 600px;
  width: 90%;
  padding: 0;
  background: var(--bg-card);
  color: var(--text-main);
  animation: fadeIn 0.2s ease-out;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

dialog::backdrop {
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(4px);
}

.modal-header {
  padding: 20px 25px;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--bg-header);
}
.modal-header h3 { margin: 0; font-size: 1.15rem; font-weight: 600; color: var(--text-main); }

.modal-body { padding: 25px; max-height: 60vh; overflow-y: auto; }

.modal-footer {
  padding: 20px 25px;
  border-top: 1px solid var(--border-color);
  background-color: var(--bg-header);
  display: flex;
  justify-content: flex-end;
  gap: 15px;
}

/* Checklist Item Styling */
.checklist-item {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 0; border-bottom: 1px solid var(--border-color);
}
.checklist-item:last-child { border-bottom: none; }
.checklist-question { font-weight: 500; flex: 1; padding-right: 20px; font-size: 0.95rem; }
.checklist-radios { display: flex; gap: 20px; }

/* --- D. Utility Classes --- */
.w-full { width: 100%; }
.opacity-50 { opacity: 0.5; }
.cursor-not-allowed { cursor: not-allowed; }
.text-muted-sm { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }

/* MAESTRO ADDITION: Clean up inline flex styles */
.nested-row-container {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
  align-items: center;
}

.nested-row-container .remove-row-btn {
  color: var(--danger);
  background: none;
  border: none;
  cursor: pointer;
  margin-left: auto; /* Pushes delete button to the far right */
}

================================================================================
FILE: app/channels/application_cable/channel.rb
================================================================================
module ApplicationCable
  class Channel < ActionCable::Channel::Base
  end
end


================================================================================
FILE: app/channels/application_cable/connection.rb
================================================================================
module ApplicationCable
  class Connection < ActionCable::Connection::Base
  end
end


================================================================================
FILE: app/controllers/application_controller.rb
================================================================================
class ApplicationController < ActionController::Base
before_action :authenticate_user!
end


================================================================================
FILE: app/controllers/bid_items_controller.rb
================================================================================
class BidItemsController < ApplicationController
  before_action :set_project
  before_action :set_bid_item, only: %i[ show edit update destroy ]

  # GET /projects/1/bid_items
  def index
    # Only show items for THIS project
    @bid_items = @project.bid_items.order(:code)
  end

  # GET /projects/1/bid_items/new
  def new
    @bid_item = @project.bid_items.build
  end

  # POST /projects/1/bid_items
  def create
    @bid_item = @project.bid_items.build(bid_item_params)

    if @bid_item.save
      redirect_to project_bid_items_path(@project), notice: "Bid item added to library."
    else
      render :new, status: :unprocessable_entity
    end
  end

  # GET /projects/1/bid_items/1/edit
  def edit
  end

  # PATCH /projects/1/bid_items/1
  def update
    if @bid_item.update(bid_item_params)
      redirect_to project_bid_items_path(@project), notice: "Bid item updated."
    else
      render :edit, status: :unprocessable_entity
    end
  end

  def destroy
    @bid_item.destroy
    redirect_to project_bid_items_path(@project), notice: "Bid item removed."
  end

  private
    def set_project
      @project = Project.find(params[:project_id])
    end

    def set_bid_item
      @bid_item = @project.bid_items.find(params[:id])
    end

    def bid_item_params
      # We now require the spec_item_id as well
      params.require(:bid_item).permit(:code, :description, :unit, :spec_item_id, :questions_text)
    end
end

================================================================================
FILE: app/controllers/checklist_entries_controller.rb
================================================================================
class ChecklistEntriesController < ApplicationController
  skip_before_action :verify_authenticity_token # (Optional: purely for ease of JS fetch, better to use headers if possible)

  def create
    @report = Report.find(params[:report_id])
    @spec = SpecItem.find(params[:spec_item_id])
    
    # Find existing entry or start a new one
    @entry = @report.checklist_entries.find_or_initialize_by(spec_item: @spec)
    
    # Save the answers (passed as a JSON object)
    @entry.checklist_answers = params[:answers].permit!.to_h
    
    if @entry.save
      render json: { 
        status: "success", 
        id: @entry.id,
        spec_code: @spec.code,
        spec_desc: @spec.description
      }
    else
      render json: { status: "error", message: @entry.errors.full_messages.join(", ") }, status: 422
    end
  end
end

================================================================================
FILE: app/controllers/phases_controller.rb
================================================================================
class PhasesController < ApplicationController
  before_action :set_phase, only: %i[ show edit update destroy ]

  # GET /phases or /phases.json
  def index
    @phases = Phase.all
  end

  # GET /phases/1 or /phases/1.json
  def show
  end

  # GET /phases/new
  def new
    @phase = Phase.new
  end

  # GET /phases/1/edit
  def edit
  end

  # POST /phases or /phases.json
  def create
    @phase = Phase.new(phase_params)

    respond_to do |format|
      if @phase.save
        format.html { redirect_to @phase, notice: "Phase was successfully created." }
        format.json { render :show, status: :created, location: @phase }
      else
        format.html { render :new, status: :unprocessable_entity }
        format.json { render json: @phase.errors, status: :unprocessable_entity }
      end
    end
  end

  # PATCH/PUT /phases/1 or /phases/1.json
  def update
    respond_to do |format|
      if @phase.update(phase_params)
        format.html { redirect_to @phase, notice: "Phase was successfully updated.", status: :see_other }
        format.json { render :show, status: :ok, location: @phase }
      else
        format.html { render :edit, status: :unprocessable_entity }
        format.json { render json: @phase.errors, status: :unprocessable_entity }
      end
    end
  end

  # DELETE /phases/1 or /phases/1.json
  def destroy
    @phase.destroy!

    respond_to do |format|
      format.html { redirect_to phases_path, notice: "Phase was successfully destroyed.", status: :see_other }
      format.json { head :no_content }
    end
  end

  private
    # Use callbacks to share common setup or constraints between actions.
    def set_phase
      @phase = Phase.find(params[:id])
    end

    # Only allow a list of trusted parameters through.
    def phase_params
      params.require(:phase).permit(:name)
    end
end


================================================================================
FILE: app/controllers/placed_quantities_controller.rb
================================================================================
class PlacedQuantitiesController < ApplicationController
  before_action :set_placed_quantity, only: %i[ show edit update destroy ]

  # GET /placed_quantities or /placed_quantities.json
  def index
    @placed_quantities = PlacedQuantity.all
  end

  # GET /placed_quantities/1 or /placed_quantities/1.json
  def show
  end

  # GET /placed_quantities/new
  def new
    @placed_quantity = PlacedQuantity.new
  end

  # GET /placed_quantities/1/edit
  def edit
  end

  # POST /placed_quantities or /placed_quantities.json
  def create
    @placed_quantity = PlacedQuantity.new(placed_quantity_params)

    respond_to do |format|
      if @placed_quantity.save
        format.html { redirect_to @placed_quantity, notice: "Inspection entry was successfully created." }
        format.json { render :show, status: :created, location: @placed_quantity }
      else
        format.html { render :new, status: :unprocessable_entity }
        format.json { render json: @placed_quantity.errors, status: :unprocessable_entity }
      end
    end
  end

  # PATCH/PUT /placed_quantities/1 or /placed_quantities/1.json
  def update
    respond_to do |format|
      if @placed_quantity.update(placed_quantity_params)
        format.html { redirect_to @placed_quantity, notice: "Inspection entry was successfully updated.", status: :see_other }
        format.json { render :show, status: :ok, location: @placed_quantity }
      else
        format.html { render :edit, status: :unprocessable_entity }
        format.json { render json: @placed_quantity.errors, status: :unprocessable_entity }
      end
    end
  end

  # DELETE /placed_quantities/1 or /placed_quantities/1.json
  def destroy
    @placed_quantity.destroy!
    respond_to do |format|
      format.html { redirect_to placed_quantities_path, notice: "Inspection entry was successfully destroyed.", status: :see_other }
      format.json { head :no_content }
    end
  end

  private
    # Use callbacks to share common setup or constraints between actions.
    def set_placed_quantity
      @placed_quantity = PlacedQuantity.find(params[:id])
    end

    # Only allow a list of trusted parameters through.
    def placed_quantity_params
      params.require(:placed_quantity).permit(:report_id, :bid_item_id, :quantity, :location, :notes)
    end
end

================================================================================
FILE: app/controllers/projects_controller.rb
================================================================================
class ProjectsController < ApplicationController
  before_action :set_project, only: %i[ show edit update destroy ]

  # GET /projects or /projects.json
  def index
    @projects = Project.all
  end

  # GET /projects/1 or /projects/1.json
  def show
  end

  # GET /projects/new
  def new
    @project = Project.new
  end

  # GET /projects/1/edit
  def edit
  end

  # POST /projects or /projects.json
  def create
    @project = Project.new(project_params)

    respond_to do |format|
      if @project.save
        format.html { redirect_to @project, notice: "Project was successfully created." }
        format.json { render :show, status: :created, location: @project }
      else
        format.html { render :new, status: :unprocessable_entity }
        format.json { render json: @project.errors, status: :unprocessable_entity }
      end
    end
  end

  # PATCH/PUT /projects/1 or /projects/1.json
  def update
    respond_to do |format|
      if @project.update(project_params)
        format.html { redirect_to @project, notice: "Project was successfully updated.", status: :see_other }
        format.json { render :show, status: :ok, location: @project }
      else
        format.html { render :edit, status: :unprocessable_entity }
        format.json { render json: @project.errors, status: :unprocessable_entity }
      end
    end
  end

  # DELETE /projects/1 or /projects/1.json
  def destroy
    @project.destroy!

    respond_to do |format|
      format.html { redirect_to projects_path, notice: "Project was successfully destroyed.", status: :see_other }
      format.json { head :no_content }
    end
  end

  private
    # Use callbacks to share common setup or constraints between actions.
    def set_project
      @project = Project.find(params[:id])
    end

    # Only allow a list of trusted parameters through.
    def project_params
      params.require(:project).permit(:name)
    end
end


================================================================================
FILE: app/controllers/reports_controller.rb
================================================================================
require 'csv'
require 'docx'
require 'tempfile'

class ReportsController < ApplicationController
  before_action :authenticate_user!
  before_action :set_report, only: %i[ show edit update destroy submit_for_qc approve request_revision export_word ]

  # GET /reports
  def index
    # 1. DEFAULT: Set the default status to match your View's default tab
    params[:status] ||= 'creating'

    # 2. SCOPE: Determine base collection (Security/Workflow logic)
    # Inspectors should only see their own reports in 'creating' or 'revise' stages.
    # For all other stages (QC, Authorization), we show the global list.
    @reports = if ['creating', 'revise'].include?(params[:status])
                  current_user.reports 
                else
                  Report.all
                end

    # 3. FILTER: Actually apply the status filter
    @reports = @reports.where(status: params[:status]) unless params[:status] == 'all'

    # 4. SEARCH: Apply the remaining filters (Date, Project, Inspector)
    apply_search_filters

    respond_to do |format|
      format.html
      format.csv { send_data generate_csv(@reports), filename: "Project_Master_Log_#{Date.today}.csv" }
    end
  end

  # GET /reports/1
  def show
  end

  # GET /reports/new
  def new
    # --- MAESTRO: DRAFT PATTERN IMPLEMENTATION ---
    # 1. Initialize with defaults
    @report = current_user.reports.build(status: :creating)
    
    # 2. Pre-fill Project if passed from Dashboard
    if params[:project_id].present?
      project = Project.find_by(id: params[:project_id])
      @report.project = project if project
    end

    # 3. Save Shell Record (validate: false)
    if @report.save(validate: false)
      redirect_to edit_report_path(@report)
    else
      redirect_to reports_path, alert: "Could not initialize new report."
    end
  end

  # GET /reports/1/edit
  def edit
    # MAESTRO: Auto-build empty rows so the form isn't empty
    @report.placed_quantities.build if @report.placed_quantities.empty?
    @report.equipment_entries.build if @report.equipment_entries.empty?
    
    # MAESTRO: Auto-spawn crew entry so it appears by default
    @report.crew_entries.build if @report.crew_entries.empty?
  end

  # POST /reports
  def create
    @report = current_user.reports.build(report_params)
    @report.status ||= :creating

    if @report.save
      redirect_to report_url(@report), notice: "Report was successfully created."
    else
      render :new, status: :unprocessable_entity
    end
  end

  # PATCH/PUT /reports/1
  def update
    if @report.update(report_params)
      redirect_to report_url(@report), notice: "Report was successfully updated."
    else
      render :edit, status: :unprocessable_entity
    end
  end

  # DELETE /reports/1
  def destroy
    @report.destroy!
    redirect_to reports_url, notice: "Report was successfully destroyed."
  end

  # --- Workflow Actions ---

  def submit_for_qc
    @report.update(status: :qc_review)
    redirect_to reports_path, notice: "Report submitted to QC."
  end

  def approve
    @report.update(status: :authorization, result: :pass)
    redirect_to @report, notice: "Report approved and authorized."
  end

  def request_revision
    @report.update(status: :revise, result: :fail)
    @report.activity_logs.create(user: current_user, note: params[:note])
    redirect_to @report, alert: "Report returned for revision."
  end

  # --- EXPORT TO WORD ACTION ---
  def export_word
    # 1. Delegate the work to your Service Class
    temp_file = WordReportExporter.generate(@report)

    if temp_file
      begin
        # 2. Read the binary data from the temp file path
        file_data = File.binread(temp_file.path)
        
        # 3. Send the data to the browser
        send_data file_data, 
                  filename: "DIR_#{@report.dir_number}_#{@report.start_date}.docx",
                  type: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                  disposition: 'attachment'
      ensure
        # 4. Clean up the temp file
        temp_file.close
        temp_file.unlink
      end
    else
      # Fallback if the template is missing
      redirect_to @report, alert: "Could not generate report. Template missing."
    end
  end

  private

    def set_report
      @report = Report.find(params[:id])
    end

    def apply_search_filters
      @reports = @reports.filter_by_inspector(params[:inspector]) if params[:inspector].present?
      @reports = @reports.filter_by_project(params[:project_id]) if params[:project_id].present?
      @reports = @reports.filter_by_bid_item(params[:bid_item_id]) if params[:bid_item_id].present?

      # Updated Precip Filter
      if params[:precip_min].present?
         max = params[:precip_max].presence || 100 
         @reports = @reports.filter_by_precip_range(params[:precip_min], max)
      end

      # Date Range Filter
      if params[:start_date].present?
        end_date = params[:end_date].presence || params[:start_date]
        @reports = @reports.filter_by_date_range(params[:start_date], end_date) 
      end

      if params[:result].present?
        @reports = params[:result] == 'pending' ? @reports.where(result: [nil, '']) : @reports.where(result: params[:result])
      end
    end

    def generate_csv(reports)
      CSV.generate(headers: true) do |csv|
        csv << [
          "DIR #", "Start Date", "End Date", "Inspector", "Project", "Phase", "Status", 
          "Shift", "Temps (1/2/3)", "Winds (1/2/3)", "Contractor",
          "Item Code", "Item Description", "Quantity", "Unit", "Location", "Notes"
        ]
        
        reports.each do |report|
          inspector_name = report.user&.email || "Unknown"
          
          # Combine weather for CSV readability
          temps = [report.temp_1, report.temp_2, report.temp_3].compact.join("/")
          winds = [report.wind_1, report.wind_2, report.wind_3].compact.join("/")

          if report.placed_quantities.empty?
            csv << [
              report.dir_number, report.start_date, report.end_date, inspector_name, report.project&.name, report.phase&.name, report.status&.humanize,
              "#{report.shift_start}-#{report.shift_end}", temps, winds, report.contractor,
              "---", "No Activity", 0, "---", "---", report.commentary
            ]
          else
            report.placed_quantities.each do |entry|
              csv << [
                report.dir_number, report.start_date, report.end_date, inspector_name, report.project&.name, report.phase&.name, report.status&.humanize,
                "#{report.shift_start}-#{report.shift_end}", temps, winds, report.contractor,
                entry.bid_item&.code, entry.bid_item&.description, entry.quantity, entry.bid_item&.unit, entry.location, entry.notes
              ]
            end
          end
        end
      end
    end

    def report_params
      params.require(:report).permit(
        # --- 1. GENERAL INFO ---
        :start_date, :end_date,
        :dir_number, :project_id, :phase_id, 
        :status, :result,
        :shift_start, :shift_end,
        :contractor, 

        # --- 2. WEATHER & CONDITIONS ---
        :temp_1, :temp_2, :temp_3,
        :wind_1, :wind_2, :wind_3,
        :precip_1, :precip_2, :precip_3,
        :weather_summary_1, :weather_summary_2, :weather_summary_3,
        :weather, :temperature,
        
        # MAESTRO: New Weather Fields
        :visibility_1, :visibility_2, :visibility_3,
        :surface_conditions,

        :station_start, :station_end, :plan_sheet, :relevant_docs,
        
        # --- 3. COMPLIANCE & SAFETY ---
        :deficiency_status, :deficiency_desc,
        :safety_incident, :safety_desc,
        :commentary,
        
        # MAESTRO: Compliance Fields with Notes
        :traffic_control, :traffic_control_note,
        :environmental, :environmental_note,
        :security, :security_note,
        :air_ops_coordination, :air_ops_note,
        :swppp_controls, :swppp_note,
        :phasing_compliance, :phasing_compliance_note,

        # --- 4. TEXT AREAS ---
        :additional_activities, :additional_info,
        
        # --- 5. ATTACHMENTS ---
        report_attachments_attributes: [:id, :caption, :file, :_destroy],

        # --- 6. NESTED TABLES ---
        crew_entries_attributes: [
          :id, :contractor, :superintendent, :foreman, 
          :survey_count, :operator_count, :laborer_count, :electrician_count, 
          :notes, :_destroy
        ],
        equipment_entries_attributes: [
          :id, :make_model, :hours, :quantity, :contractor, :_destroy
        ],
        placed_quantities_attributes: [
          :id, :bid_item_id, :quantity, :notes, :_destroy, 
          :checklist_answers 
        ],
        checklist_entries_attributes: [:id, :spec_item_id, :_destroy, checklist_answers: {}],

        qa_entries_attributes: [
          :id, :qa_type, :location, :result, :note, :_destroy
        ]
      )
    end
end

================================================================================
FILE: app/helpers/application_helper.rb
================================================================================
module ApplicationHelper
end


================================================================================
FILE: app/helpers/bid_items_helper.rb
================================================================================
module BidItemsHelper
end


================================================================================
FILE: app/helpers/phases_helper.rb
================================================================================
module PhasesHelper
end


================================================================================
FILE: app/helpers/placed_quantities_helper.rb
================================================================================
module PlacedQuantitiesHelper
end

================================================================================
FILE: app/helpers/projects_helper.rb
================================================================================
module ProjectsHelper
end


================================================================================
FILE: app/helpers/reports_helper.rb
================================================================================
module ReportsHelper
end


================================================================================
FILE: app/javascript/application.js
================================================================================
// Configure your import map in config/importmap.rb. Read more: https://github.com/rails/importmap-rails
import "@hotwired/turbo-rails"
import "controllers"

// CHANGED: We use 'turbo:load' instead of 'DOMContentLoaded'
document.addEventListener("turbo:load", function() {
  
  // --- Detective Toggle Logic ---
  const detectiveToggleBtn = document.getElementById("detective-toggle-btn");
  const detectiveWindow = document.getElementById("detective-window");

  // We check if elements exist to avoid errors on pages where they might be missing
  if (detectiveToggleBtn && detectiveWindow) {
    // Remove existing listeners if any (clean up to be safe, though Turbo usually handles fresh elements)
    // Actually, since the element is fresh from the DOM swap, we can just add the listener.
    detectiveToggleBtn.addEventListener("click", function() {
      detectiveWindow.classList.toggle("detective-hidden");
    });
  }

  // --- Dark Mode Logic ---
  const themeBtn = document.getElementById("theme-toggle-btn");
  const htmlDoc = document.documentElement;

  if (themeBtn) {
    themeBtn.addEventListener("click", function() {
      const currentTheme = htmlDoc.getAttribute("data-theme");
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      
      htmlDoc.setAttribute("data-theme", newTheme);
      localStorage.setItem("theme", newTheme);
    });
  }
});

================================================================================
FILE: app/javascript/controllers/application.js
================================================================================
import { Application } from "@hotwired/stimulus"

const application = Application.start()

// Configure Stimulus development experience
application.debug = false
window.Stimulus   = application

export { application }


================================================================================
FILE: app/javascript/controllers/hello_controller.js
================================================================================
import { Controller } from "@hotwired/stimulus"

export default class extends Controller {
  connect() {
    this.element.textContent = "Hello World!"
  }
}


================================================================================
FILE: app/javascript/controllers/index.js
================================================================================
// Import and register all your controllers from the importmap via controllers/**/*_controller
import { application } from "controllers/application"
import { eagerLoadControllersFrom } from "@hotwired/stimulus-loading"
eagerLoadControllersFrom("controllers", application)


================================================================================
FILE: app/javascript/controllers/report_form_controller.js
================================================================================
import { Controller } from "@hotwired/stimulus"

export default class extends Controller {
  static targets = ["checklistModal", "questionsContainer", "template", "targetContainer"]

  connect() {
    console.log("ðŸ‘® Maestro: ReportForm Controller Connected");
    this.initializeToggles();
  }

  // =========================================================================
  //  SECTION 1: TOGGLE LOGIC (Deficiencies, Safety, Additional Info)
  // =========================================================================
  
  // Triggered by data-action="change->report-form#toggleSection"
  toggleSection(event) {
    const trigger = event.target;
    const targetId = trigger.dataset.targetId;
    const validValues = JSON.parse(trigger.dataset.validValues || "[]");
    const targetElement = document.getElementById(targetId);

    if (!targetElement) return;

    // Logic: If checkbox, follow checked state. If radio, match value to validValues.
    let shouldShow = false;
    if (trigger.type === "checkbox") {
      shouldShow = trigger.checked;
    } else {
      shouldShow = validValues.includes(trigger.value);
    }

    targetElement.style.display = shouldShow ? "block" : "none";
  }

  // Run on load to set initial state based on existing DB values
  initializeToggles() {
    // We manually trigger the change event logic for any active inputs
    this.element.querySelectorAll('[data-action~="report-form#toggleSection"]').forEach(input => {
      if (input.type === "checkbox" && input.checked) {
        this.toggleSection({ target: input });
      } else if (input.type === "radio" && input.checked) {
        this.toggleSection({ target: input });
      }
    });
  }

  // =========================================================================
  //  SECTION 2: DYNAMIC ROWS (Crew, Equipment, QA, Inspection)
  // =========================================================================

  // Triggered by data-action="click->report-form#addAssociation"
  addAssociation(event) {
    event.preventDefault();
    
    // Get parameters from the button's dataset
    const templateId = event.target.dataset.templateId;
    const containerId = event.target.dataset.containerId;
    
    const template = document.getElementById(templateId);
    const container = document.getElementById(containerId);

    if (!template || !container) {
      console.error("Maestro Error: Missing template or container", { templateId, containerId });
      return;
    }

    // Clone and Timestamp
    const content = template.content.cloneNode(true);
    const uniqueId = new Date().getTime();

    content.querySelectorAll("input, select, textarea").forEach((el) => {
      el.name = el.name.replace("NEW_RECORD", uniqueId);
      // Clean up ID attributes to avoid duplicates
      if (el.id) el.id = el.id.replace("NEW_RECORD", uniqueId);
    });

    container.appendChild(content);

    // Auto-populate contractor if applicable
    if (event.target.dataset.populateContractor === "true") {
      this.syncContractorForNewRow(container.lastElementChild);
    }
  }

  // Triggered by data-action="click->report-form#removeAssociation"
  removeAssociation(event) {
    event.preventDefault();
    const row = event.target.closest(".nested-fields");
    
    // If it's a saved record, we need to find the _destroy hidden field
    const destroyInput = row.querySelector("input[name*='_destroy']");
    
    if (destroyInput) {
      destroyInput.value = "1";
      row.style.display = "none";
    } else {
      // If it's a new record (not saved yet), just remove from DOM
      row.remove();
    }
  }

  // =========================================================================
  //  SECTION 3: AUTO-POPULATION
  // =========================================================================

  syncContractorForNewRow(rowElement) {
    const mainContractor = document.getElementById("main-contractor-input");
    if (!mainContractor || !mainContractor.value) return;

    const rowInput = rowElement.querySelector(".auto-contractor");
    if (rowInput) {
      rowInput.value = mainContractor.value;
    }
  }

  // =========================================================================
  //  SECTION 4: WEATHER API
  // =========================================================================

  fetchWeather(event) {
    event.preventDefault();
    const btn = event.target;
    const suffix = btn.dataset.suffix; // 1, 2, or 3
    const originalText = btn.innerText;

    if (!navigator.geolocation) {
      alert("Geolocation is not supported by this browser.");
      return;
    }

    btn.innerText = "Locating...";
    btn.disabled = true;

    navigator.geolocation.getCurrentPosition(
      (position) => {
        this.performWeatherFetch(position, btn, suffix, originalText);
      },
      (error) => {
        console.error(error);
        alert("Unable to retrieve location.");
        btn.innerText = originalText;
        btn.disabled = false;
      }
    );
  }

  performWeatherFetch(position, btn, suffix, originalText) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    btn.innerText = "Fetching...";

    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,precipitation,weather_code,wind_speed_10m,wind_direction_10m&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        const current = data.current;
        
        // Helper to find inputs safely
        const setVal = (namePart, value) => {
          const input = this.element.querySelector(`[name="report[${namePart}_${suffix}]"]`);
          if (input) input.value = value;
        };

        setVal("temp", Math.round(current.temperature_2m));
        setVal("precip", current.precipitation);
        setVal("weather_summary", this.decodeWeatherCode(current.weather_code));
        
        const windDir = this.getCardinalDirection(current.wind_direction_10m);
        setVal("wind", `${Math.round(current.wind_speed_10m)} mph ${windDir}`);

        btn.innerText = "âœ“ Updated";
        setTimeout(() => {
          btn.innerText = originalText;
          btn.disabled = false;
        }, 2000);
      })
      .catch(err => {
        console.error(err);
        btn.innerText = "Error";
        setTimeout(() => { btn.innerText = originalText; btn.disabled = false; }, 2000);
      });
  }

  getCardinalDirection(angle) {
    const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
    return directions[Math.round(angle / 45) % 8];
  }

  decodeWeatherCode(code) {
    const codes = { 0: "Clear", 1: "Mainly Clear", 2: "Partly Cloudy", 3: "Overcast", 45: "Fog", 61: "Rain", 71: "Snow", 95: "Thunderstorm" };
    return codes[code] || "Unknown";
  }
  
  // ... (Keep your existing Checklist logic here: selectBidItem, openChecklist, etc.) ...
  // [cite: 168-193]
}

================================================================================
FILE: app/javascript/controllers/spec_drilldown_controller.js
================================================================================
import { Controller } from "@hotwired/stimulus"

export default class extends Controller {
  static targets = ["modal", "viewDivisions", "viewSpecs", "viewForm", "specListContainer", "modalTitle", "checklistFormPlaceholder"]
  // NEW: Robustly capture the ID passed from the view
  static values = { reportId: String }

  connect() {
    // Parse the big JSON blob of specs once
    const dataScript = document.getElementById("spec-data-store");
    if (dataScript) {
      this.allSpecs = JSON.parse(dataScript.textContent);
    }
    this.currentSpec = null;
  }

  // --- NAVIGATION ---
  openModal() {
    this.modalTarget.showModal();
    this.showDivisions();
  }

  closeModal() {
    this.modalTarget.close();
  }

  showDivisions() {
    this.viewDivisionsTarget.style.display = "block";
    this.viewSpecsTarget.style.display = "none";
    this.viewFormTarget.style.display = "none";
    this.modalTitleTarget.innerText = "Select Division";
  }
  
  showSpecs() {
    this.viewSpecsTarget.style.display = "block";
    this.viewFormTarget.style.display = "none";
  }

  selectDivision(event) {
    const divisionName = event.currentTarget.dataset.division;
    
    // Filter specs by division
    const specs = this.allSpecs.filter(s => s.division === divisionName);

    // Render list
    let html = "";
    specs.forEach(spec => {
      html += `
        <button type="button" class="list-item" 
                style="width:100%; text-align:left; padding:12px; margin-bottom:8px; background:white; border:1px solid #ddd; border-radius:6px; cursor:pointer;"
                data-action="click->spec-drilldown#selectSpec" 
                data-id="${spec.id}">
          <strong style="color:#2563eb;">${spec.code}</strong><br>
          <span style="font-size:0.9em; color:#666;">${spec.description}</span>
        </button>
      `;
    });
    this.specListContainerTarget.innerHTML = html;
    
    // Switch Views
    this.viewDivisionsTarget.style.display = "none";
    this.viewSpecsTarget.style.display = "block";
    this.modalTitleTarget.innerText = divisionName;
  }

  selectSpec(event) {
    const specId = parseInt(event.currentTarget.dataset.id);
    this.currentSpec = this.allSpecs.find(s => s.id === specId);
    
    // Pass empty object {} for new checklists
    this.renderChecklistForm(this.currentSpec.checklist_questions, {});
    
    this.viewSpecsTarget.style.display = "none";
    this.viewFormTarget.style.display = "block";
    this.modalTitleTarget.innerText = `Checklist: ${this.currentSpec.code}`;
  }

  // Handle clicking the "Edit" button on an existing card
  editSpec(event) {
    const card = event.target.closest(".gallery-card");
    const specId = parseInt(card.dataset.specId);
    const savedAnswers = JSON.parse(card.dataset.answers || "{}");

    // Find the full spec object from our data store
    this.currentSpec = this.allSpecs.find(s => s.id === specId);

    // Open the modal directly to the form, passing the saved answers
    this.modalTarget.showModal();
    this.renderChecklistForm(this.currentSpec.checklist_questions, savedAnswers);
    
    this.viewDivisionsTarget.style.display = "none";
    this.viewSpecsTarget.style.display = "none";
    this.viewFormTarget.style.display = "block";
    this.modalTitleTarget.innerText = `Edit: ${this.currentSpec.code}`;
  }

  // --- FORM RENDERING ---
  renderChecklistForm(questions, savedAnswers = {}) {
    let html = `<div style="padding: 10px;">`;
    html += `<p style="margin-bottom: 20px;"><strong>${questions.length} items to check:</strong></p>`;
    
    questions.forEach((q) => {
      const isChecked = (val) => savedAnswers[q] === val ? "checked" : "";
      
      // Sanitized key for the name attribute
      const safeKey = q.replace(/"/g, '&quot;');

      html += `
        <div class="checklist-item" style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
          <p style="margin: 0 0 5px 0;">${q}</p>
          <div style="display: flex; gap: 15px;">
            <label><input type="radio" name="answers[${safeKey}]" value="Yes" ${isChecked("Yes")}> Yes</label>
            <label><input type="radio" name="answers[${safeKey}]" value="No" ${isChecked("No")}> No</label>
            <label><input type="radio" name="answers[${safeKey}]" value="N/A" ${isChecked("N/A")}> N/A</label>
          </div>
        </div>
      `;
    });

    html += `
      <div style="margin-top: 20px; text-align: right;">
        <button type="button" class="btn-primary-action" data-action="click->spec-drilldown#saveChecklist">Save Checklist</button>
      </div>
    `;
    html += `</div>`;
    
    this.checklistFormPlaceholderTarget.innerHTML = html;
  }
  
  saveChecklist(event) {
    const btn = event.target;
    btn.disabled = true;
    btn.innerText = "Saving...";

    // 1. Harvest Answers
    const answers = {};
    const radios = this.checklistFormPlaceholderTarget.querySelectorAll('input[type="radio"]:checked');
    
    radios.forEach(radio => {
      // Extract the original question key from the name attribute
      const keyMatch = radio.name.match(/answers\[(.*?)\]/);
      if (keyMatch) {
        // We decode HTML entities if necessary, but usually the raw string works here
        answers[keyMatch[1]] = radio.value;
      }
    });

    // 2. Identify Context (ROBUST FIX)
    if (!this.reportIdValue) {
       alert("Error: Missing Report ID. Cannot save.");
       return;
    }
    
    // 3. Send to Server
    fetch(`/reports/${this.reportIdValue}/checklist_entries`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({
        spec_item_id: this.currentSpec.id,
        answers: answers
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === "success") {
        this.addBadgeToUI(data, answers); 
        this.closeModal();
      } else {
        alert("Error saving: " + data.message);
        btn.disabled = false;
        btn.innerText = "Save Checklist";
      }
    })
    .catch(error => {
      console.error(error);
      alert("Network Error");
      btn.disabled = false;
    });
  }

  addBadgeToUI(data, newAnswers) {
    const list = document.getElementById("active-checklists-list");
    
    // Remove "No checklists" message
    const emptyMsg = list.querySelector(".text-muted");
    if (emptyMsg) emptyMsg.remove();

    // Check if badge already exists (update scenario)
    let card = list.querySelector(`[data-spec-code="${data.spec_code}"]`);
    
    if (card) {
      // Update existing card
      card.dataset.answers = JSON.stringify(newAnswers);
      card.style.backgroundColor = "#ecfdf5"; // Flash Green
      setTimeout(() => card.style.backgroundColor = "", 1000);
    } else {
      // Create new card
      const html = `
        <div class="gallery-card" 
             style="padding: 15px; text-align: left;"
             data-spec-code="${data.spec_code}"
             data-spec-id="${data.id}" 
             data-answers='${JSON.stringify(newAnswers)}'>
             
          <div style="font-weight: bold; color: var(--primary); margin-bottom: 5px;">${data.spec_code}</div>
          <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; height: 40px; overflow: hidden;">${data.spec_desc}</div>
          
          <button type="button" 
                  class="btn-secondary" 
                  style="width: 100%; font-size: 0.8rem;"
                  data-action="click->spec-drilldown#editSpec">
             âœŽ Edit Checklist
          </button>
        </div>
      `;
      // Ensure grid class exists
      if (!list.classList.contains("gallery-grid")) list.classList.add("gallery-grid");
      list.insertAdjacentHTML("beforeend", html);
    }
  }
}

================================================================================
FILE: app/javascript/controllers/ui_controller.js
================================================================================
import { Controller } from "@hotwired/stimulus"

export default class extends Controller {
  static targets = [ "detective" ]

  connect() {
    console.log("ðŸž UI Controller Connected")
    this.restoreTheme()
  }

  // --- DARK MODE LOGIC ---
  toggleTheme() {
    // 1. Check the BODY class (Source of Truth)
    const isDark = document.body.classList.contains('dark-mode')
    
    // 2. Determine the NEW state (If dark, make light. If light, make dark)
    const newTheme = isDark ? 'light' : 'dark'

    console.log(`ðŸŒ— Toggling Theme: Was ${isDark ? 'Dark' : 'Light'} -> Becoming ${newTheme}`)
    
    // 3. Force Apply
    this.applyTheme(newTheme)
    localStorage.setItem('theme', newTheme)
  }

  restoreTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light'
    console.log(`ðŸ“‚ Restoring Theme: ${savedTheme}`)
    this.applyTheme(savedTheme)
  }

  applyTheme(theme) {
    // Force the HTML attribute to match
    document.documentElement.setAttribute('data-theme', theme)
    
    // Force the Body class to match
    if (theme === 'dark') {
      document.body.classList.add('dark-mode')
    } else {
      document.body.classList.remove('dark-mode')
    }
  }

  // --- DETECTIVE LOGIC ---
  toggleDetective() {
    this.detectiveTarget.classList.toggle("detective-hidden")
  }
}

================================================================================
FILE: app/jobs/application_job.rb
================================================================================
class ApplicationJob < ActiveJob::Base
  # Automatically retry jobs that encountered a deadlock
  # retry_on ActiveRecord::Deadlocked

  # Most jobs are safe to ignore if the underlying records are no longer available
  # discard_on ActiveJob::DeserializationError
end


================================================================================
FILE: app/mailers/application_mailer.rb
================================================================================
class ApplicationMailer < ActionMailer::Base
  default from: "from@example.com"
  layout "mailer"
end


================================================================================
FILE: app/models/application_record.rb
================================================================================
class ApplicationRecord < ActiveRecord::Base
  primary_abstract_class
end


================================================================================
FILE: app/models/bid_item.rb
================================================================================
class BidItem < ApplicationRecord
  # --- 1. ASSOCIATIONS ---
  # The Bid Item belongs to the "Container" (Project) 
  # and acts as a translator for the "Definition" (Spec Item)
  belongs_to :project
  belongs_to :spec_item 
  
  has_many :placed_quantities, dependent: :restrict_with_error
  
  # --- 2. VALIDATIONS ---
  validates :code, presence: true
  
  # MAESTRO: This ensures a code (e.g. "P-401") is unique ONLY within this specific project.
  # This allows Project A and Project B to both have an item called "P-401".
  validates :code, uniqueness: { scope: :project_id, message: "already exists in this project" }
  
  validate :checklist_questions_must_be_array

  # --- 3. THE "TRAFFIC COP" (Smart Logic) ---
  # This determines which questions appear in the form
  def active_questions
    # A. If Bid Item has specific overrides, use them
    return checklist_questions if checklist_questions.present? && checklist_questions.any?
    
    # B. Otherwise, fallback to the Spec's questions
    return spec_item.checklist_questions if spec_item&.checklist_questions.present?
    
    # C. Default to empty
    []
  end

  # --- 4. VIRTUAL ATTRIBUTES (For the Form) ---
  # GETTER: Returns text for the textarea
  def questions_text
    active_questions.join("\n")
  end

  # SETTER: Saves text as array (Only saves to BidItem override)
  def questions_text=(text)
    self.checklist_questions = text.to_s.split("\n").map(&:strip).reject(&:blank?)
  end

  private

  def checklist_questions_must_be_array
    if checklist_questions.present? && !checklist_questions.is_a?(Array)
      errors.add(:checklist_questions, "must be a list of questions")
    end
  end
end

================================================================================
FILE: app/models/checklist_entry.rb
================================================================================
class ChecklistEntry < ApplicationRecord
  belongs_to :report
  belongs_to :spec_item
end


================================================================================
FILE: app/models/crew_entry.rb
================================================================================
class CrewEntry < ApplicationRecord
  belongs_to :report

  # Optional: Validations to keep data clean
  validates :contractor, presence: true
end

================================================================================
FILE: app/models/equipment_entry.rb
================================================================================
class EquipmentEntry < ApplicationRecord
  belongs_to :report

  # Optional: Validations
  validates :contractor, presence: true
  validates :make_model, presence: true
end

================================================================================
FILE: app/models/phase.rb
================================================================================
class Phase < ApplicationRecord
end


================================================================================
FILE: app/models/placed_quantity.rb
================================================================================
class PlacedQuantity < ApplicationRecord
  belongs_to :report
  belongs_to :bid_item

  validates :bid_item, presence: true

  # SMART GETTER: Ensures this always returns a Hash/List, never a String
  def checklist_answers
    # 1. Get the raw value from the database
    value = super

    # 2. If it's already a real Hash (Postgres usually does this), return it
    return value if value.is_a?(Hash)

    # 3. If it's a String (SQLite or text column), parse it into a Hash
    if value.is_a?(String) && value.present?
      begin
        return JSON.parse(value)
      rescue JSON::ParserError
        return {} # Fallback if data is corrupted
      end
    end

    # 4. Default to empty hash if nil
    {}
  end
end

================================================================================
FILE: app/models/project.rb
================================================================================
class Project < ApplicationRecord
  # --- 1. Associations ---
  # The Project acts as the "Library" for this specific contract
  has_many :bid_items, dependent: :destroy
  
  # A "Shortcut" to see which Universal Specs are being used on this job
  has_many :spec_items, through: :bid_items
  
  # --- 2. Validations ---
  validates :name, presence: true
  # We validate the new header fields to ensure data quality
  validates :contract_number, presence: true
end

================================================================================
FILE: app/models/qa_entry.rb
================================================================================
class QaEntry < ApplicationRecord
  belongs_to :report

  # We use the existing column name 'qa_type' found in your file
  enum qa_type: { 
    compaction: 0, 
    concrete_slump: 1, 
    concrete_cylinder: 2, 
    asphalt_temp: 3, 
    nuclear_gauge: 4,
    proof_roll: 5 
  }

  # These keys (qa_pass, qa_fail) are what we will use in the Report logic
  enum result: { 
    qa_pass: 0, 
    qa_fail: 1, 
    qa_pending: 2, 
    qa_n_a: 3 
  }

  validates :qa_type, presence: true
  validates :result, presence: true
end

================================================================================
FILE: app/models/report.rb
================================================================================
class Report < ApplicationRecord
  # --- 1. CONFIGURATION & CALLBACKS ---
  after_initialize :set_defaults, if: :new_record?
  before_save :calculate_automatic_result

  # --- 2. ASSOCIATIONS ---
  belongs_to :project, optional: true
  belongs_to :phase, optional: true
  belongs_to :user
  
  has_many :activity_logs, dependent: :destroy

  # --- NESTED ENTRIES (The Big Four) ---
  
  # 1. PLACED QUANTITIES (BID ITEMS)
  # Reject if 'bid_item_id' is missing.
  has_many :placed_quantities, dependent: :destroy
  accepts_nested_attributes_for :placed_quantities, 
                                allow_destroy: true, 
                                reject_if: proc { |att| att['bid_item_id'].blank? }

  # 2. EQUIPMENT
  # Reject if no description (make_model) is provided.
  has_many :equipment_entries, dependent: :destroy
  accepts_nested_attributes_for :equipment_entries, 
                                allow_destroy: true, 
                                reject_if: proc { |att| att['make_model'].blank? }

  # 3. CREW
  # Reject if 'contractor' is blank.
  has_many :crew_entries, dependent: :destroy
  accepts_nested_attributes_for :crew_entries, 
                                allow_destroy: true, 
                                reject_if: proc { |att| att['contractor'].blank? }

  # 4. QA ENTRIES
  has_many :qa_entries, dependent: :destroy
  accepts_nested_attributes_for :qa_entries, allow_destroy: true, reject_if: :all_blank

  # ATTACHMENTS (Wrapper Model)
  has_many :report_attachments, dependent: :destroy
  accepts_nested_attributes_for :report_attachments, allow_destroy: true

  # CHECKLISTS
  has_many :checklist_entries, dependent: :destroy

  # --- 3. VALIDATIONS ---
  validates :start_date, presence: true
  validates :project, presence: true
  validates :phase, presence: true

  # --- 4. ENUMS (Organized by Category) ---
  enum status: { creating: 0, qc_review: 1, revise: 2, authorization: 3 }
  enum result: { pending: 0, pass: 1, fail: 2, as_built: 3 }
  
  # Compliance & Safety
  enum deficiency_status: { no_deficiency: 0, yes_deficiency: 1, cdr: 2, ncr: 3 }
  enum safety_incident:   { safety_no: 0, safety_yes: 1, safety_na: 2 }
  
  # Site Conditions
  enum traffic_control:       { tc_na: 0, tc_yes: 1, tc_no: 2 }
  enum environmental:         { env_na: 0, env_yes: 1, env_no: 2 }
  enum security:              { sec_na: 0, sec_yes: 1, sec_no: 2 }
  enum air_ops_coordination:  { air_na: 0, air_yes: 1, air_no: 2 }
  enum swppp_controls:        { swppp_na: 0, swppp_yes: 1, swppp_no: 2 }

  # MAESTRO: The Missing Link!
  enum phasing_compliance:    { phase_na: 0, phase_yes: 1, phase_no: 2 }

  # --- 5. SEARCH SCOPES ---
  scope :filter_by_inspector, ->(query) { 
    joins(:user).where("users.email ILIKE ?", "%#{query}%") 
  }
  
  scope :filter_by_project, ->(project_id) { where(project_id: project_id) }
  
  scope :filter_by_date_range, ->(start_date, end_date) { 
    where(start_date: start_date..end_date) 
  }

  # Smart Precip Filter
  scope :filter_by_precip_range, ->(min, max) {
    safe_cast = ->(col) { "CASE WHEN #{col} ~ '^[0-9]+(\\.[0-9]+)?$' THEN #{col}::numeric ELSE 0 END" }
    where(
      "(#{safe_cast.call('precip_1')} BETWEEN ? AND ?) OR " \
      "(#{safe_cast.call('precip_2')} BETWEEN ? AND ?) OR " \
      "(#{safe_cast.call('precip_3')} BETWEEN ? AND ?)",
      min, max, min, max, min, max
    )
  }

  # --- 6. LOGIC & HELPERS ---
  
  def set_defaults
    self.status ||= :creating
    self.result ||= :pending
  end

  def calculate_automatic_result
    # Fail if Critical Issues found
    if cdr? || ncr? || qa_entries.any?(&:qa_fail?)
      self.result = :fail
      return
    end

    # Pending if deficiencies exist or QA is incomplete
    if yes_deficiency? || qa_entries.any?(&:qa_pending?)
      self.result = :pending
      return
    end

    self.result = :pass
  end

  def inspector_name
    user&.email
  end
end

================================================================================
FILE: app/models/report_attachment.rb
================================================================================
class ReportAttachment < ApplicationRecord
  belongs_to :report
  
  # This replaces the old attachment logic
  has_one_attached :file
  
  # Validations
  validates :file, presence: true
end

================================================================================
FILE: app/models/spec_item.rb
================================================================================
class SpecItem < ApplicationRecord
  # This Spec governs many Bid Items
  has_many :bid_items
  
  # Validations to keep data clean
  validates :code, presence: true, uniqueness: true
end

================================================================================
FILE: app/models/user.rb
================================================================================
class User < ApplicationRecord
  # Include default devise modules. Others available are:
  # :confirmable, :lockable, :timeoutable, :trackable and :omniauthable
  devise :database_authenticatable, :registerable,
         :recoverable, :rememberable, :validatable

  
  
  has_many :reports, dependent: :destroy       
end


================================================================================
FILE: app/services/word_report_exporter.rb
================================================================================
require 'docx'
require 'tempfile'

class WordReportExporter
  def self.generate(report)
    # 1. LOAD TEMPLATE
    template_path = Rails.root.join('app', 'assets', 'documents', 'inspection_template.docx')
    return nil unless File.exist?(template_path)

    # 2. PREPARE CAPTION MAPPING
    # Maps attachment captions to placeholders {{CAPTION 1}} ... {{CAPTION 6}}
    caption_map = {}
    (1..6).each do |i|
      attachment = report.report_attachments[i-1]
      text = attachment ? (attachment.caption || "") : ""
      caption_map["{{CAPTION #{i}}}"] = text
    end

    # 3. DEFINE REPLACEMENTS
    # These are simple text replacements for the header/footer/body
    base_replacements = {
      # --- General Info ---
      '{{PROJECT}}'     => report.project&.name,
      '{{START_DATE}}'  => report.start_date&.strftime("%m/%d/%Y"),
      '{{START_SHIFT}}' => report.shift_start,
      '{{END_DATE}}'    => report.end_date&.strftime("%m/%d/%Y"),
      '{{END_SHIFT}}'   => report.shift_end,
      '{{INSPECTOR}}'   => report.inspector_name,

      # --- Weather ---
      '{{TEMP}}'    => [report.temp_1, report.temp_2, report.temp_3].compact.join(' / '),
      '{{WEATHER}}' => [report.weather_summary_1, report.weather_summary_2, report.weather_summary_3].compact.join(' / '),
      '{{WIND}}'    => [report.wind_1, report.wind_2, report.wind_3].compact.join(' / '),
      '{{PRECIP}}'  => [report.precip_1, report.precip_2, report.precip_3].compact.join(' / '),
      '{{VIS}}'     => "N/A",
      '{{SURFACE}}' => "N/A",

      # --- Compliance & Safety ---
      '{{SEC_STATUS}}'      => human_enum(report.security),
      '{{TC_STATUS}}'       => human_enum(report.traffic_control),
      '{{AIR_OPS}}'         => human_enum(report.air_ops_coordination),
      '{{SWPPP}}'           => human_enum(report.swppp_controls),
      '{{ENV_STATUS}}'      => human_enum(report.environmental),
      '{{SAF_STATUS}}'      => human_enum(report.safety_incident),
      '{{SAF_DESCRIPTION}}' => report.safety_desc || "None",
      '{{DEF_STATUS}}'      => human_enum(report.deficiency_status),
      '{{DEF_DESC}}'        => report.deficiency_desc || "None",

      # --- Commentary ---
      '{{COMMENTARY}}'   => report.commentary,
      '{{ADD_ACTIVITY}}' => report.additional_activities,
      '{{ADD_INFO}}'     => report.additional_info
    }

    replacements = base_replacements.merge(caption_map)

    # 4. OPEN DOCUMENT
    doc = Docx::Document.open(template_path.to_s)

    # 5. GLOBAL FIND & REPLACE
    replace_all(doc, replacements)

    # 6. DYNAMIC TABLE PROCESSING
    # We scan tables for specific placeholder rows and duplicate them for each data entry.
    doc.tables.each do |table|
      
      # A. QA TABLE
      if table_has_placeholder?(table, '[TEST]')
        populate_table(table, report.qa_entries, {
          '[CODE]'     => :qa_type,
          '[TEST]'     => :qa_type,
          '[LOCATION]' => :location,
          '[RESULT]'   => :result,
          '[REMARKS]'  => :remarks
        })
      end

      # B. PLACED QUANTITIES (BID ITEMS) TABLE
      # Note: This logic matches the new PlacedQuantities naming
      if table_has_placeholder?(table, '[DESC]')
        populate_table(table, report.placed_quantities, {
          '[CODE]'  => ->(entry) { entry.bid_item&.code },
          '[DESC]'  => ->(entry) { entry.bid_item&.description },
          '[QTY]'   => :quantity,
          '[NOTES]' => :notes
        })
      end

      # C. WORKFORCE TABLE (Nested Crew Entries)
      if table_has_placeholder?(table, '[CONTRACTOR]')
        populate_table(table, report.crew_entries, {
          '[CONTRACTOR]'  => :contractor,
          '[SURVEY]'      => :survey_count,
          '[SUPER]'       => :superintendent,
          '[FOREMAN]'     => :foreman,
          '[OPERATOR]'    => :operator_count,
          '[LABORER]'     => :laborer_count,
          '[ELECTRICIAN]' => :electrician_count
        })
      end

      # D. EQUIPMENT TABLE
      if table_has_placeholder?(table, '[EQUIPMENT]')
        populate_table(table, report.equipment_entries, {
          '[EQUIPMENT]' => :make_model,
          '[QTY]'       => :quantity,
          '[HOURS]'     => :hours
        })
      end
    end

    # 7. SAVE TO TEMP FILE
    temp_file = Tempfile.new(['report', '.docx'])
    doc.save(temp_file.path)
    temp_file
  end

  private

  # Helper: Converts enum strings like "qa_pass" to "Pass" or "traffic_yes" to "Yes"
  def self.human_enum(val)
    return "N/A" if val.nil? || val == 0
    # Splits "safety_yes" -> "Yes", "qa_fail" -> "Fail"
    val.include?('_') ? val.split('_').last.capitalize : val.humanize
  end

  # Helper: Iterates through document paragraphs to replace text
  def self.replace_all(doc, replacements)
    doc.paragraphs.each { |p| replace_in_paragraph(p, replacements) }
    doc.tables.each { |t| replace_in_table(t, replacements) }
  end

  def self.replace_in_paragraph(p, replacements)
    replacements.each { |key, value| p.text = p.text.gsub(key, value.to_s) }
  end

  def self.replace_in_table(table, replacements)
    table.rows.each do |row|
      row.cells.each do |cell|
        cell.paragraphs.each { |p| replace_in_paragraph(p, replacements) }
      end
    end
  end

  def self.table_has_placeholder?(table, tag)
    table.rows.any? { |row| row.cells.any? { |cell| clean_text(cell.text).include?(tag) } }
  end

  def self.clean_text(text)
    text.gsub(/[â€œâ€]/, '"')
  end

  # --- CORE TABLE POPULATION LOGIC ---
  # Finds a row with placeholders, duplicates it for each data item, fills it, and deletes the template row.
  def self.populate_table(table, data_collection, mapping)
    # 1. Find the template row index
    template_row_index = table.rows.find_index do |row|
      row.cells.any? { |cell| mapping.keys.any? { |k| clean_text(cell.text).include?(k) } }
    end
    return unless template_row_index

    template_row = table.rows[template_row_index]

    data_collection.each do |item|
      # 2. Deep Clone
      new_row = template_row.copy
      
      # 3. Insert BEFORE the template row
      template_row.node.add_previous_sibling(new_row.node)

      # 4. Fill Data
      new_row.cells.each do |cell|
        mapping.each do |placeholder, attribute|
          if clean_text(cell.text).include?(placeholder)
            # Resolve the value
            val = if attribute.is_a?(Proc)
                    attribute.call(item)
                  elsif item.respond_to?(attribute)
                    val_raw = item.send(attribute)
                    # Check if it's an enum needing formatting
                    val_raw.is_a?(String) && item.class.defined_enums.has_key?(attribute.to_s) ? human_enum(val_raw) : val_raw
                  else
                    ""
                  end

            # Replace text safely inside paragraphs
            regex = /["â€œâ€]?#{Regexp.escape(placeholder)}["â€œâ€]?/
            cell.paragraphs.each do |p|
              p.text = p.text.gsub(regex, val.to_s)
            end
          end
        end
      end
    end

    # 5. Remove the template row
    template_row.node.remove
  end
end

================================================================================
FILE: app/views/bid_items/_bid_item.html.erb
================================================================================
<div id="<%= dom_id bid_item %>">
  <p>
    <strong>Code:</strong>
    <%= bid_item.code %>
  </p>

  <p>
    <strong>Description:</strong>
    <%= bid_item.description %>
  </p>

  <p>
    <strong>Unit:</strong>
    <%= bid_item.unit %>
  </p>

</div>


================================================================================
FILE: app/views/bid_items/_form.html.erb
================================================================================
<%# The form now takes an array [@project, bid_item] to build the correct nested URL %>
<%= form_with(model: [@project, bid_item], class: "contents") do |form| %>
  
  <% if bid_item.errors.any? %>
    <div class="error-explanation">
      <h2><%= pluralize(bid_item.errors.count, "error") %> prohibited saving:</h2>
      <ul><% bid_item.errors.each do |error| %><li><%= error.full_message %></li><% end %></ul>
    </div>
  <% end %>

  <div class="form-card" style="max-width: 600px; margin: 0 auto;">
    
    <div style="margin-bottom: 20px; background: #f9fafb; padding: 10px; border-radius: 6px;">
      <strong>Project:</strong> <%= @project.name %>
    </div>

    <div class="form-group">
      <%= form.label :code, "Project Item Code" %>
      <%= form.text_field :code, placeholder: "e.g. CD-12 or P-401" %>
      <small class="text-muted">This is the code used in the contract documents.</small>
    </div>

    <div class="form-group">
      <%= form.label :spec_item_id, "Link to FAA Specification (Universal)" %>
      <%# This is the 'Rosetta Stone' link %>
      <%= form.collection_select :spec_item_id, SpecItem.all.order(:code), :id, :description, { prompt: "Select FAA Spec..." }, { class: "form-control" } %>
    </div>

    <div class="form-group">
      <%= form.label :description, "Item Description" %>
      <%= form.text_field :description %>
    </div>

    <div class="form-group">
      <%= form.label :unit %>
      <%= form.text_field :unit, placeholder: "e.g. SY, CY, EA" %>
    </div>

    <hr style="margin: 20px 0;">

    <div class="form-group">
      <%= form.label :questions_text, "Override Checklist (Optional)" %>
      <div style="font-size: 0.85rem; color: #666; margin-bottom: 5px;">
        <em>Leave blank to use the standard FAA Spec checklist.</em>
      </div>
      <%= form.text_area :questions_text, rows: 5 %>
    </div>

    <div style="margin-top: 20px;">
      <%= form.submit "Save to Project Library", class: "btn btn-primary", style: "width: 100%;" %>
    </div>
    
    <div style="text-align: center; margin-top: 15px;">
       <%= link_to "Cancel", project_bid_items_path(@project) %>
    </div>

  </div>
<% end %>

================================================================================
FILE: app/views/bid_items/edit.html.erb
================================================================================
<h1>Editing <%= @bid_item.code %></h1>

<%= render "form", bid_item: @bid_item %>

<br>

<div>
  <%# FIX: Ensure links know about the @project %>
  <%= link_to "Show this item", project_bid_item_path(@project, @bid_item) %> |
  <%= link_to "Back to Library", project_bid_items_path(@project) %>
</div>

================================================================================
FILE: app/views/bid_items/index.html.erb
================================================================================
<div class="dashboard-container">
  
  <div class="dashboard-header">
    <div>
      <%# 1. Project Context %>
      <h1>Library: <%= @project.name %></h1>
      <p style="color: #666; margin: 0;">Contract: <%= @project.contract_number %></p>
    </div>
    
    <div style="display: flex; gap: 10px;">
      <%# 2. Project-Aware New Button %>
      <%= link_to "+ New Item", new_project_bid_item_path(@project), class: "btn btn-primary" %>
      
      <%# 3. Improved Back Button (Goes to Project Details, not Global List) %>
      <%= link_to "Back to Project", project_path(@project), class: "btn btn-secondary" %>
    </div>
  </div>
    
    <div>
      <%# 2. Project-Aware New Button %>
      <%= link_to "+ New Item", new_project_bid_item_path(@project), class: "btn btn-primary" %>
      
      <%# 3. Back Button returns to Project Directory %>
      <%= link_to "Back to Projects", projects_path, class: "btn btn-secondary", style: "margin-left: 10px;" %>
    </div>
  </div>

  <div class="table-card">
    <table class="modern-table dashboard-table">
      <thead>
        <tr>
          <th>Code</th>
          <th>Description</th>
          <th class="text-center">Unit</th>
          <th>Linked Spec</th>
          <th class="text-right">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if @bid_items.any? %>
          <% @bid_items.each do |bid_item| %>
            <tr>
              <td style="font-weight: bold; color: var(--primary);">
                <%= bid_item.code %>
              </td>
              <td><%= bid_item.description %></td>
              <td class="text-center"><%= bid_item.unit %></td>
              
              <%# 4. Show the Universal Spec Link %>
              <td>
                <% if bid_item.spec_item %>
                  <span style="background: #eff6ff; color: #1e40af; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">
                    <%= bid_item.spec_item.code %>
                  </span>
                <% else %>
                  <span class="text-muted">-</span>
                <% end %>
              </td>

              <td class="text-right">
                <%# 5. Project-Aware Edit/Delete Links %>
                <%= link_to "Edit", edit_project_bid_item_path(@project, bid_item), class: "link-primary", style: "margin-right: 10px;" %>
                <%= button_to "Delete", project_bid_item_path(@project, bid_item), method: :delete, class: "btn-clear", style: "color: red; display: inline; padding: 0;", form: {style: "display:inline"} %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="5" style="text-align: center; padding: 40px; color: #666;">
              No bid items in this library yet.<br>
              Click "+ New Item" to add codes from your contract.
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

</div>

================================================================================
FILE: app/views/bid_items/new.html.erb
================================================================================
<h1>New Bid Item for <%= @project.name %></h1>

<%# The form is already set up correctly with [@project, @bid_item] %>
<%= render "form", bid_item: @bid_item %>

<br>

<div>
  <%# FIX: Use project_bid_items_path(@project) instead of bid_items_path %>
  <%= link_to "Back to Library", project_bid_items_path(@project) %>
</div>

================================================================================
FILE: app/views/bid_items/show.html.erb
================================================================================
<p style="color: green"><%= notice %></p>

<div class="form-card">
  <h2>Item Details: <%= @bid_item.code %></h2>
  <%= render @bid_item %>
  
  <% if @bid_item.spec_item %>
    <p><strong>Linked Spec:</strong> <%= @bid_item.spec_item.code %> - <%= @bid_item.spec_item.description %></p>
  <% end %>
</div>

<div style="margin-top: 20px;">
  <%# FIX: Nested path helpers %>
  <%= link_to "Edit this item", edit_project_bid_item_path(@project, @bid_item), class: "btn btn-primary" %> 
  <%= link_to "Back to Library", project_bid_items_path(@project), class: "btn btn-secondary" %>

  <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
     <%# FIX: Delete button needs the array [@project, @bid_item] to generate the correct URL %>
     <%= button_to "Destroy this item", [@project, @bid_item], method: :delete, class: "btn btn-danger", form: { style: "display:inline-block;" } %>
  </div>
</div>

================================================================================
FILE: app/views/layouts/application.html.erb
================================================================================
<!DOCTYPE html>
<html>
  <head>
    <title>InspectionCms</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>

    <style>
      /* DETECTIVE WINDOW */
      #detective-window {
        position: fixed;
        bottom: 90px; 
        left: 20px;
        width: 600px;
        max-width: 90vw;
        background-color: rgba(0, 0, 0, 0.95); 
        color: #0f0;
        border: 2px solid #0f0;
        border-radius: 8px;
        padding: 20px;
        z-index: 10000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        transition: opacity 0.2s, transform 0.2s;
        /* Default State */
        opacity: 1;
        transform: translateY(0);
      }

      /* HIDDEN STATE */
      .detective-hidden {
        opacity: 0 !important;
        pointer-events: none !important;
        transform: translateY(20px) !important;
      }

      /* FLOATING BUTTONS */
      .floating-actions {
        position: fixed;
        bottom: 20px;
        left: 20px;
        z-index: 10001; /* Higher than window so they are always clickable */
        display: flex;
        gap: 10px;
      }

      .float-btn {
        background: #333;
        color: #fff;
        border: 1px solid #555;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
      }
      
      .float-btn:hover { transform: scale(1.1); background: #000; }
      #theme-toggle-btn { color: #FFD700; border-color: #FFD700; }
    </style>
  </head>

  <body data-controller="ui">
    
    <div id="detective-window" class="detective-hidden" data-ui-target="detective" style="font-family: monospace;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h3 style="margin: 0; color: #00FF00;">ðŸ•µï¸ Detective Report</h3>
        <button class="detective-close-btn" style="background: none; border: none; color: #00FF00; cursor: pointer; font-weight: bold;" 
                data-action="click->ui#toggleDetective">âœ•</button>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <p><strong>Reports Total:</strong> <%= Report.count %></p>
          <p><strong>View Status:</strong> <%= params[:status] || "All" %></p>
          <p><strong>Controller:</strong> <%= controller_name %>#<%= action_name %></p>
        </div>
        <div>
           <p><strong>User:</strong> <%= user_signed_in? ? current_user.email : "Guest" %></p>
           <code style="display:block; background:#333; padding:5px; font-size:0.8rem; color:#ccc;"><%= params.to_json %></code>
        </div>
      </div>
      
      <% if user_signed_in? %>
        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #444;">
           <%= button_to "Log Out", destroy_user_session_path, method: :delete, style: "background: #dc3545; color: white; border: none; padding: 5px 10px; cursor: pointer;" %>
        </div>
      <% end %>
    </div>

    <%= yield %>

    <div class="floating-actions">
      <button class="float-btn" style="color: #00FF00; border-color: #00FF00;" title="Debugger" 
              data-action="click->ui#toggleDetective">ðŸž</button>
      
      <button id="theme-toggle-btn" class="float-btn" title="Dark Mode" 
              data-action="click->ui#toggleTheme">ðŸŒ“</button>
    </div>

  </body>
</html>

================================================================================
FILE: app/views/layouts/mailer.html.erb
================================================================================
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style>
      /* Email styles need to be inline */
    </style>
  </head>

  <body>
    <%= yield %>
  </body>
</html>


================================================================================
FILE: app/views/layouts/mailer.text.erb
================================================================================
<%= yield %>


================================================================================
FILE: app/views/phases/_form.html.erb
================================================================================
<%= form_with(model: phase) do |form| %>
  <% if phase.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(phase.errors.count, "error") %> prohibited this phase from being saved:</h2>

      <ul>
        <% phase.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= form.label :name, style: "display: block" %>
    <%= form.text_field :name %>
  </div>

  <div>
    <%= form.submit %>
  </div>
<% end %>


================================================================================
FILE: app/views/phases/_phase.html.erb
================================================================================
<div id="<%= dom_id phase %>">
  <p>
    <strong>Name:</strong>
    <%= phase.name %>
  </p>

</div>


================================================================================
FILE: app/views/phases/edit.html.erb
================================================================================
<h1>Editing phase</h1>

<%= render "form", phase: @phase %>

<br>

<div>
  <%= link_to "Show this phase", @phase %> |
  <%= link_to "Back to phases", phases_path %>
</div>


================================================================================
FILE: app/views/phases/index.html.erb
================================================================================
<p style="color: green"><%= notice %></p>

<h1>Phases</h1>

<div id="phases">
  <% @phases.each do |phase| %>
    <%= render phase %>
    <p>
      <%= link_to "Show this phase", phase %>
    </p>
  <% end %>
</div>

<%= link_to "New phase", new_phase_path %>


================================================================================
FILE: app/views/phases/new.html.erb
================================================================================
<h1>New phase</h1>

<%= render "form", phase: @phase %>

<br>

<div>
  <%= link_to "Back to phases", phases_path %>
</div>


================================================================================
FILE: app/views/phases/show.html.erb
================================================================================
<p style="color: green"><%= notice %></p>

<%= render @phase %>

<div>
  <%= link_to "Edit this phase", edit_phase_path(@phase) %> |
  <%= link_to "Back to phases", phases_path %>

  <%= button_to "Destroy this phase", @phase, method: :delete %>
</div>


================================================================================
FILE: app/views/placed_quantities/_form.html.erb
================================================================================
<%= form_with(model: placed_quantity) do |form| %>
  <% if placed_quantity.errors.any? %>
    <div style="color: red">
      <h2><%= pluralize(placed_quantity.errors.count, "error") %> prohibited this placed_quantity from being saved:</h2>

      <ul>
        <% placed_quantity.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= form.label :report_id, style: "display: block" %>
    <%= form.text_field :report_id %>
  </div>

  <div>
    <%= form.label :bid_item_id, style: "display: block" %>
    <%= form.text_field :bid_item_id %>
  </div>

  <div>
    <%= form.label :quantity, style: "display: block" %>
    <%= form.text_field :quantity %>
  </div>

  <div>
    <%= form.label :location, style: "display: block" %>
    <%= form.text_field :location %>
  </div>

  <div>
    <%= form.label :notes, style: "display: block" %>
    <%= form.text_area :notes %>
  </div>

  <div>
    <%= form.submit %>
  </div>
<% end %>


================================================================================
FILE: app/views/placed_quantities/_placed_quantity.html.erb
================================================================================
<div id="<%= dom_id placed_quantity %>">
  <p>
    <strong>Report:</strong>
    <%= placed_quantity.report_id %>
  </p>

  <p>
    <strong>Bid item:</strong>
    <%= placed_quantity.bid_item_id %>
  </p>

  <p>
    <strong>Quantity:</strong>
    <%= placed_quantity.quantity %>
  </p>

  <p>
    <strong>Location:</strong>
    <%= placed_quantity.location %>
  </p>

  <p>
    <strong>Notes:</strong>
    <%= placed_quantity.notes %>
  </p>

</div>


================================================================================
FILE: app/views/placed_quantities/edit.html.erb
================================================================================
<h1>Editing inspection entry</h1>

<%= render "form", placed_quantity: @placed_quantity %>

<br>

<div>
  <%= link_to "Show this inspection entry", @placed_quantity %> |
  <%= link_to "Back to inspection entries", placed_quantities_path %>
</div>


================================================================================
FILE: app/views/placed_quantities/index.html.erb
================================================================================
<p style="color: green"><%= notice %></p>

<h1>Inspection entries</h1>

<div id="placed_quantities">
  <% @placed_quantities.each do |placed_quantity| %>
    <%= render placed_quantity %>
    <p>
      <%= link_to "Show this inspection entry", placed_quantity %>
    </p>
  <% end %>
</div>

<%= link_to "New inspection entry", new_placed_quantity_path %>


================================================================================
FILE: app/views/placed_quantities/new.html.erb
================================================================================
<h1>New inspection entry</h1>

<%= render "form", placed_quantity: @placed_quantity %>

<br>

<div>
  <%= link_to "Back to inspection entries", placed_quantities_path %>
</div>


================================================================================
FILE: app/views/placed_quantities/show.html.erb
================================================================================
<p style="color: green"><%= notice %></p>

<%= render @placed_quantity %>

<div>
  <%= link_to "Edit this inspection entry", edit_placed_quantity_path(@placed_quantity) %> |
  <%= link_to "Back to inspection entries", placed_quantities_path %>

  <%= button_to "Destroy this inspection entry", @placed_quantity, method: :delete %>
</div>


================================================================================
FILE: app/views/projects/_form.html.erb
================================================================================
<%= form_with(model: project, class: "contents") do |form| %>
  <% if project.errors.any? %>
    <div class="error-explanation">
      <h2><%= pluralize(project.errors.count, "error") %> prohibited this project from being saved:</h2>
      <ul>
        <% project.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-card">
    <h2 style="border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 20px;">Project Details</h2>

    <div class="form-row">
      <div class="form-group full-width">
        <%= form.label :name, "Project Name" %>
        <%= form.text_field :name, placeholder: "e.g. Runway 1R Rehabilitation" %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <%= form.label :contract_number %>
        <%= form.text_field :contract_number, placeholder: "e.g. 8983.61" %>
      </div>
      <div class="form-group">
        <%= form.label :contract_days, "Contract Duration (Days)" %>
        <%= form.number_field :contract_days %>
      </div>
      <div class="form-group">
        <%= form.label :contract_start_date %>
        <%= form.date_field :contract_start_date %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <%= form.label :project_manager, "Project Manager (PM)" %>
        <%= form.text_field :project_manager %>
      </div>
      <div class="form-group">
        <%= form.label :construction_manager, "Construction Manager (CM)" %>
        <%= form.text_field :construction_manager %>
      </div>
    </div>

    <div class="actions" style="margin-top: 20px; text-align: right;">
      <%= form.submit class: "btn btn-primary" %>
    </div>
  </div>
<% end %>

================================================================================
FILE: app/views/projects/_project.html.erb
================================================================================
<div id="<%= dom_id project %>">
  <p>
    <strong>Name:</strong>
    <%= project.name %>
  </p>

</div>


================================================================================
FILE: app/views/projects/edit.html.erb
================================================================================
<h1>Editing project</h1>

<%= render "form", project: @project %>

<br>

<div>
  <%= link_to "Show this project", @project %> |
  <%= link_to "Back to projects", projects_path %>
</div>


================================================================================
FILE: app/views/projects/index.html.erb
================================================================================
<div class="dashboard-container">
  
  <%# --- HEADER --- %>
  <div class="dashboard-header">
    <h1>Projects Directory</h1>
    <div style="display: flex; gap: 10px;">
      <%= link_to "New Project", new_project_path, class: "btn btn-primary" %>
      
      <%# MAESTRO: The Escape Hatch %>
      <%= link_to "Back to Dashboard", root_path, class: "btn btn-secondary" %>
    </div>
  </div>

  <%# --- TABLE CARD --- %>
  <div class="table-card">
    <table class="modern-table dashboard-table">
      <thead>
        <tr>
          <th>Project Name</th>
          <th>Contract #</th>
          <th>Manager (PM)</th>
          <th class="text-right">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if @projects.any? %>
          <% @projects.each do |project| %>
            <tr>
              <td style="font-weight: 600; color: var(--text-main);">
                <%= project.name %>
              </td>
              <td><%= project.contract_number.presence || "-" %></td>
              <td><%= project.project_manager.presence || "-" %></td>
              
              <td class="text-right">
                 <%# --- THE NEW LIBRARY BUTTON --- %>
                 <%= link_to "Manage Library", project_bid_items_path(project), 
                     class: "btn btn-secondary", 
                     style: "font-size: 0.8rem; padding: 5px 12px; margin-right: 15px;" %>
                 
                 <%# Standard Actions %>
                 <%= link_to "Edit", edit_project_path(project), class: "link-primary", style: "margin-right: 10px;" %>
                 <%= link_to "Show", project, class: "link-primary" %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="4" style="text-align: center; padding: 40px; color: #666;">
              No projects found. Create one to get started!
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

</div>

================================================================================
FILE: app/views/projects/new.html.erb
================================================================================
<h1>New project</h1>

<%= render "form", project: @project %>

<br>

<div>
  <%= link_to "Back to projects", projects_path %>
</div>


================================================================================
FILE: app/views/projects/show.html.erb
================================================================================
<p style="color: green"><%= notice %></p>

<%= render @project %>

<div>
  <%= link_to "Edit this project", edit_project_path(@project) %> |
  <%= link_to "Back to projects", projects_path %>

  <%= button_to "Destroy this project", @project, method: :delete %>
</div>


================================================================================
FILE: app/views/reports/_crew_entry_fields.html.erb
================================================================================
<%# app/views/reports/_crew_entry_fields.html.erb %>
<div class="nested-entry-card nested-fields" style="margin-bottom: 15px; padding: 15px; border: 1px solid #eee; border-radius: 5px;">
  
  <%# --- ROW 1 --- %>
  <div class="form-row">
     <div class="form-group">
       <label>Contractor</label>
       <%# Class 'auto-contractor' is used by JS to auto-fill this field %>
       <%= f.text_field :contractor, placeholder: "Contractor Name", class: "auto-contractor" %>
     </div>
     <div class="form-group">
       <label>Superintendent</label>
       <%= f.text_field :superintendent, placeholder: "Name" %>
     </div>
     <div class="form-group">
       <label>Foreman</label>
       <%= f.text_field :foreman, placeholder: "Name" %>
     </div>
     <div class="form-group">
       <label>Surveyors</label>
       <%= f.number_field :survey_count, placeholder: "no." %>
     </div>
  </div>

  <%# --- ROW 2 --- %>
  <div class="form-row">
     <div class="form-group">
       <label>Operators</label>
       <%= f.number_field :operator_count, placeholder: "no." %>
     </div>
     <div class="form-group">
       <label>Laborers</label>
       <%= f.number_field :laborer_count, placeholder: "no." %>
     </div>
     <div class="form-group">
       <label>Electricians</label>
       <%= f.number_field :electrician_count, placeholder: "no." %>
     </div>
     
     <%# --- DELETE BUTTON LOGIC --- %>
     <div class="form-group" style="display:flex; align-items:flex-end;">
       <%# 1. If saved, render the hidden destroy checkbox %>
       <% if f.object.persisted? %>
         <div style="display:none;"><%= f.check_box :_destroy %></div>
       <% end %>

       <%# 2. Always show the button. JS removes the DOM element. %>
       <button type="button" class="remove-row-btn" 
               data-action="click->report-form#removeAssociation" 
               style="color: red;">
         Delete
       </button>
     </div>
  </div>

</div>

================================================================================
FILE: app/views/reports/_equipment_entry_fields.html.erb
================================================================================
<div class="nested-entry-card nested-fields" style="margin-bottom: 10px; padding: 15px; border: 1px solid #eee; border-radius: 5px;">
  <div class="form-row">
    <div class="form-group" style="flex: 2;">
      <label class="text-muted-sm">Contractor</label>
      <%= f.text_field :contractor, placeholder: "Contractor", class: "auto-contractor", style: "width: 100%;" %>
    </div>
    <div class="form-group" style="flex: 3;">
      <label class="text-muted-sm">Make/Model</label>
      <%= f.text_field :make_model, placeholder: "Description", style: "width: 100%;" %>
    </div>
    <div class="form-group" style="flex: 0.5;">
      <label class="text-muted-sm">Qty</label>
      <%= f.number_field :quantity, placeholder: "1", style: "width: 100%;" %>
    </div>
    <div class="form-group" style="flex: 1;">
      <label class="text-muted-sm">Hours</label>
      <%= f.number_field :hours, step: 0.5, placeholder: "Hrs", style: "width: 100%;" %>
    </div>
    
    <div class="form-group" style="display: flex; align-items: flex-end;">
      <% if f.object&.persisted? %>
        <div style="display:none;"><%= f.check_box :_destroy %></div>
        <button type="button" class="remove-row-btn" data-action="click->report-form#removeAssociation" style="color: red; margin-bottom: 10px;">Delete</button>
      <% end %>
    </div>
  </div>
</div>

================================================================================
FILE: app/views/reports/_form.html.erb
================================================================================
<%# app/views/reports/_form.html.erb %>
<%= form_with(model: report, id: "report-form", multipart: true, data: { controller: "report-form" }) do |form| %>
  
  <%# --- ERROR HANDLING --- %>
  <% if report.errors.any? %>
    <div class="error-explanation">
      <h2><%= pluralize(report.errors.count, "error") %> prohibited this report from being saved:</h2>
      <ul>
        <% report.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%# =========================================================================
      SECTION 1: GENERAL INFORMATION
      ========================================================================= %>
  <div class="form-card">
    <%# --- HEADER WITH CONTEXT --- %>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:15px;">
      <div>
        <h2 style="margin:0; border:none; display: inline-block; margin-right: 15px;">1. General Information</h2>
        <%# READ-ONLY PROJECT CONTEXT %>
        <% if report.project %>
          <span style="font-size: 1rem; color: var(--primary); font-weight: 600; background: #eff6ff; padding: 4px 10px; border-radius: 6px; border: 1px solid #dbeafe;">
            ðŸ“‚ <%= report.project.name %>
          </span>
          <%# Hidden field ensures the ID is submitted %>
          <%= form.hidden_field :project_id %>
        <% else %>
          <span style="color: var(--danger);">âš  No Project Selected</span>
        <% end %>
      </div>
      <div style="font-size:0.9rem; color:#666; font-family: monospace; background: #f3f4f6; padding: 4px 8px; border-radius: 4px;">
        DIR #<%= report.dir_number %>
      </div>
    </div>

    <%# --- ROW 1: PHASE & CONTRACTOR --- %>
    <div class="form-row">
      <div class="form-group" style="flex: 1;">
        <label>Phase / Area <span style="color:red">*</span></label>
        <%= form.collection_select :phase_id, Phase.all, :id, :name, {prompt: "Select Phase"}, { class: "form-control", required: true } %>
      </div>
      <div class="form-group" style="flex: 2;">
        <label>Prime Contractor</label>
        <%= form.text_field :contractor, id: "main-contractor-input", placeholder: "Enter Prime Contractor Name", style: "font-weight: 500;" %>
      </div>
    </div>

    <%# --- ROW 2: DATES & TIMES --- %>
    <div class="form-row">
      <div class="form-group">
        <label>Start Date <span style="color:red">*</span></label>
        <%= form.date_field :start_date, required: true %>
      </div>
      <div class="form-group">
        <label>End Date</label>
        <%= form.date_field :end_date %>
      </div>
      <div class="form-group">
        <label>Shift Start</label>
        <%= form.time_field :shift_start %>
      </div>
      <div class="form-group">
        <label>Shift End</label>
        <%= form.time_field :shift_end %>
      </div>
    </div>

    <%# --- WEATHER TRIO --- %>
    <div style="margin-top: 25px;">
      <label style="font-size: 0.85rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Weather Conditions</label>
      
      <div class="weather-grid">
        <%# --- COLUMN 1: START --- %>
        <div class="weather-col">
          <label>Start of Shift</label>
          <%= form.number_field :temp_1, placeholder: "Temp (Â°F)", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :weather_summary_1, placeholder: "Condition (e.g. Sunny)", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :wind_1, placeholder: "Wind (e.g. 5mph N)", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :precip_1, placeholder: "Precipitation", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :visibility_1, placeholder: "Visibility", style: "width: 100%;" %>
          
          <button type="button" class="btn-secondary weather-fetch-btn" 
                  data-action="click->report-form#fetchWeather" 
                  data-suffix="1" 
                  style="margin-top: 10px; width: 100%; font-size: 0.8rem;">
            ðŸ“ Auto-Fill
          </button>
        </div>

        <%# --- COLUMN 2: MID --- %>
        <div class="weather-col">
          <label>Mid Shift</label>
          <%= form.number_field :temp_2, placeholder: "Temp (Â°F)", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :weather_summary_2, placeholder: "Condition", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :wind_2, placeholder: "Wind", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :precip_2, placeholder: "Precipitation", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :visibility_2, placeholder: "Visibility", style: "width: 100%;" %>

          <button type="button" class="btn-secondary weather-fetch-btn" 
                  data-action="click->report-form#fetchWeather" 
                  data-suffix="2" 
                  style="margin-top: 10px; width: 100%; font-size: 0.8rem;">
            ðŸ“ Auto-Fill
          </button>
        </div>

        <%# --- COLUMN 3: END --- %>
        <div class="weather-col">
          <label>End of Shift</label>
          <%= form.number_field :temp_3, placeholder: "Temp (Â°F)", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :weather_summary_3, placeholder: "Condition", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :wind_3, placeholder: "Wind", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :precip_3, placeholder: "Precipitation", class: "mb-2", style: "width: 100%; margin-bottom: 8px;" %>
          <%= form.text_field :visibility_3, placeholder: "Visibility", style: "width: 100%;" %>

          <button type="button" class="btn-secondary weather-fetch-btn" 
                  data-action="click->report-form#fetchWeather" 
                  data-suffix="3" 
                  style="margin-top: 10px; width: 100%; font-size: 0.8rem;">
            ðŸ“ Auto-Fill
          </button>
        </div>
      </div>
      
      <%# MAESTRO: Surface Conditions - Single field grouped with weather %>
      <div style="margin-top: 15px; background: #f9fafb; padding: 15px; border-radius: 6px; border: 1px solid #e5e7eb;">
        <label style="font-weight: 600; color: var(--text-main);">Surface / Site Conditions</label>
        <%= form.text_field :surface_conditions, placeholder: "e.g. Dry, Muddy, Standing Water in areas...", style: "width: 100%; margin-top: 5px;" %>
      </div>
    </div>
  </div>

  <%# =========================================================================
      SECTION 2: COMPLIANCE & CHECKLISTS
      ========================================================================= %>
  <div class="form-card">
    <h2 style="margin-top:0;">2. Compliance & Checklists</h2>

    <%# --- A. CRITICAL ALERTS --- %>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
      <%# Deficiencies %>
      <div style="background: var(--bg-alert); border: 1px solid var(--border-alert); padding: 15px; border-radius: 8px;">
         <label style="color: var(--danger); font-weight: bold; display: block; margin-bottom: 8px;">Deficiencies / NCRs?</label>
         <div class="radio-group">
            <% Report.deficiency_statuses.keys.each do |k| %>
              <label class="radio-label" style="background:white; border:1px solid #ddd;">
                <%= form.radio_button :deficiency_status, k, 
                    data: { action: "change->report-form#toggleSection", target_id: "deficiency-note", valid_values: ['yes_deficiency', 'cdr', 'ncr'].to_json } %> 
                <span style="font-size:0.8rem;"><%= k.humanize.gsub(' deficiency', '') %></span>
              </label>
            <% end %>
         </div>
         <div id="deficiency-note" style="display: none; margin-top: 10px;">
           <%= form.text_area :deficiency_desc, rows: 2, placeholder: "Describe deficiency...", style: "width:100%;" %>
         </div>
      </div>

      <%# Safety %>
      <div style="background: #fff7ed; border: 1px solid #fed7aa; padding: 15px; border-radius: 8px;">
         <label style="color: #c2410c; font-weight: bold; display: block; margin-bottom: 8px;">Safety Issues?</label>
         <div class="radio-group">
            <% Report.safety_incidents.keys.each do |k| %>
              <label class="radio-label" style="background:white; border:1px solid #ddd;">
                <%= form.radio_button :safety_incident, k, 
                    data: { action: "change->report-form#toggleSection", target_id: "safety-note", valid_values: ['safety_yes'].to_json } %> 
                <span style="font-size:0.8rem;"><%= k == 'safety_yes' ? 'Yes' : (k == 'safety_no' ? 'No' : 'N/A') %></span>
              </label>
            <% end %>
         </div>
         <div id="safety-note" style="display: none; margin-top: 10px;">
           <%= form.text_area :safety_desc, rows: 2, placeholder: "Describe incident...", style: "width:100%;" %>
         </div>
      </div>
    </div>

    <%# --- B. STANDARD COMPLIANCE GRID (Refactored) --- %>
    <h3 style="font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 15px;">Site Conditions & Compliance</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 30px;">
      
      <%# MAESTRO: Smart Helper that adds conditional note field %>
      <% render_compliance_item = ->(field_name, label_text, note_field, enum_keys) { %>
        <%# Determine which key triggers the note (logic: ends with '_no') %>
        <% no_key = enum_keys.find { |k| k.end_with?('_no') } %>
        
        <div style="border: 1px solid #eee; padding: 15px; border-radius: 6px; background: #fff;">
          <label style="display:block; font-size:0.85rem; font-weight:700; margin-bottom:8px;"><%= label_text %></label>
          
          <div style="display:flex; gap:15px; margin-bottom: 10px;">
            <% enum_keys.each do |k| %>
               <label style="font-size:0.85rem; display:flex; align-items:center; gap:5px; cursor:pointer;">
                 <%# Logic: All buttons trigger the toggle. Only the 'no_key' makes it visible. %>
                 <%= form.radio_button field_name, k,
                     data: { 
                       action: "change->report-form#toggleSection", 
                       target_id: "#{field_name}-note", 
                       valid_values: [no_key].to_json 
                     } 
                 %>
                 <%= k.split('_').last.capitalize %>
               </label>
            <% end %>
          </div>

          <%# Conditional Note Field %>
          <div id="<%= field_name %>-note" style="display: none;">
            <%= form.text_area note_field, rows: 2, placeholder: "Explain non-compliance...", style: "width:100%; border-color: var(--border-alert);" %>
          </div>
        </div>
      <% } %>

      <%# New Items %>
      <% render_compliance_item.call(:phasing_compliance, "Phasing Exhibit Compliance?", :phasing_compliance_note, Report.phasing_compliances.keys) %>
      <% render_compliance_item.call(:security, "OPS Security Compliance?", :security_note, Report.securities.keys) %>
      <% render_compliance_item.call(:environmental, "Environmental Regulation Compliance?", :environmental_note, Report.environmentals.keys) %>
      
      <%# Existing Items %>
      <% render_compliance_item.call(:traffic_control, "Traffic Control", :traffic_control_note, Report.traffic_controls.keys) %>
      <% render_compliance_item.call(:air_ops_coordination, "Air Ops Coordination", :air_ops_note, Report.air_ops_coordinations.keys) %>
      <% render_compliance_item.call(:swppp_controls, "SWPPP Controls", :swppp_note, Report.swppp_controls.keys) %>
    </div>

    <hr style="border-top: 1px solid #e5e7eb; margin: 30px 0;">

    <%# --- C. SPEC CHECKLISTS --- %>
    <%= render "spec_check_card", report: report %>
  </div>

  <%# =========================================================================
      SECTION 3: WORKFORCE & EQUIPMENT
      ========================================================================= %>
  <div class="form-card">
    <h2 style="margin-top:0;">3. Workforce & Equipment</h2>

    <%# Crew %>
    <label style="display:block; font-weight:bold; margin-bottom:10px;">Workforce Log</label>
    <div id="crew-fields-container">
      <%= form.fields_for :crew_entries do |crew_form| %>
        <%= render "crew_entry_fields", f: crew_form %>
      <% end %>
    </div>
    <button type="button" class="btn-secondary" data-action="click->report-form#addAssociation" data-template-id="crew-template" data-container-id="crew-fields-container" data-populate-contractor="true" style="margin-bottom:20px;">+ Add Workforce</button>

    <%# Equipment %>
    <label style="display:block; font-weight:bold; margin-bottom:10px; margin-top:20px;">Equipment Log</label>
    <div id="equipment-fields-container">
      <%= form.fields_for :equipment_entries do |eq_form| %>
        <%= render "equipment_entry_fields", f: eq_form %>
      <% end %>
    </div>
    <button type="button" class="btn-secondary" data-action="click->report-form#addAssociation" data-template-id="equipment-template" data-container-id="equipment-fields-container" data-populate-contractor="true">+ Add Equipment</button>
  </div>

  <%# =========================================================================
      SECTION 4: QA & QUANTITIES
      ========================================================================= %>
  <div class="form-card">
    <h2 style="margin-top:0;">4. QA & Quantities</h2>
    
    <%# QA Section %>
    <div style="margin-bottom: 30px;">
      <label style="display:block; font-weight:bold; margin-bottom:10px;">Quality Assurance Tests</label>
      <div id="qa-entries-container">
        <%= form.fields_for :qa_entries do |qa_form| %>
          <%= render "qa_entry_fields", f: qa_form %>
        <% end %>
      </div>
      <button type="button" class="btn-secondary" data-action="click->report-form#addAssociation" data-template-id="qa-template" data-container-id="qa-entries-container">+ Add Test</button>
    </div>

    <hr style="border-top: 1px solid #e5e7eb; margin: 25px 0;">

    <%# Quantities Section %>
    <div style="margin-bottom: 10px;">
      <label style="display:block; font-weight:bold; margin-bottom:10px;">Placed Quantities (Bid Items)</label>
      <div id="quantity-fields-container">
        <%= form.fields_for :placed_quantities do |entry_form| %>
          <div class="nested-entry-card nested-fields">
             <div class="form-row" style="margin-bottom: 10px;">
               <div class="form-group" style="flex: 2;">
                 <label class="text-muted-sm">Bid Item</label>
                 <% collection = report.project ? report.project.bid_items.order(:code) : [] %>
                 <%= entry_form.select :bid_item_id, 
                       collection.map { |bi| [bi.code + " - " + bi.description, bi.id, { 'data-questions': bi.active_questions.to_json }] }, 
                       { prompt: "Select Item..." }, 
                       { class: "w-full", data: { action: "change->report-form#selectBidItem" } } %>
                 <% if report.project.nil? %><small style="color: red;">(Save Project to load items)</small><% end %>
               </div>
               <div class="form-group">
                 <label class="text-muted-sm">Qty</label>
                 <%= entry_form.number_field :quantity, step: 0.01, placeholder: "Qty" %>
               </div>
             </div>
             
             <%# MAESTRO FIX: Split delete logic so button always appears %>
             <div class="nested-row-container" style="margin-bottom: 10px;">
               <%= entry_form.hidden_field :checklist_answers, class: "checklist-answers-field", value: (entry_form.object.checklist_answers || {}).to_json %>
               <button type="button" class="checklist-btn btn-secondary opacity-50 cursor-not-allowed" data-action="click->report-form#openChecklist">Open Checklist</button>
               
               <% if entry_form.object.persisted? %>
                 <div style="display:none;"><%= entry_form.check_box :_destroy %></div>
               <% end %>
               
               <button type="button" class="remove-row-btn" 
                       data-action="click->report-form#removeAssociation" 
                       style="margin-left: auto; color: red;">
                 âœ• Delete
               </button>
             </div>
             
             <div class="form-group">
               <%= entry_form.text_field :notes, placeholder: "Daily notes for this item...", class: "w-full" %>
             </div>
          </div>
        <% end %>
      </div>
      <button type="button" class="btn-secondary" data-action="click->report-form#addAssociation" data-template-id="placed-quantity-template" data-container-id="quantity-fields-container">+ Add Quantity</button>
    </div>
  </div>

  <%# =========================================================================
      SECTION 5: COMMENTARY & NOTES
      ========================================================================= %>
  <div class="form-card">
    <h2 style="margin-top:0;">5. Commentary & Notes</h2>

    <%# 1. GENERAL COMMENTARY %>
    <div class="form-group full-width" style="margin-bottom: 25px;">
      <label style="font-size:1.1rem; color:var(--primary);">General Commentary</label>
      <small style="display:block; color:#666; margin-bottom:5px;">Summary of the day's events, issues, and progress.</small>
      <%= form.text_area :commentary, rows: 6, style: "font-size:1rem; padding:15px;" %>
    </div>

    <hr style="border-top: 1px solid #e5e7eb; margin: 25px 0;">

    <%# 2. ADDITIONAL ACTIVITIES %>
    <div style="margin-bottom: 15px;">
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
        <%= check_box_tag "toggle_activities", "1", report.additional_activities.present?, 
            data: { action: "change->report-form#toggleSection", target_id: "box-activities" } %>
        <label for="toggle_activities" style="font-weight: bold; cursor: pointer;">Include "Additional Activities"?</label>
      </div>
      <div id="box-activities" style="<%= report.additional_activities.present? ? '' : 'display:none;' %>">
        <%= form.text_area :additional_activities, rows: 4, placeholder: "Describe extra work..." %>
      </div>
    </div>

    <%# 3. ADDITIONAL INFO %>
    <div>
      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
        <%= check_box_tag "toggle_info", "1", report.additional_info.present?, 
            data: { action: "change->report-form#toggleSection", target_id: "box-info" } %>
        <label for="toggle_info" style="font-weight: bold; cursor: pointer;">Include "Additional Information"?</label>
      </div>
      <div id="box-info" style="<%= report.additional_info.present? ? '' : 'display:none;' %>">
        <%= form.text_area :additional_info, rows: 4, placeholder: "Any other details..." %>
      </div>
    </div>
  </div>

  <%# =========================================================================
      SECTION 6: PHOTOS
      ========================================================================= %>
  <div class="form-card">
    <h2 style="margin-top:0;">6. Photos & Attachments</h2>
    <div id="attachments-container" class="gallery-grid">
      <%= form.fields_for :report_attachments do |attachment_form| %>
        <div class="gallery-card nested-fields">
          <div class="thumbnail-area">
            <%# MAESTRO FIX: Ensure record is persisted before attempting thumbnail generation %>
            <% if attachment_form.object.persisted? && attachment_form.object.file.attached? %>
              <% if attachment_form.object.file.representable? %>
                <%= image_tag attachment_form.object.file.representation(resize_to_limit: [400, 400]) %>
              <% else %>
                <span class="doc-icon">ðŸ“„</span>
              <% end %>
            <% end %>
          </div>
          <div style="padding: 10px;">
            <%= attachment_form.text_field :caption, placeholder: "Enter caption...", class: "form-group input", style: "width: 100%; margin-bottom: 5px;" %>
            <div style="text-align: left; margin-top: 5px; font-size: 0.85rem; color: var(--danger);">
              <label><%= attachment_form.check_box :_destroy %> Delete</label>
            </div>
          </div>
        </div>
      <% end %>
    </div>
    <button type="button" class="btn-secondary" data-action="click->report-form#addAssociation" data-template-id="attachment-template" data-container-id="attachments-container" style="margin-top: 20px;">+ Add Photo/Document</button>
  </div>

  <%# --- ACTION BAR --- %>
  <div class="actions" style="margin-top: 2rem; text-align: right; position:sticky; bottom:20px; z-index:100;">
    <%= form.submit "Save & Submit Report", class: "btn-primary-action", style: "box-shadow: 0 4px 12px rgba(0,0,0,0.15);" %>
  </div>

  <%# --- DIALOGS --- %>
  <dialog data-report-form-target="checklistModal">
    <div class="modal-header"><h3>Inspection Checklist</h3></div>
    <div class="modal-body" data-report-form-target="questionsContainer"></div>
    <div class="modal-footer">
      <button type="button" class="btn-secondary" data-action="click->report-form#closeModal">Cancel</button>
      <button type="button" class="btn-primary-action" data-action="click->report-form#saveChecklist">Save Answers</button>
    </div>
  </dialog>

  <%# --- TEMPLATES --- %>
  <%= render "form_templates" %> 

<% end %>

================================================================================
FILE: app/views/reports/_form_templates.html.erb
================================================================================
<%# 1. QA TEMPLATE %>
<template id="qa-template">
  <%# We use fields_for with a new object and a magic child_index %>
  <%# This generates the correct name="report[qa_entries_attributes][NEW_RECORD]..." %>
  <%= fields_for :qa_entries, QaEntry.new, child_index: "NEW_RECORD" do |f| %>
    <%= render "qa_entry_fields", f: f %>
  <% end %>
</template>

<%# 2. CREW TEMPLATE %>
<template id="crew-template">
  <%= fields_for :crew_entries, CrewEntry.new, child_index: "NEW_RECORD" do |f| %>
    <%= render "crew_entry_fields", f: f %>
  <% end %>
</template>

<%# 3. EQUIPMENT TEMPLATE %>
<template id="equipment-template">
  <%= fields_for :equipment_entries, EquipmentEntry.new, child_index: "NEW_RECORD" do |f| %>
    <%= render "equipment_entry_fields", f: f %>
  <% end %>
</template>

<%# 4. PLACED QUANTITY TEMPLATE %>
<%# We didn't modularize this one yet, so we keep the full HTML here %>
<template id="placed-quantity-template">
  <%= fields_for :placed_quantities, PlacedQuantity.new, child_index: "NEW_RECORD" do |entry_form| %>
    <div class="nested-entry-card nested-fields">
       <div class="form-row" style="margin-bottom: 10px;">
         <div class="form-group" style="flex: 2;">
           <label class="text-muted-sm">Bid Item</label>
           <%# Note: We use @report (instance variable) to access the project context %>
           <select name="report[placed_quantities_attributes][NEW_RECORD][bid_item_id]" class="w-full" data-action="change->report-form#selectBidItem">
               <option value="">Select Item</option>
               <% if @report.project %>
                 <% @report.project.bid_items.order(:code).each do |bi| %>
                   <option value="<%= bi.id %>" data-questions="<%= bi.active_questions.to_json %>">
                     <%= bi.code %> - <%= bi.description %>
                   </option>
                 <% end %>
               <% else %>
                 <option disabled>Please save Project first...</option>
               <% end %>
           </select>
         </div>
         <div class="form-group">
           <label class="text-muted-sm">Quantity</label>
           <input class="w-full" type="number" step="0.01" placeholder="Qty" name="report[placed_quantities_attributes][NEW_RECORD][quantity]">
         </div>
       </div>
       
       <div class="nested-row-container" style="margin-bottom: 10px;">
         <input type="hidden" name="report[placed_quantities_attributes][NEW_RECORD][checklist_answers]" class="checklist-answers-field" value="{}">
         <button type="button" class="checklist-btn btn-secondary opacity-50 cursor-not-allowed" data-action="click->report-form#openChecklist">Open Checklist</button>
         <button type="button" class="remove-row-btn" data-action="click->report-form#removeAssociation" style="margin-left: auto;">Delete</button>
       </div>
       
       <div class="form-group">
         <input type="text" placeholder="Daily notes..." name="report[placed_quantities_attributes][NEW_RECORD][notes]" class="w-full">
       </div>
    </div>
  <% end %>
</template>

<%# 5. ATTACHMENT TEMPLATE %>
<template id="attachment-template">
  <div class="gallery-card nested-fields" style="text-align: left;">
    <div style="padding: 10px; background: #f9fafb; border-bottom: 1px solid #eee;">
      <input type="file" name="report[report_attachments_attributes][NEW_RECORD][file]" class="form-control" style="width: 100%;">
    </div>
    <div style="padding: 10px;">
      <input type="text" name="report[report_attachments_attributes][NEW_RECORD][caption]" placeholder="Enter caption..." class="form-control" style="width: 100%;">
      <div style="margin-top: 5px; text-align: right;">
         <button type="button" class="remove-row-btn" data-action="click->report-form#removeAssociation" style="color: red; font-size: 0.8rem;">Remove</button>
      </div>
    </div>
  </div>
</template>

================================================================================
FILE: app/views/reports/_qa_entry_fields.html.erb
================================================================================
<div class="nested-row-container nested-fields">
  <div style="flex: 2;">
    <%= f.select :qa_type, 
        QaEntry.qa_types.keys.map { |k| [k.humanize.titleize, k] }, 
        { prompt: "Select Test..." }, 
        class: "form-control" %>
  </div>
  <div style="flex: 2;">
    <%= f.text_field :location, placeholder: "Location", class: "form-control" %>
  </div>
  <div style="flex: 1;">
    <%= f.select :result, 
        QaEntry.results.keys.map { |k| [k.humanize.gsub("Qa ", "").titleize, k] }, 
        { prompt: "Result..." }, 
        class: "form-control" %>
  </div>
  <div style="flex: 2;">
    <%= f.text_field :remarks, placeholder: "Remarks", class: "form-control" %>
  </div>
  <div style="text-align: center;">
    <% if f.object&.persisted? %>
       <div style="display:none;"><%= f.check_box :_destroy %></div>
       <button type="button" class="remove-row-btn" data-action="click->report-form#removeAssociation">âœ• Delete</button>
    <% else %>
       <button type="button" class="remove-row-btn" data-action="click->report-form#removeAssociation">âœ•</button>
    <% end %>
  </div>
</div>

================================================================================
FILE: app/views/reports/_report.html.erb
================================================================================
<div id="<%= dom_id report %>">
  <p>
    <strong>Dir number:</strong>
    <%= report.dir_number %>
  </p>

  <p>
    <strong>Inspection date:</strong>
    <%= report.inspection_date %>
  </p>

  <p>
    <strong>Inspector:</strong>
    <%= report.inspector %>
  </p>

  <p>
    <strong>Project:</strong>
    <%= report.project_id %>
  </p>

  <p>
    <strong>Phase:</strong>
    <%= report.phase_id %>
  </p>

  <p>
    <strong>Status:</strong>
    <%= report.status %>
  </p>

  <p>
    <strong>Result:</strong>
    <%= report.result %>
  </p>

</div>


================================================================================
FILE: app/views/reports/_spec_check_card.html.erb
================================================================================
<%# app/views/reports/_spec_check_card.html.erb %>
<div class="form-card" 
     data-controller="spec-drilldown" 
     data-spec-drilldown-report-id-value="<%= report.id %>">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>Specification Checklists</h2>
    <button type="button" 
            class="btn-secondary" 
            data-action="click->spec-drilldown#openModal">
      + Add Spec Checklist
    </button>
  </div>

  <%# --- 1. ACTIVE CHECKLISTS GRID --- %>
  <div id="active-checklists-list" class="gallery-grid">
    <% if report.checklist_entries.any? %>
      <% report.checklist_entries.each do |entry| %>
        <%# UPDATED: Added data-spec-id and data-answers attributes %>
        <div class="gallery-card" 
             style="padding: 15px; text-align: left;" 
             data-spec-code="<%= entry.spec_item.code %>"
             data-spec-id="<%= entry.spec_item.id %>"
             data-answers="<%= entry.checklist_answers.to_json %>">
             
          <div style="font-weight: bold; color: var(--primary); margin-bottom: 5px;">
            <%= entry.spec_item.code %>
          </div>
          <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; height: 40px; overflow: hidden;">
            <%= entry.spec_item.description %>
          </div>
          
          <%# UPDATED: Changed to an action button %>
          <button type="button" 
                  class="btn-secondary" 
                  style="width: 100%; font-size: 0.8rem;"
                  data-action="click->spec-drilldown#editSpec">
            âœŽ Edit Checklist
          </button>
        </div>
      <% end %>
    <% else %>
      <%# ... (Keep your empty state div here) ... %>
      <div class="text-muted" style="grid-column: 1 / -1; padding: 20px; text-align: center; border: 2px dashed #e5e7eb; border-radius: 8px;">
        No specification checklists added yet.
      </div>
    <% end %>
  </div>
  <%# --- 2. DATA STORE (Passed to Stimulus) --- %>
  <%# This allows the JS controller to access all specs without making 100 API calls %>
  <script id="spec-data-store" type="application/json">
    <%= SpecItem.all.select(:id, :code, :description, :division, :checklist_questions).to_json.html_safe %>
  </script>

  <%# --- 3. DRILL-DOWN MODAL --- %>
  <dialog data-spec-drilldown-target="modal" style="width: 100%; max-width: 600px; border: none; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
    
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #eee; background: #f9fafb;">
      <h3 data-spec-drilldown-target="modalTitle" style="margin: 0; font-size: 1.1rem;">Select Division</h3>
      <button type="button" class="btn-clear" style="border: none; background: none; font-size: 1.2rem; cursor: pointer;" data-action="click->spec-drilldown#closeModal">âœ•</button>
    </div>

    <div class="modal-body" style="padding: 20px; height: 60vh; overflow-y: auto;">
      
      <%# VIEW A: DIVISIONS LIST %>
      <%# This iterates over unique Divisions to create the first menu %>
      <div data-spec-drilldown-target="viewDivisions">
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <% SpecItem.select(:division).distinct.order(:division).each do |s| %>
             <button type="button" 
                     style="text-align: left; padding: 15px; background: white; border: 1px solid #eee; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between;"
                     onmouseover="this.style.borderColor='#2563eb'; this.style.background='#eff6ff';"
                     onmouseout="this.style.borderColor='#eee'; this.style.background='white';"
                     data-action="click->spec-drilldown#selectDivision"
                     data-division="<%= s.division %>">
               <strong><%= s.division %></strong>
               <span>â€º</span>
             </button>
          <% end %>
        </div>
      </div>

      <%# VIEW B: SPEC LIST (Populated by JS) %>
      <div data-spec-drilldown-target="viewSpecs" style="display: none;">
         <button type="button" class="btn-clear" style="margin-bottom: 15px;" data-action="click->spec-drilldown#showDivisions">â† Back to Divisions</button>
         <div data-spec-drilldown-target="specListContainer" style="display: flex; flex-direction: column; gap: 10px;">
           <%# JavaScript injects buttons here %>
         </div>
      </div>

      <%# VIEW C: CHECKLIST FORM (Populated by JS) %>
      <div data-spec-drilldown-target="viewForm" style="display: none;">
         <button type="button" class="btn-clear" style="margin-bottom: 15px;" data-action="click->spec-drilldown#showSpecs">â† Back to Specs</button>
         <div id="checklist-form-placeholder" data-spec-drilldown-target="checklistFormPlaceholder">
           <%# JavaScript injects the radio buttons here %>
         </div>
      </div>

    </div>
  </dialog>
</div>

================================================================================
FILE: app/views/reports/edit.html.erb
================================================================================
<h1>Editing report</h1>

<%= render "form", report: @report %>

<br>

<div>
  <%= link_to "Show this report", @report %> |
  <%= link_to "Back to reports", reports_path %>
</div>


================================================================================
FILE: app/views/reports/index.html.erb
================================================================================
<div class="dashboard-container">

  <%# --- 1. CONTEXT HEADER (The "Basket" Selector) --- %>
  <div style="background: var(--bg-card); padding: 20px 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-radius: 12px; box-shadow: var(--shadow-sm);">
    
    <div style="display: flex; align-items: center; gap: 15px;">
      <%# A. Label %>
      <div style="font-size: 0.85rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">
        Current Project
      </div>
      
      <%# B. The "Big" Dropdown %>
      <%# We use a simple form that submits on change to "set the context" %>
      <%= form_with url: reports_path, method: :get, local: true, style: "margin:0;" do |f| %>
        <%# Keep existing status/filters if possible, or reset them. Here we keep status. %>
        <%= hidden_field_tag :status, params[:status] %>
        
        <%= f.collection_select :project_id, Project.all, :id, :name, 
            { include_blank: "All Projects (Global View)", selected: params[:project_id] }, 
            { 
              onchange: "this.form.submit()", 
              style: "font-size: 1.25rem; font-weight: 600; padding: 8px 15px; border: 1px solid var(--border-color); border-radius: 6px; color: var(--primary); background: var(--bg-hover); cursor: pointer; min-width: 300px;" 
            } 
        %>
      <% end %>
    </div>

    <div class="header-actions">
      <%# C. Context-Aware Buttons %>
      <%= link_to "Export CSV", reports_path(request.query_parameters.merge(format: :csv)), class: "btn btn-secondary" %>
      
      <%# This button uses the ID from the URL params, which the dropdown above sets %>
      <%= link_to "+ New Report", new_report_path(project_id: params[:project_id]), class: "btn btn-primary", style: "margin-left: 10px;" %>
      
      <%= link_to "Directory", projects_path, class: "btn btn-clear", style: "margin-left: 5px;" %>
    </div>
  </div>

  <%# --- 2. TABS --- %>
  <div class="dashboard-tabs">
    <% statuses = ['creating', 'qc_review', 'revise', 'authorization', 'all'] %>
    <% statuses.each do |status| %>
      <%= link_to status.humanize.titleize, 
          reports_path(params.permit(:inspector, :project_id, :start_date, :end_date, :bid_item_id, :result).merge(status: status)), 
          class: "tab-link #{'active' if params[:status] == status || (params[:status].blank? && status == 'creating')}" 
      %>
    <% end %>
  </div>

  <%# --- 3. SECONDARY FILTERS (Collapsed Project Filter removed from here) --- %>
  <div class="filter-card">
    <%= form_with url: reports_path, method: :get, local: true, class: "search-form" do |form| %>
      <%= hidden_field_tag :status, params[:status] %>
      <%# Keep the project_id hidden here so searching doesn't reset the context %>
      <%= hidden_field_tag :project_id, params[:project_id] %>

      <div class="filter-grid">
        <div class="filter-group">
          <label>Date Range</label>
          <div class="date-inputs">
            <%= form.date_field :start_date, value: params[:start_date], class: "form-input" %>
            <span class="range-sep">-</span>
            <%= form.date_field :end_date, value: params[:end_date], class: "form-input" %>
          </div>
        </div>

        <div class="filter-group">
          <label>Inspector</label>
          <%= form.text_field :inspector, value: params[:inspector], placeholder: "Search email...", class: "form-input" %>
        </div>

        <div class="filter-group">
          <label>Result</label>
          <%= select_tag :result, options_for_select([['Pass', 'pass'], ['Fail', 'fail'], ['Pending', 'pending']], params[:result]), prompt: "All Results", class: "form-input" %>
        </div>

        <div class="filter-group">
          <label>Contains Item</label>
          <%# Only show Bid Items for the selected project to keep it clean %>
          <% items = params[:project_id].present? ? BidItem.where(project_id: params[:project_id]) : BidItem.all %>
          <%= form.collection_select :bid_item_id, items, :id, :code, { include_blank: "Any Item" }, { selected: params[:bid_item_id], class: "form-input" } %>
        </div>

        <div class="filter-actions">
          <%= form.submit "Search", class: "btn btn-search" %>
          <%= link_to "Clear", reports_path(status: params[:status], project_id: params[:project_id]), class: "btn btn-clear" %>
        </div>
      </div>
    <% end %>
  </div>

  <%# --- 4. TABLE (Unchanged) --- %>
  <div class="table-card">
    <table class="modern-table dashboard-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Inspector</th>
          <th>Project</th>
          <th>Phase</th>
          <th>Result</th>
          <th>Status</th>
          <th class="text-right">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if @reports.any? %>
          <% @reports.each do |report| %>
            <tr class="clickable-row">
              <td><%= report.start_date&.strftime("%b %d") %></td>
              <td class="font-medium"><%= report.user.email.split('@').first.titleize %></td>
              <td><%= report.project&.name || "-" %></td>
              <td><%= report.phase&.name || "-" %></td>
              <td>
                <% if report.result == 'pass' %>
                  <span class="text-success">Pass</span>
                <% elsif report.result == 'fail' %>
                  <span class="text-danger">Fail</span>
                <% else %>
                  <span class="text-muted">Pending</span>
                <% end %>
              </td>
              <td><span class="status-badge status-<%= report.status %>"><%= report.status&.humanize %></span></td>
              <td class="text-right"><%= link_to "View", report_path(report), class: "link-primary" %></td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="7" class="text-center py-5" style="padding: 30px; text-align: center; color: #888;">
              No reports found in this project context.
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
  
  <div class="dashboard-footer">
    Showing <%= @reports.count %> reports
  </div>
</div>

================================================================================
FILE: app/views/reports/new.html.erb
================================================================================
<h1>New report</h1>

<%= render "form", report: @report %>

<br>

<div>
  <%= link_to "Back to reports", reports_path %>
</div>


================================================================================
FILE: app/views/reports/show.html.erb
================================================================================
<div class="report-container">
  
  <%# --- NOTIFICATIONS --- %>
  <% if notice %>
    <div class="alert alert-success"><%= notice %></div>
  <% end %>
  <% if alert %>
    <div class="alert alert-danger"><%= alert %></div>
  <% end %>

  <%# --- HEADER & META DATA --- %>
  <div class="report-header">
    <div class="header-title">
      <div>
        <h1>DIR #<%= @report.dir_number %></h1>
        <span class="status-badge status-<%= @report.status %>">
          <%= @report.status&.humanize || "Unknown" %>
        </span>
      </div>
      
      <div class="actions">
        <%= link_to "Edit Report", edit_report_path(@report), class: "btn btn-secondary" %>
        <%= link_to "Export Word", export_word_report_path(@report), class: "btn btn-primary" %>
        <%= link_to "Back", reports_path, class: "btn btn-clear" %>
      </div>
    </div>
    
    <div class="meta-data-grid">
      <div class="meta-item">
        <label>Start Date</label>
        <div class="value"><%= @report.start_date&.strftime("%b %d, %Y") %></div>
      </div>
      <div class="meta-item">
        <label>End Date</label>
        <div class="value"><%= @report.end_date&.strftime("%b %d, %Y") || "-" %></div>
      </div>
      <div class="meta-item">
        <label>Inspector</label>
        <div class="value"><%= @report.user.email %></div>
      </div>
      <div class="meta-item">
        <label>Project</label>
        <div class="value"><%= @report.project&.name %></div>
      </div>
      <div class="meta-item">
        <label>Phase</label>
        <div class="value"><%= @report.phase&.name %></div>
      </div>
      <div class="meta-item">
        <label>Shift</label>
        <div class="value"><%= @report.shift_start %> - <%= @report.shift_end %></div>
      </div>
    </div>
  </div>

  <%# --- 1. WEATHER READINGS --- %>
  <div class="report-section">
    <h3>Weather Readings</h3>
    <div class="weather-grid">
      <div class="weather-col">
        <label>Start of Shift</label>
        <div><strong>Temp:</strong> <%= @report.temp_1 %>Â°F</div>
        <div><strong>Cond:</strong> <%= @report.weather_summary_1 %></div>
        <div><strong>Wind:</strong> <%= @report.wind_1 %></div>
        <div><strong>Precip:</strong> <%= @report.precip_1 %></div>
      </div>
      <div class="weather-col">
        <label>Mid Shift</label>
        <div><strong>Temp:</strong> <%= @report.temp_2 %>Â°F</div>
        <div><strong>Cond:</strong> <%= @report.weather_summary_2 %></div>
        <div><strong>Wind:</strong> <%= @report.wind_2 %></div>
        <div><strong>Precip:</strong> <%= @report.precip_2 %></div>
      </div>
      <div class="weather-col">
        <label>End of Shift</label>
        <div><strong>Temp:</strong> <%= @report.temp_3 %>Â°F</div>
        <div><strong>Cond:</strong> <%= @report.weather_summary_3 %></div>
        <div><strong>Wind:</strong> <%= @report.wind_3 %></div>
        <div><strong>Precip:</strong> <%= @report.precip_3 %></div>
      </div>
    </div>
  </div>

  <%# --- 2. SITE COMPLIANCE --- %>
  <div class="report-section">
    <h3>Site Compliance</h3>

    <% if @report.yes_deficiency? || @report.cdr? || @report.ncr? %>
      <div class="alert alert-danger" style="margin-bottom: 15px;">
        <strong>Deficiency Reported:</strong> <%= @report.deficiency_status.humanize %>
        <p style="margin-top: 5px;"><%= @report.deficiency_desc %></p>
      </div>
    <% end %>

    <% if @report.safety_yes? %>
      <div class="alert alert-danger" style="margin-bottom: 15px;">
        <strong>Safety Incident Reported</strong>
        <p style="margin-top: 5px;"><%= @report.safety_desc %></p>
      </div>
    <% end %>

    <table class="modern-table">
      <thead>
        <tr>
          <th>Category</th>
          <th>Status</th>
          <th>Category</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Traffic Control</strong></td>
          <td><%= @report.traffic_control&.humanize %></td>
          <td><strong>Environmental</strong></td>
          <td><%= @report.environmental&.humanize %></td>
        </tr>
        <tr>
          <td><strong>Security</strong></td>
          <td><%= @report.security&.humanize %></td>
          <td><strong>Air Ops</strong></td>
          <td><%= @report.air_ops_coordination&.humanize %></td>
        </tr>
        <tr>
          <td><strong>SWPPP Controls</strong></td>
          <td><%= @report.swppp_controls&.humanize %></td>
          <td></td><td></td>
        </tr>
      </tbody>
    </table>
  </div>

<%# --- NEW SECTION: SPECIFICATION CHECKLISTS --- %>
  <% if @report.checklist_entries.any? %>
    <div class="report-section">
      <h3>Specification Compliance Checklists</h3>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
        <% @report.checklist_entries.each do |entry| %>
          <div style="border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden;">
            <div style="background: var(--bg-header); padding: 10px 15px; border-bottom: 1px solid var(--border-color); font-weight: bold; display: flex; justify-content: space-between;">
              <span><%= entry.spec_item.code %></span>
              <span style="font-size: 0.8rem; font-weight: normal; color: var(--text-muted);"><%= entry.spec_item.description.truncate(30) %></span>
            </div>
            
            <table class="modern-table" style="margin: 0;">
              <tbody>
                <% entry.checklist_answers.each do |question, answer| %>
                  <tr>
                    <td style="padding: 8px 15px; font-size: 0.85rem; border-bottom: 1px solid #eee;"><%= question %></td>
                    <td style="padding: 8px 15px; font-size: 0.85rem; font-weight: bold; width: 60px; text-align: center; border-bottom: 1px solid #eee;">
                      <% if answer == "No" %>
                        <span style="color: var(--danger);"><%= answer %></span>
                      <% else %>
                         <%= answer %>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# --- 3. QUALITY ASSURANCE --- %>
  <% if @report.qa_entries.any? %>
    <div class="report-section">
      <h3>Quality Assurance</h3>
      <table class="modern-table">
        <thead>
          <tr>
            <th>Test Performed</th>
            <th>Location</th>
            <th>Result</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody>
          <% @report.qa_entries.each do |qa| %>
            <tr>
              <td><%= qa.qa_type&.humanize&.titleize %></td>
              <td><%= qa.location %></td>
              <td>
                <% if qa.result == 'qa_pass' %>
                  <span class="text-success">Pass</span>
                <% elsif qa.result == 'qa_fail' %>
                  <span class="text-danger">Fail</span>
                <% else %>
                  <%# Clean up "Qa Pending" to just "Pending" %>
                  <%= qa.result&.humanize&.gsub("Qa ", "")&.titleize %>
                <% end %>
              </td>
              <%# --- FIX IS HERE: Changed .note to .remarks --- %>
              <td><%= qa.remarks %></td> 
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>

  <%# --- 4. CREW & EQUIPMENT (UPDATED) --- %>
  <div class="report-section">
    <h3>Workforce & Equipment</h3>
    
    <%# NEW WORKFORCE TABLE %>
    <% if @report.crew_entries.any? %>
      <h4 style="margin-top:0;">Workforce Log</h4>
      <table class="modern-table" style="margin-bottom: 20px;">
        <thead>
          <tr>
            <th>Contractor</th>
            <th>Superintendent</th>
            <th>Foreman</th>
            <th class="text-center">Survey</th>
            <th class="text-center">Operator</th>
            <th class="text-center">Laborer</th>
            <th class="text-center">Electrician</th>
          </tr>
        </thead>
        <tbody>
          <% @report.crew_entries.each do |crew| %>
            <tr>
              <td class="font-bold"><%= crew.contractor %></td>
              <td><%= crew.superintendent %></td>
              <td><%= crew.foreman %></td>
              <td class="text-center"><%= crew.survey_count %></td>
              <td class="text-center"><%= crew.operator_count %></td>
              <td class="text-center"><%= crew.laborer_count %></td>
              <td class="text-center"><%= crew.electrician_count %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="text-muted-sm">No workforce recorded.</p>
    <% end %>

    <%# UPDATED EQUIPMENT TABLE %>
    <h4 style="margin-top: 15px;">Equipment Log</h4>
    <% if @report.equipment_entries.any? %>
      <table class="modern-table">
        <thead>
          <tr>
            <th>Contractor</th>
            <th>Make/Model</th>
            <th class="text-center">Qty</th>
            <th class="text-right">Hours</th>
          </tr>
        </thead>
        <tbody>
          <% @report.equipment_entries.each do |equip| %>
            <tr>
              <td><%= equip.contractor %></td>
              <td><%= equip.make_model %></td>
              <td class="text-center"><%= equip.quantity %></td>
              <td class="text-right"><%= equip.hours %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="text-muted-sm">No equipment recorded.</p>
    <% end %>
  </div>

  <%# --- 5. INSPECTION ENTRIES (FIXED: Removed Location) --- %>
  <div class="report-section">
    <h3>Quantities & Inspection Entries</h3>
    
    <% if @report.placed_quantities.any? %>
      <% @report.placed_quantities.each do |entry| %>
        <div class="nested-entry-card" style="background: white;">
          <div style="display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px;">
            <div>
              <span class="code-font" style="font-weight: bold; font-size: 1.1em;"><%= entry.bid_item&.code %></span> 
              <span style="color: #4a5568;"> - <%= entry.bid_item&.description %></span>
            </div>
            <div style="text-align: right;">
              <span style="font-weight: bold; font-size: 1.2em;"><%= entry.quantity %></span>
              <span class="text-muted" style="font-size: 0.9em;"><%= entry.bid_item&.unit %></span>
            </div>
          </div>
          
          <div style="display: block;">
            <%# FIXED: Location Removed %>
            <p style="margin-bottom: 5px;"><strong>Notes:</strong> <%= entry.notes.present? ? entry.notes : "-" %></p>

            <% if entry.checklist_answers.present? %>
              <div style="background: #f7fafc; padding: 10px; border-radius: 4px; border: 1px solid #e2e8f0; margin-top: 10px;">
                <h4 style="margin-top: 0; margin-bottom: 8px; font-size: 0.85rem; color: #4a5568; text-transform: uppercase;">Checklist Results</h4>
                <ul style="margin: 0; padding-left: 20px; font-size: 0.85rem;">
                  <% entry.checklist_answers.each do |question, answer| %>
                    <li style="margin-bottom: 4px;">
                      <span style="color: #718096;"><%= question %>:</span> 
                      <strong style="<%= answer == 'No' ? 'color: var(--danger);' : '' %>"><%= answer %></strong>
                    </li>
                  <% end %>
                </ul>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="empty-state">No quantities recorded for this report.</div>
    <% end %>
  </div>

  <%# --- 6. ADDITIONAL INFORMATION --- %>
  <% if @report.additional_activities.present? || @report.additional_info.present? || @report.commentary.present? %>
    <div class="report-section">
      <h3>Additional Information</h3>
      
      <% if @report.additional_activities.present? %>
        <div style="margin-bottom: 20px;">
          <label style="font-weight: bold; color: #718096; display: block; margin-bottom: 5px;">Additional Activities</label>
          <div style="white-space: pre-wrap; background: #f9fafb; padding: 10px; border-radius: 4px;"><%= @report.additional_activities %></div>
        </div>
      <% end %>

      <% if @report.additional_info.present? %>
        <div style="margin-bottom: 20px;">
          <label style="font-weight: bold; color: #718096; display: block; margin-bottom: 5px;">Additional Info</label>
          <div style="white-space: pre-wrap; background: #f9fafb; padding: 10px; border-radius: 4px;"><%= @report.additional_info %></div>
        </div>
      <% end %>

      <% if @report.commentary.present? %>
        <div>
          <label style="font-weight: bold; color: #718096; display: block; margin-bottom: 5px;">General Commentary</label>
          <div style="white-space: pre-wrap; background: #f9fafb; padding: 10px; border-radius: 4px;"><%= @report.commentary %></div>
        </div>
      <% end %>
    </div>
  <% end %>

  <%# --- 7. PHOTOS & DOCUMENTS --- %>
  <div class="report-section">
    <h3>Attached Documents & Photos</h3>
    
    <% if @report.report_attachments.any? %>
      <div class="gallery-grid">
        <% @report.report_attachments.each do |attach| %>
          <div class="gallery-card">
            <div class="thumbnail-area">
              <% if attach.file.attached? %>
                <% if attach.file.representable? %>
                  <%= link_to rails_blob_path(attach.file, disposition: "attachment"), target: "_blank" do %>
                    <%= image_tag attach.file.representation(resize_to_limit: [600, 600]) %>
                  <% end %>
                <% else %>
                  <%= link_to rails_blob_path(attach.file, disposition: "attachment"), target: "_blank", style: "text-decoration: none;" do %>
                    <div class="doc-icon">ðŸ“„</div>
                  <% end %>
                <% end %>
              <% end %>
            </div>
            
            <div class="caption">
              <%= attach.caption.present? ? attach.caption : attach.file.filename %>
            </div>
            
            <div class="download-link">
              <%= link_to "Download", rails_blob_path(attach.file, disposition: "attachment") %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="empty-text">No attachments found.</p>
    <% end %>
  </div>

  <%# --- 8. WORKFLOW ACTIONS --- %>
  <div class="action-bar-container">
    <% if @report.creating? || @report.revise? %>
      <div class="primary-actions">
        <%= button_to "Submit for QC Review", submit_for_qc_report_path(@report), method: :post, class: "btn btn-primary" %>
        <span class="hint-text">(Moves report to QC Tab)</span>
      </div>
    <% end %>

    <% if @report.qc_review? %>
      <div class="qc-panel">
        <div class="qc-header-row">
          <h4>QC Decision</h4>
          <%= button_to "Approve & Authorize", approve_report_path(@report), method: :post, class: "btn btn-success" %>
        </div>
        
        <div class="qc-divider"></div>
        
        <div class="qc-revision-row">
          <%= form_with url: request_revision_report_path(@report), method: :post, local: true, class: "revision-form" do |f| %>
            <label class="revision-label">Return for Revision:</label>
            <div class="input-group">
              <%= text_area_tag 'note', nil, placeholder: "Enter reason for rejection...", rows: 1, class: "form-input revision-input" %>
              <%= f.submit "Return to Inspector", class: "btn btn-danger" %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <%# --- 9. ACTIVITY LOG --- %>
  <div class="report-section">
    <h3>Activity Log</h3>
    <% if @report.activity_logs.any? %>
      <div class="activity-feed">
        <% @report.activity_logs.order(created_at: :desc).each do |log| %>
          <div class="feed-item">
            <div class="feed-user"><strong><%= log.user.email %></strong></div>
            <div class="feed-date"><%= log.created_at.strftime("%b %d, %I:%M %p") %></div>
            <div class="feed-note"><%= log.note %></div>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="empty-text">No activity recorded yet.</p>
    <% end %>
  </div>

</div>

================================================================================
FILE: config/application.rb
================================================================================
require_relative "boot"

require "rails/all"

# Require the gems listed in Gemfile, including any gems
# you've limited to :test, :development, or :production.
Bundler.require(*Rails.groups)

module InspectionCms
  class Application < Rails::Application
    # Initialize configuration defaults for originally generated Rails version.
    config.load_defaults 7.1

    # Please, add to the `ignore` list any other `lib` subdirectories that do
    # not contain `.rb` files, or that should not be reloaded or eager loaded.
    # Common ones are `templates`, `generators`, or `middleware`, for example.
    config.autoload_lib(ignore: %w(assets tasks))

    # Configuration for the application, engines, and railties goes here.
    #
    # These settings can be overridden in specific environments using the files
    # in config/environments, which are processed later.
    #
    # config.time_zone = "Central Time (US & Canada)"
    # config.eager_load_paths << Rails.root.join("extras")
  end
end


================================================================================
FILE: config/boot.rb
================================================================================
ENV["BUNDLE_GEMFILE"] ||= File.expand_path("../Gemfile", __dir__)

require "bundler/setup" # Set up gems listed in the Gemfile.
require "bootsnap/setup" # Speed up boot time by caching expensive operations.


================================================================================
FILE: config/cable.yml
================================================================================
development:
  adapter: async

test:
  adapter: test

production:
  adapter: redis
  url: <%= ENV.fetch("REDIS_URL") { "redis://localhost:6379/1" } %>
  channel_prefix: inspection_cms_production


================================================================================
FILE: config/database.yml
================================================================================
# PostgreSQL. Versions 9.3 and up are supported.
#
# Install the pg driver:
#   gem install pg
# On macOS with Homebrew:
#   gem install pg -- --with-pg-config=/usr/local/bin/pg_config
# On Windows:
#   gem install pg
#       Choose the win32 build.
#       Install PostgreSQL and put its /bin directory on your path.
#
# Configure Using Gemfile
# gem "pg"
#
default: &default
  adapter: postgresql
  encoding: unicode
  # For details on connection pooling, see Rails configuration guide
  # https://guides.rubyonrails.org/configuring.html#database-pooling
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>

development:
  <<: *default
  database: inspection_cms_development

  # The specified database role being used to connect to PostgreSQL.
  # To create additional roles in PostgreSQL see `$ createuser --help`.
  # When left blank, PostgreSQL will use the default role. This is
  # the same name as the operating system user running Rails.
  #username: inspection_cms

  # The password associated with the PostgreSQL role (username).
  #password:

  # Connect on a TCP socket. Omitted by default since the client uses a
  # domain socket that doesn't need configuration. Windows does not have
  # domain sockets, so uncomment these lines.
  #host: localhost

  # The TCP port the server listens on. Defaults to 5432.
  # If your server runs on a different port number, change accordingly.
  #port: 5432

  # Schema search path. The server defaults to $user,public
  #schema_search_path: myapp,sharedapp,public

  # Minimum log levels, in increasing order:
  #   debug5, debug4, debug3, debug2, debug1,
  #   log, notice, warning, error, fatal, and panic
  # Defaults to warning.
  #min_messages: notice

# Warning: The database defined as "test" will be erased and
# re-generated from your development database when you run "rake".
# Do not set this db to the same as development or production.
test:
  <<: *default
  database: inspection_cms_test

# As with config/credentials.yml, you never want to store sensitive information,
# like your database password, in your source code. If your source code is
# ever seen by anyone, they now have access to your database.
#
# Instead, provide the password or a full connection URL as an environment
# variable when you boot the app. For example:
#
#   DATABASE_URL="postgres://myuser:mypass@localhost/somedatabase"
#
# If the connection URL is provided in the special DATABASE_URL environment
# variable, Rails will automatically merge its configuration values on top of
# the values provided in this file. Alternatively, you can specify a connection
# URL environment variable explicitly:
#
#   production:
#     url: <%= ENV["MY_APP_DATABASE_URL"] %>
#
# Read https://guides.rubyonrails.org/configuring.html#configuring-a-database
# for a full overview on how database connection configuration can be specified.
#
production:
  <<: *default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>
  url:  <%= ENV["DATABASE_URL"] %>


================================================================================
FILE: config/environment.rb
================================================================================
# Load the Rails application.
require_relative "application"

# Initialize the Rails application.
Rails.application.initialize!


================================================================================
FILE: config/environments/development.rb
================================================================================
require "active_support/core_ext/integer/time"

Rails.application.configure do
  # Settings specified here will take precedence over those in config/application.rb.

  # In the development environment your application's code is reloaded any time
  # it changes. This slows down response time but is perfect for development
  # since you don't have to restart the web server when you make code changes.
  config.enable_reloading = true
# Allow ngrok traffic
  config.hosts << /.*\.ngrok-free\.app/
  # Do not eager load code on boot.
  config.eager_load = false

  # Show full error reports.
  config.consider_all_requests_local = true

  # Enable server timing
  config.server_timing = true

  # Enable/disable caching. By default caching is disabled.
  # Run rails dev:cache to toggle caching.
  if Rails.root.join("tmp/caching-dev.txt").exist?
    config.action_controller.perform_caching = true
    config.action_controller.enable_fragment_cache_logging = true

    config.cache_store = :memory_store
    config.public_file_server.headers = {
      "Cache-Control" => "public, max-age=#{2.days.to_i}"
    }
  else
    config.action_controller.perform_caching = false

    config.cache_store = :null_store
  end

  # Store uploaded files on the local file system (see config/storage.yml for options).
  config.active_storage.service = :local

  # Don't care if the mailer can't send.
  config.action_mailer.raise_delivery_errors = false

  config.action_mailer.perform_caching = false

  config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }

  # Print deprecation notices to the Rails logger.
  config.active_support.deprecation = :log

  # Raise exceptions for disallowed deprecations.
  config.active_support.disallowed_deprecation = :raise

  # Tell Active Support which deprecation messages to disallow.
  config.active_support.disallowed_deprecation_warnings = []

  # Raise an error on page load if there are pending migrations.
  config.active_record.migration_error = :page_load

  # Highlight code that triggered database queries in logs.
  config.active_record.verbose_query_logs = true

  # Highlight code that enqueued background job in logs.
  config.active_job.verbose_enqueue_logs = true

  # Suppress logger output for asset requests.
  config.assets.quiet = true

  # Raises error for missing translations.
  # config.i18n.raise_on_missing_translations = true

  # Annotate rendered view with file names.
  # config.action_view.annotate_rendered_view_with_filenames = true

  # Uncomment if you wish to allow Action Cable access from any origin.
  # config.action_cable.disable_request_forgery_protection = true

  # Raise error when a before_action's only/except options reference missing actions
  config.action_controller.raise_on_missing_callback_actions = true
end


================================================================================
FILE: config/environments/production.rb
================================================================================
require "active_support/core_ext/integer/time"

Rails.application.configure do
  # Settings specified here will take precedence over those in config/application.rb.

  # Code is not reloaded between requests.
  config.enable_reloading = false

  # Eager load code on boot. This eager loads most of Rails and
  # your application in memory, allowing both threaded web servers
  # and those relying on copy on write to perform better.
  # Rake tasks automatically ignore this option for performance.
  config.eager_load = true

  # Full error reports are disabled and caching is turned on.
  config.consider_all_requests_local = false
  config.action_controller.perform_caching = true

  # Ensures that a master key has been made available in ENV["RAILS_MASTER_KEY"], config/master.key, or an environment
  # key such as config/credentials/production.key. This key is used to decrypt credentials (and other encrypted files).
  # config.require_master_key = true

  # Disable serving static files from `public/`, relying on NGINX/Apache to do so instead.
  # config.public_file_server.enabled = false

  # Compress CSS using a preprocessor.
  # config.assets.css_compressor = :sass

  # Do not fall back to assets pipeline if a precompiled asset is missed.
  config.assets.compile = false

  # Enable serving of images, stylesheets, and JavaScripts from an asset server.
  # config.asset_host = "http://assets.example.com"

  # Specifies the header that your server uses for sending files.
  # config.action_dispatch.x_sendfile_header = "X-Sendfile" # for Apache
  # config.action_dispatch.x_sendfile_header = "X-Accel-Redirect" # for NGINX

  # Store uploaded files on the local file system (see config/storage.yml for options).
  config.active_storage.service = :local

  # Mount Action Cable outside main process or domain.
  # config.action_cable.mount_path = nil
  # config.action_cable.url = "wss://example.com/cable"
  # config.action_cable.allowed_request_origins = [ "http://example.com", /http:\/\/example.*/ ]

  # Assume all access to the app is happening through a SSL-terminating reverse proxy.
  # Can be used together with config.force_ssl for Strict-Transport-Security and secure cookies.
  # config.assume_ssl = true

  # Force all access to the app over SSL, use Strict-Transport-Security, and use secure cookies.
  config.force_ssl = true

  # Log to STDOUT by default
  config.logger = ActiveSupport::Logger.new(STDOUT)
    .tap  { |logger| logger.formatter = ::Logger::Formatter.new }
    .then { |logger| ActiveSupport::TaggedLogging.new(logger) }

  # Prepend all log lines with the following tags.
  config.log_tags = [ :request_id ]

  # "info" includes generic and useful information about system operation, but avoids logging too much
  # information to avoid inadvertent exposure of personally identifiable information (PII). If you
  # want to log everything, set the level to "debug".
  config.log_level = ENV.fetch("RAILS_LOG_LEVEL", "info")

  # Use a different cache store in production.
  # config.cache_store = :mem_cache_store

  # Use a real queuing backend for Active Job (and separate queues per environment).
  # config.active_job.queue_adapter = :resque
  # config.active_job.queue_name_prefix = "inspection_cms_production"

  config.action_mailer.perform_caching = false

  # Ignore bad email addresses and do not raise email delivery errors.
  # Set this to true and configure the email server for immediate delivery to raise delivery errors.
  # config.action_mailer.raise_delivery_errors = false

  # Enable locale fallbacks for I18n (makes lookups for any locale fall back to
  # the I18n.default_locale when a translation cannot be found).
  config.i18n.fallbacks = true

  # Don't log any deprecations.
  config.active_support.report_deprecations = false

  # Do not dump schema after migrations.
  config.active_record.dump_schema_after_migration = false

  # Enable DNS rebinding protection and other `Host` header attacks.
  # config.hosts = [
  #   "example.com",     # Allow requests from example.com
  #   /.*\.example\.com/ # Allow requests from subdomains like `www.example.com`
  # ]
  # Skip DNS rebinding protection for the default health check endpoint.
  # config.host_authorization = { exclude: ->(request) { request.path == "/up" } }
end


================================================================================
FILE: config/environments/test.rb
================================================================================
require "active_support/core_ext/integer/time"

# The test environment is used exclusively to run your application's
# test suite. You never need to work with it otherwise. Remember that
# your test database is "scratch space" for the test suite and is wiped
# and recreated between test runs. Don't rely on the data there!

Rails.application.configure do
  # Settings specified here will take precedence over those in config/application.rb.

  # While tests run files are not watched, reloading is not necessary.
  config.enable_reloading = false

  # Eager loading loads your entire application. When running a single test locally,
  # this is usually not necessary, and can slow down your test suite. However, it's
  # recommended that you enable it in continuous integration systems to ensure eager
  # loading is working properly before deploying your code.
  config.eager_load = ENV["CI"].present?

  # Configure public file server for tests with Cache-Control for performance.
  config.public_file_server.enabled = true
  config.public_file_server.headers = {
    "Cache-Control" => "public, max-age=#{1.hour.to_i}"
  }

  # Show full error reports and disable caching.
  config.consider_all_requests_local = true
  config.action_controller.perform_caching = false
  config.cache_store = :null_store

  # Render exception templates for rescuable exceptions and raise for other exceptions.
  config.action_dispatch.show_exceptions = :rescuable

  # Disable request forgery protection in test environment.
  config.action_controller.allow_forgery_protection = false

  # Store uploaded files on the local file system in a temporary directory.
  config.active_storage.service = :test

  config.action_mailer.perform_caching = false

  # Tell Action Mailer not to deliver emails to the real world.
  # The :test delivery method accumulates sent emails in the
  # ActionMailer::Base.deliveries array.
  config.action_mailer.delivery_method = :test

  # Print deprecation notices to the stderr.
  config.active_support.deprecation = :stderr

  # Raise exceptions for disallowed deprecations.
  config.active_support.disallowed_deprecation = :raise

  # Tell Active Support which deprecation messages to disallow.
  config.active_support.disallowed_deprecation_warnings = []

  # Raises error for missing translations.
  # config.i18n.raise_on_missing_translations = true

  # Annotate rendered view with file names.
  # config.action_view.annotate_rendered_view_with_filenames = true

  # Raise error when a before_action's only/except options reference missing actions
  config.action_controller.raise_on_missing_callback_actions = true
end


================================================================================
FILE: config/importmap.rb
================================================================================
# Pin npm packages by running ./bin/importmap

pin "application"
pin "@hotwired/turbo-rails", to: "turbo.min.js"
pin "@hotwired/stimulus", to: "stimulus.min.js"
pin "@hotwired/stimulus-loading", to: "stimulus-loading.js"
pin_all_from "app/javascript/controllers", under: "controllers"


================================================================================
FILE: config/initializers/assets.rb
================================================================================
# Be sure to restart your server when you modify this file.

# Version of your assets, change this if you want to expire all your assets.
Rails.application.config.assets.version = "1.0"

# Add additional assets to the asset load path.
# Rails.application.config.assets.paths << Emoji.images_path

# Precompile additional assets.
# application.js, application.css, and all non-JS/CSS in the app/assets
# folder are already added.
# Rails.application.config.assets.precompile += %w( admin.js admin.css )


================================================================================
FILE: config/initializers/content_security_policy.rb
================================================================================
# Be sure to restart your server when you modify this file.

# Define an application-wide content security policy.
# See the Securing Rails Applications Guide for more information:
# https://guides.rubyonrails.org/security.html#content-security-policy-header

# Rails.application.configure do
#   config.content_security_policy do |policy|
#     policy.default_src :self, :https
#     policy.font_src    :self, :https, :data
#     policy.img_src     :self, :https, :data
#     policy.object_src  :none
#     policy.script_src  :self, :https
#     policy.style_src   :self, :https
#     # Specify URI for violation reports
#     # policy.report_uri "/csp-violation-report-endpoint"
#   end
#
#   # Generate session nonces for permitted importmap, inline scripts, and inline styles.
#   config.content_security_policy_nonce_generator = ->(request) { request.session.id.to_s }
#   config.content_security_policy_nonce_directives = %w(script-src style-src)
#
#   # Report violations without enforcing the policy.
#   # config.content_security_policy_report_only = true
# end


================================================================================
FILE: config/initializers/devise.rb
================================================================================
# frozen_string_literal: true

# Assuming you have not yet modified this file, each configuration option below
# is set to its default value. Note that some are commented out while others
# are not: uncommented lines are intended to protect your configuration from
# breaking changes in upgrades (i.e., in the event that future versions of
# Devise change the default values for those options).
#
# Use this hook to configure devise mailer, warden hooks and so forth.
# Many of these configuration options can be set straight in your model.
Devise.setup do |config|
  # The secret key used by Devise. Devise uses this key to generate
  # random tokens. Changing this key will render invalid all existing
  # confirmation, reset password and unlock tokens in the database.
  # Devise will use the `secret_key_base` as its `secret_key`
  # by default. You can change it below and use your own secret key.
  # config.secret_key = '9c58c7513a0a336aa747355a35ebe4194de3ef0bea4ede8317c397b7bb3775845e6858e4e437ca3c8ad1c8546a694d31d17cfa22c0eacc003cfbfa256e88365f'

  # ==> Controller configuration
  # Configure the parent class to the devise controllers.
  # config.parent_controller = 'DeviseController'

  # ==> Mailer Configuration
  # Configure the e-mail address which will be shown in Devise::Mailer,
  # note that it will be overwritten if you use your own mailer class
  # with default "from" parameter.
  config.mailer_sender = 'please-change-me-at-config-initializers-devise@example.com'

  # Configure the class responsible to send e-mails.
  # config.mailer = 'Devise::Mailer'

  # Configure the parent class responsible to send e-mails.
  # config.parent_mailer = 'ActionMailer::Base'

  # ==> ORM configuration
  # Load and configure the ORM. Supports :active_record (default) and
  # :mongoid (bson_ext recommended) by default. Other ORMs may be
  # available as additional gems.
  require 'devise/orm/active_record'

  # ==> Configuration for any authentication mechanism
  # Configure which keys are used when authenticating a user. The default is
  # just :email. You can configure it to use [:username, :subdomain], so for
  # authenticating a user, both parameters are required. Remember that those
  # parameters are used only when authenticating and not when retrieving from
  # session. If you need permissions, you should implement that in a before filter.
  # You can also supply a hash where the value is a boolean determining whether
  # or not authentication should be aborted when the value is not present.
  # config.authentication_keys = [:email]

  # Configure parameters from the request object used for authentication. Each entry
  # given should be a request method and it will automatically be passed to the
  # find_for_authentication method and considered in your model lookup. For instance,
  # if you set :request_keys to [:subdomain], :subdomain will be used on authentication.
  # The same considerations mentioned for authentication_keys also apply to request_keys.
  # config.request_keys = []

  # Configure which authentication keys should be case-insensitive.
  # These keys will be downcased upon creating or modifying a user and when used
  # to authenticate or find a user. Default is :email.
  config.case_insensitive_keys = [:email]

  # Configure which authentication keys should have whitespace stripped.
  # These keys will have whitespace before and after removed upon creating or
  # modifying a user and when used to authenticate or find a user. Default is :email.
  config.strip_whitespace_keys = [:email]

  # Tell if authentication through request.params is enabled. True by default.
  # It can be set to an array that will enable params authentication only for the
  # given strategies, for example, `config.params_authenticatable = [:database]` will
  # enable it only for database (email + password) authentication.
  # config.params_authenticatable = true

  # Tell if authentication through HTTP Auth is enabled. False by default.
  # It can be set to an array that will enable http authentication only for the
  # given strategies, for example, `config.http_authenticatable = [:database]` will
  # enable it only for database authentication.
  # For API-only applications to support authentication "out-of-the-box", you will likely want to
  # enable this with :database unless you are using a custom strategy.
  # The supported strategies are:
  # :database      = Support basic authentication with authentication key + password
  # config.http_authenticatable = false

  # If 401 status code should be returned for AJAX requests. True by default.
  # config.http_authenticatable_on_xhr = true

  # The realm used in Http Basic Authentication. 'Application' by default.
  # config.http_authentication_realm = 'Application'

  # It will change confirmation, password recovery and other workflows
  # to behave the same regardless if the e-mail provided was right or wrong.
  # Does not affect registerable.
  # config.paranoid = true

  # By default Devise will store the user in session. You can skip storage for
  # particular strategies by setting this option.
  # Notice that if you are skipping storage for all authentication paths, you
  # may want to disable generating routes to Devise's sessions controller by
  # passing skip: :sessions to `devise_for` in your config/routes.rb
  config.skip_session_storage = [:http_auth]

  # By default, Devise cleans up the CSRF token on authentication to
  # avoid CSRF token fixation attacks. This means that, when using AJAX
  # requests for sign in and sign up, you need to get a new CSRF token
  # from the server. You can disable this option at your own risk.
  # config.clean_up_csrf_token_on_authentication = true

  # When false, Devise will not attempt to reload routes on eager load.
  # This can reduce the time taken to boot the app but if your application
  # requires the Devise mappings to be loaded during boot time the application
  # won't boot properly.
  # config.reload_routes = true

  # ==> Configuration for :database_authenticatable
  # For bcrypt, this is the cost for hashing the password and defaults to 12. If
  # using other algorithms, it sets how many times you want the password to be hashed.
  # The number of stretches used for generating the hashed password are stored
  # with the hashed password. This allows you to change the stretches without
  # invalidating existing passwords.
  #
  # Limiting the stretches to just one in testing will increase the performance of
  # your test suite dramatically. However, it is STRONGLY RECOMMENDED to not use
  # a value less than 10 in other environments. Note that, for bcrypt (the default
  # algorithm), the cost increases exponentially with the number of stretches (e.g.
  # a value of 20 is already extremely slow: approx. 60 seconds for 1 calculation).
  config.stretches = Rails.env.test? ? 1 : 12

  # Set up a pepper to generate the hashed password.
  # config.pepper = '63c8cdc98c03e24e77d2233f027c75470ecc6096bc4e851180b3561710da9eea1d4cdfd359928331460e1ea31beffb7c3f07cf3985d9df36240d9c8c5d7807d0'

  # Send a notification to the original email when the user's email is changed.
  # config.send_email_changed_notification = false

  # Send a notification email when the user's password is changed.
  # config.send_password_change_notification = false

  # ==> Configuration for :confirmable
  # A period that the user is allowed to access the website even without
  # confirming their account. For instance, if set to 2.days, the user will be
  # able to access the website for two days without confirming their account,
  # access will be blocked just in the third day.
  # You can also set it to nil, which will allow the user to access the website
  # without confirming their account.
  # Default is 0.days, meaning the user cannot access the website without
  # confirming their account.
  # config.allow_unconfirmed_access_for = 2.days

  # A period that the user is allowed to confirm their account before their
  # token becomes invalid. For example, if set to 3.days, the user can confirm
  # their account within 3 days after the mail was sent, but on the fourth day
  # their account can't be confirmed with the token any more.
  # Default is nil, meaning there is no restriction on how long a user can take
  # before confirming their account.
  # config.confirm_within = 3.days

  # If true, requires any email changes to be confirmed (exactly the same way as
  # initial account confirmation) to be applied. Requires additional unconfirmed_email
  # db field (see migrations). Until confirmed, new email is stored in
  # unconfirmed_email column, and copied to email column on successful confirmation.
  config.reconfirmable = true

  # Defines which key will be used when confirming an account
  # config.confirmation_keys = [:email]

  # ==> Configuration for :rememberable
  # The time the user will be remembered without asking for credentials again.
  # config.remember_for = 2.weeks

  # Invalidates all the remember me tokens when the user signs out.
  config.expire_all_remember_me_on_sign_out = true

  # If true, extends the user's remember period when remembered via cookie.
  # config.extend_remember_period = false

  # Options to be passed to the created cookie. For instance, you can set
  # secure: true in order to force SSL only cookies.
  # config.rememberable_options = {}

  # ==> Configuration for :validatable
  # Range for password length.
  config.password_length = 6..128

  # Email regex used to validate email formats. It simply asserts that
  # one (and only one) @ exists in the given string. This is mainly
  # to give user feedback and not to assert the e-mail validity.
  config.email_regexp = /\A[^@\s]+@[^@\s]+\z/

  # ==> Configuration for :timeoutable
  # The time you want to timeout the user session without activity. After this
  # time the user will be asked for credentials again. Default is 30 minutes.
  # config.timeout_in = 30.minutes

  # ==> Configuration for :lockable
  # Defines which strategy will be used to lock an account.
  # :failed_attempts = Locks an account after a number of failed attempts to sign in.
  # :none            = No lock strategy. You should handle locking by yourself.
  # config.lock_strategy = :failed_attempts

  # Defines which key will be used when locking and unlocking an account
  # config.unlock_keys = [:email]

  # Defines which strategy will be used to unlock an account.
  # :email = Sends an unlock link to the user email
  # :time  = Re-enables login after a certain amount of time (see :unlock_in below)
  # :both  = Enables both strategies
  # :none  = No unlock strategy. You should handle unlocking by yourself.
  # config.unlock_strategy = :both

  # Number of authentication tries before locking an account if lock_strategy
  # is failed attempts.
  # config.maximum_attempts = 20

  # Time interval to unlock the account if :time is enabled as unlock_strategy.
  # config.unlock_in = 1.hour

  # Warn on the last attempt before the account is locked.
  # config.last_attempt_warning = true

  # ==> Configuration for :recoverable
  #
  # Defines which key will be used when recovering the password for an account
  # config.reset_password_keys = [:email]

  # Time interval you can reset your password with a reset password key.
  # Don't put a too small interval or your users won't have the time to
  # change their passwords.
  config.reset_password_within = 6.hours

  # When set to false, does not sign a user in automatically after their password is
  # reset. Defaults to true, so a user is signed in automatically after a reset.
  # config.sign_in_after_reset_password = true

  # ==> Configuration for :encryptable
  # Allow you to use another hashing or encryption algorithm besides bcrypt (default).
  # You can use :sha1, :sha512 or algorithms from others authentication tools as
  # :clearance_sha1, :authlogic_sha512 (then you should set stretches above to 20
  # for default behavior) and :restful_authentication_sha1 (then you should set
  # stretches to 10, and copy REST_AUTH_SITE_KEY to pepper).
  #
  # Require the `devise-encryptable` gem when using anything other than bcrypt
  # config.encryptor = :sha512

  # ==> Scopes configuration
  # Turn scoped views on. Before rendering "sessions/new", it will first check for
  # "users/sessions/new". It's turned off by default because it's slower if you
  # are using only default views.
  # config.scoped_views = false

  # Configure the default scope given to Warden. By default it's the first
  # devise role declared in your routes (usually :user).
  # config.default_scope = :user

  # Set this configuration to false if you want /users/sign_out to sign out
  # only the current scope. By default, Devise signs out all scopes.
  # config.sign_out_all_scopes = true

  # ==> Navigation configuration
  # Lists the formats that should be treated as navigational. Formats like
  # :html should redirect to the sign in page when the user does not have
  # access, but formats like :xml or :json, should return 401.
  #
  # If you have any extra navigational formats, like :iphone or :mobile, you
  # should add them to the navigational formats lists.
  #
  # The "*/*" below is required to match Internet Explorer requests.
  # config.navigational_formats = ['*/*', :html, :turbo_stream]

  # The default HTTP method used to sign out a resource. Default is :delete.
  config.sign_out_via = :delete

  # ==> OmniAuth
  # Add a new OmniAuth provider. Check the wiki for more information on setting
  # up on your models and hooks.
  # config.omniauth :github, 'APP_ID', 'APP_SECRET', scope: 'user,public_repo'

  # ==> Warden configuration
  # If you want to use other strategies, that are not supported by Devise, or
  # change the failure app, you can configure them inside the config.warden block.
  #
  # config.warden do |manager|
  #   manager.intercept_401 = false
  #   manager.default_strategies(scope: :user).unshift :some_external_strategy
  # end

  # ==> Mountable engine configurations
  # When using Devise inside an engine, let's call it `MyEngine`, and this engine
  # is mountable, there are some extra configurations to be taken into account.
  # The following options are available, assuming the engine is mounted as:
  #
  #     mount MyEngine, at: '/my_engine'
  #
  # The router that invoked `devise_for`, in the example above, would be:
  # config.router_name = :my_engine
  #
  # When using OmniAuth, Devise cannot automatically set OmniAuth path,
  # so you need to do it manually. For the users scope, it would be:
  # config.omniauth_path_prefix = '/my_engine/users/auth'

  # ==> Hotwire/Turbo configuration
  # When using Devise with Hotwire/Turbo, the http status for error responses
  # and some redirects must match the following. The default in Devise for existing
  # apps is `200 OK` and `302 Found` respectively, but new apps are generated with
  # these new defaults that match Hotwire/Turbo behavior.
  # Note: These might become the new default in future versions of Devise.
  config.responder.error_status = :unprocessable_entity
  config.responder.redirect_status = :see_other

  # ==> Configuration for :registerable

  # When set to false, does not sign a user in automatically after their password is
  # changed. Defaults to true, so a user is signed in automatically after changing a password.
  # config.sign_in_after_change_password = true
end


================================================================================
FILE: config/initializers/inflections.rb
================================================================================
# Be sure to restart your server when you modify this file.

# Add new inflection rules using the following format. Inflections
# are locale specific, and you may define rules for as many different
# locales as you wish. All of these examples are active by default:
# ActiveSupport::Inflector.inflections(:en) do |inflect|
#   inflect.plural /^(ox)$/i, "\\1en"
#   inflect.singular /^(ox)en/i, "\\1"
#   inflect.irregular "person", "people"
#   inflect.uncountable %w( fish sheep )
# end

# These inflection rules are supported but not enabled by default:
# ActiveSupport::Inflector.inflections(:en) do |inflect|
#   inflect.acronym "RESTful"
# end


================================================================================
FILE: config/initializers/mime_types.rb
================================================================================
Mime::Type.register "application/vnd.openxmlformats-officedocument.wordprocessingml.document", :docx

================================================================================
FILE: config/initializers/permissions_policy.rb
================================================================================
# Be sure to restart your server when you modify this file.

# Define an application-wide HTTP permissions policy. For further
# information see: https://developers.google.com/web/updates/2018/06/feature-policy

# Rails.application.config.permissions_policy do |policy|
#   policy.camera      :none
#   policy.gyroscope   :none
#   policy.microphone  :none
#   policy.usb         :none
#   policy.fullscreen  :self
#   policy.payment     :self, "https://secure.example.com"
# end


================================================================================
FILE: config/locales/devise.en.yml
================================================================================
# Additional translations at https://github.com/heartcombo/devise/wiki/I18n

en:
  devise:
    confirmations:
      confirmed: "Your email address has been successfully confirmed."
      send_instructions: "You will receive an email with instructions for how to confirm your email address in a few minutes."
      send_paranoid_instructions: "If your email address exists in our database, you will receive an email with instructions for how to confirm your email address in a few minutes."
    failure:
      already_authenticated: "You are already signed in."
      inactive: "Your account is not activated yet."
      invalid: "Invalid %{authentication_keys} or password."
      locked: "Your account is locked."
      last_attempt: "You have one more attempt before your account is locked."
      not_found_in_database: "Invalid %{authentication_keys} or password."
      timeout: "Your session expired. Please sign in again to continue."
      unauthenticated: "You need to sign in or sign up before continuing."
      unconfirmed: "You have to confirm your email address before continuing."
    mailer:
      confirmation_instructions:
        subject: "Confirmation instructions"
      reset_password_instructions:
        subject: "Reset password instructions"
      unlock_instructions:
        subject: "Unlock instructions"
      email_changed:
        subject: "Email Changed"
      password_change:
        subject: "Password Changed"
    omniauth_callbacks:
      failure: "Could not authenticate you from %{kind} because \"%{reason}\"."
      success: "Successfully authenticated from %{kind} account."
    passwords:
      no_token: "You can't access this page without coming from a password reset email. If you do come from a password reset email, please make sure you used the full URL provided."
      send_instructions: "You will receive an email with instructions on how to reset your password in a few minutes."
      send_paranoid_instructions: "If your email address exists in our database, you will receive a password recovery link at your email address in a few minutes."
      updated: "Your password has been changed successfully. You are now signed in."
      updated_not_active: "Your password has been changed successfully."
    registrations:
      destroyed: "Bye! Your account has been successfully cancelled. We hope to see you again soon."
      signed_up: "Welcome! You have signed up successfully."
      signed_up_but_inactive: "You have signed up successfully. However, we could not sign you in because your account is not yet activated."
      signed_up_but_locked: "You have signed up successfully. However, we could not sign you in because your account is locked."
      signed_up_but_unconfirmed: "A message with a confirmation link has been sent to your email address. Please follow the link to activate your account."
      update_needs_confirmation: "You updated your account successfully, but we need to verify your new email address. Please check your email and follow the confirmation link to confirm your new email address."
      updated: "Your account has been updated successfully."
      updated_but_not_signed_in: "Your account has been updated successfully, but since your password was changed, you need to sign in again."
    sessions:
      signed_in: "Signed in successfully."
      signed_out: "Signed out successfully."
      already_signed_out: "Signed out successfully."
    unlocks:
      send_instructions: "You will receive an email with instructions for how to unlock your account in a few minutes."
      send_paranoid_instructions: "If your account exists, you will receive an email with instructions for how to unlock it in a few minutes."
      unlocked: "Your account has been unlocked successfully. Please sign in to continue."
  errors:
    messages:
      already_confirmed: "was already confirmed, please try signing in"
      confirmation_period_expired: "needs to be confirmed within %{period}, please request a new one"
      expired: "has expired, please request a new one"
      not_found: "not found"
      not_locked: "was not locked"
      not_saved:
        one: "1 error prohibited this %{resource} from being saved:"
        other: "%{count} errors prohibited this %{resource} from being saved:"


================================================================================
FILE: config/locales/en.yml
================================================================================
# Files in the config/locales directory are used for internationalization and
# are automatically loaded by Rails. If you want to use locales other than
# English, add the necessary files in this directory.
#
# To use the locales, use `I18n.t`:
#
#     I18n.t "hello"
#
# In views, this is aliased to just `t`:
#
#     <%= t("hello") %>
#
# To use a different locale, set it with `I18n.locale`:
#
#     I18n.locale = :es
#
# This would use the information in config/locales/es.yml.
#
# To learn more about the API, please read the Rails Internationalization guide
# at https://guides.rubyonrails.org/i18n.html.
#
# Be aware that YAML interprets the following case-insensitive strings as
# booleans: `true`, `false`, `on`, `off`, `yes`, `no`. Therefore, these strings
# must be quoted to be interpreted as strings. For example:
#
#     en:
#       "yes": yup
#       enabled: "ON"

en:
  hello: "Hello world"


================================================================================
FILE: config/puma.rb
================================================================================
# This configuration file will be evaluated by Puma. The top-level methods that
# are invoked here are part of Puma's configuration DSL. For more information
# about methods provided by the DSL, see https://puma.io/puma/Puma/DSL.html.

# Puma can serve each request in a thread from an internal thread pool.
# The `threads` method setting takes two numbers: a minimum and maximum.
# Any libraries that use thread pools should be configured to match
# the maximum value specified for Puma. Default is set to 5 threads for minimum
# and maximum; this matches the default thread size of Active Record.
max_threads_count = ENV.fetch("RAILS_MAX_THREADS") { 5 }
min_threads_count = ENV.fetch("RAILS_MIN_THREADS") { max_threads_count }
threads min_threads_count, max_threads_count

# Specifies that the worker count should equal the number of processors in production.
if ENV["RAILS_ENV"] == "production"
  require "concurrent-ruby"
  worker_count = Integer(ENV.fetch("WEB_CONCURRENCY") { Concurrent.physical_processor_count })
  workers worker_count if worker_count > 1
end

# Specifies the `worker_timeout` threshold that Puma will use to wait before
# terminating a worker in development environments.
worker_timeout 3600 if ENV.fetch("RAILS_ENV", "development") == "development"

# Specifies the `port` that Puma will listen on to receive requests; default is 3000.
port ENV.fetch("PORT") { 3000 }

# Specifies the `environment` that Puma will run in.
environment ENV.fetch("RAILS_ENV") { "development" }

# Specifies the `pidfile` that Puma will use.
pidfile ENV.fetch("PIDFILE") { "tmp/pids/server.pid" }

# Allow puma to be restarted by `bin/rails restart` command.
plugin :tmp_restart


================================================================================
FILE: config/routes.rb
================================================================================
# config/routes.rb
Rails.application.routes.draw do
  devise_for :users
  
  resources :reports do
    resources :checklist_entries, only: [:create, :update] 
    member do
      post :submit_for_qc
      post :approve
      post :request_revision
      get  :export_word  
    end
  end

  # --- MAESTRO CHANGE: Nest Bid Items under Projects ---
  resources :projects do
    resources :bid_items # URL: /projects/1/bid_items/new
  end
  
  resources :phases
  
 

  root "reports#index"
end

================================================================================
FILE: db/migrate/20260108000000_init_schema.rb
================================================================================
class InitSchema < ActiveRecord::Migration[7.1]
  def change
    # --- 1. ENABLE EXTENSIONS ---
    enable_extension "plpgsql"

    # --- 2. ACTIVE STORAGE (File Uploads) ---
    create_table "active_storage_blobs", force: :cascade do |t|
      t.string "key", null: false
      t.string "filename", null: false
      t.string "content_type"
      t.text "metadata"
      t.string "service_name", null: false
      t.bigint "byte_size", null: false
      t.string "checksum"
      t.datetime "created_at", null: false
      t.index ["key"], name: "index_active_storage_blobs_on_key", unique: true
    end

    create_table "active_storage_attachments", force: :cascade do |t|
      t.string "name", null: false
      t.string "record_type", null: false
      t.bigint "record_id", null: false
      t.bigint "blob_id", null: false
      t.datetime "created_at", null: false
      t.index ["blob_id"], name: "index_active_storage_attachments_on_blob_id"
      t.index ["record_type", "record_id", "name", "blob_id"], name: "index_active_storage_attachments_uniqueness", unique: true
    end

    create_table "active_storage_variant_records", force: :cascade do |t|
      t.bigint "blob_id", null: false
      t.string "variation_digest", null: false
      t.index ["blob_id", "variation_digest"], name: "index_active_storage_variant_records_uniqueness", unique: true
    end

    # --- 3. USERS (Devise) ---
    create_table "users", force: :cascade do |t|
      t.string "email", default: "", null: false
      t.string "encrypted_password", default: "", null: false
      t.string "reset_password_token"
      t.datetime "reset_password_sent_at"
      t.datetime "remember_created_at"
      t.timestamps null: false
      t.index ["email"], name: "index_users_on_email", unique: true
      t.index ["reset_password_token"], name: "index_users_on_reset_password_token", unique: true
    end

    # --- 4. CORE LOOKUPS (Projects, Phases, Bid Items) ---
    create_table "projects", force: :cascade do |t|
      t.string "name"
      t.timestamps
    end

    create_table "phases", force: :cascade do |t|
      t.string "name"
      t.timestamps
    end

    create_table "bid_items", force: :cascade do |t|
      t.string "code"
      t.string "description"
      t.string "unit"
      t.jsonb "checklist_questions" # This is your JSONB array
      t.timestamps
    end

    # --- 5. REPORTS (The Core Table) ---
    create_table "reports", force: :cascade do |t|
      t.string "dir_number"
      t.date "start_date"
      t.date "end_date"
      
      # Associations
      t.references :project, null: false, foreign_key: true
      t.references :phase, null: false, foreign_key: true
      t.references :user, null: false, foreign_key: true

      # Workflow
      t.integer "status"
      t.integer "result"

      # Shift Info
      t.string "shift_start"
      t.string "shift_end"
      t.string "foreman" 
      t.string "superintendent"
      
      # Weather
      t.integer "temp_1"; t.integer "temp_2"; t.integer "temp_3"
      t.string "wind_1"; t.string "wind_2"; t.string "wind_3"
      t.string "precip_1"; t.string "precip_2"; t.string "precip_3"
      t.string "weather_summary_1"; t.string "weather_summary_2"; t.string "weather_summary_3"

      # Location / Docs
      t.string "contractor"
      t.string "plan_sheet"
      t.string "relevant_docs"
      t.string "station_start"
      t.string "station_end"

      # Checklists & Compliance
      t.integer "deficiency_status"
      t.text "deficiency_desc"
      t.integer "traffic_control"
      t.integer "environmental"
      t.integer "security"
      t.integer "safety_incident"
      t.text "safety_desc"
      t.integer "air_ops_coordination", default: 0
      t.integer "swppp_controls", default: 0

      # Text Areas
      t.text "commentary"
      t.text "additional_activities"
      t.text "additional_info"
      
      # Legacy / Misc counts (often handled by nested tables now, but kept for safety)
      t.integer "laborer_count"
      t.integer "operator_count"
      t.integer "survey_count"
      t.integer "electrician_count"

      t.timestamps
    end

    # --- 6. NESTED ENTRIES (The Big Four) ---
    
    # Inspection Entries (To be renamed PlacedQuantity later)
    create_table "placed_quantities", force: :cascade do |t|
      t.references :report, null: false, foreign_key: true
      t.references :bid_item, null: false, foreign_key: true
      t.decimal "quantity"
      t.text "notes"
      t.jsonb "checklist_answers", default: {}
      t.timestamps
    end

    create_table "equipment_entries", force: :cascade do |t|
      t.references :report, null: false, foreign_key: true
      t.string "contractor"
      t.string "make_model"
      t.integer "quantity", default: 1
      t.decimal "hours"
      t.timestamps
    end

    create_table "crew_entries", force: :cascade do |t|
      t.references :report, null: false, foreign_key: true
      t.string "contractor"
      t.string "foreman"
      t.string "superintendent"
      t.integer "laborer_count"
      t.integer "operator_count"
      t.integer "survey_count"
      t.integer "electrician_count"
      t.text "notes"
      t.timestamps
    end

    create_table "qa_entries", force: :cascade do |t|
      t.references :report, null: false, foreign_key: true
      t.integer "qa_type"
      t.string "location"
      t.integer "result"
      t.string "remarks"
      t.timestamps
    end

    # --- 7. MISC TABLES ---
    create_table "activity_logs", force: :cascade do |t|
      t.references :report, null: false, foreign_key: true
      t.references :user, null: false, foreign_key: true
      t.text "note"
      t.timestamps
    end

    create_table "report_attachments", force: :cascade do |t|
      t.references :report, null: false, foreign_key: true
      t.string "caption"
      t.timestamps
    end

    # --- 8. FOREIGN KEYS (Active Storage) ---
    add_foreign_key "active_storage_attachments", "active_storage_blobs", column: "blob_id"
    add_foreign_key "active_storage_variant_records", "active_storage_blobs", column: "blob_id"
  end
end

================================================================================
FILE: db/migrate/20260109033513_create_spec_items.rb
================================================================================
class CreateSpecItems < ActiveRecord::Migration[7.1]
  def change
    create_table :spec_items do |t|
      t.string :code
      t.string :description
      t.jsonb :checklist_questions

      t.timestamps
    end
  end
end


================================================================================
FILE: db/migrate/20260109033530_add_spec_to_bid_items.rb
================================================================================
class AddSpecToBidItems < ActiveRecord::Migration[7.1]
  def change
    add_reference :bid_items, :spec_item, null: false, foreign_key: true
  end
end


================================================================================
FILE: db/migrate/20260109043500_create_checklist_entries.rb
================================================================================
class CreateChecklistEntries < ActiveRecord::Migration[7.1]
  def change
    create_table :checklist_entries do |t|
      t.references :report, null: false, foreign_key: true
      t.references :spec_item, null: false, foreign_key: true
      t.jsonb :checklist_answers

      t.timestamps
    end
  end
end


================================================================================
FILE: db/migrate/20260109043514_add_division_to_spec_items.rb
================================================================================
class AddDivisionToSpecItems < ActiveRecord::Migration[7.1]
  def change
    add_column :spec_items, :division, :string
  end
end


================================================================================
FILE: db/migrate/20260109180602_make_report_fields_optional.rb
================================================================================
# db/migrate/[TIMESTAMP]_make_report_fields_optional.rb
class MakeReportFieldsOptional < ActiveRecord::Migration[7.1]
  def change
    # Allow these to be null for the "Draft" state
    change_column_null :reports, :project_id, true
    change_column_null :reports, :phase_id, true
  end
end

================================================================================
FILE: db/migrate/20260109235950_convert_project_to_library.rb
================================================================================
class ConvertProjectToLibrary < ActiveRecord::Migration[7.1]
  def change
    # 1. Add the "Header" fields to the Project Library
    add_column :projects, :contract_number, :string
    add_column :projects, :project_manager, :string
    add_column :projects, :construction_manager, :string
    add_column :projects, :contract_days, :integer
    add_column :projects, :contract_start_date, :date

    # 2. Link Bid Items to Projects
    # We allow null temporarily (null: true) to avoid crashing existing data
    add_reference :bid_items, :project, null: true, foreign_key: true
  end
end

================================================================================
FILE: db/migrate/20260111135437_add_fields_to_reports.rb
================================================================================
class AddFieldsToReports < ActiveRecord::Migration[7.1]
  def change
    # --- 1. Weather Enhancements ---
    # Visibility tracks per shift (Start/Mid/End)
    add_column :reports, :visibility_1, :string
    add_column :reports, :visibility_2, :string
    add_column :reports, :visibility_3, :string
    
    # Surface Conditions is now a SINGLE site-wide field
    add_column :reports, :surface_conditions, :string

    # --- 2. New Compliance Item ---
    # 0=N/A, 1=Yes (Compliant), 2=No (Non-Compliant)
    add_column :reports, :phasing_compliance, :integer, default: 0

    # --- 3. Conditional Notes for Compliance ---
    # Stores the explanation when "No" is selected
    add_column :reports, :phasing_compliance_note, :text
    add_column :reports, :traffic_control_note, :text
    add_column :reports, :environmental_note, :text
    add_column :reports, :security_note, :text
    add_column :reports, :air_ops_note, :text
    add_column :reports, :swppp_note, :text
  end
end

================================================================================
FILE: db/seeds.rb
================================================================================
# db/seeds.rb

puts "ðŸŒ± Maestro: Cleaning old data..."
# We destroy child records first to avoid foreign key errors
ChecklistEntry.destroy_all
PlacedQuantity.destroy_all
QaEntry.destroy_all
CrewEntry.destroy_all
EquipmentEntry.destroy_all
ReportAttachment.destroy_all
Report.destroy_all
BidItem.destroy_all   # Now depends on Project
SpecItem.destroy_all
Project.destroy_all
Phase.destroy_all

puts "ðŸ—ï¸  Maestro: Building Projects (The Libraries)..."
# We now include the required Contract Info 
project_1 = Project.create!(
  name: "Runway 1R Rehabilitation",
  contract_number: "8983.61",
  project_manager: "Anthony Lum, PE",
  construction_manager: "Joshua Alcantara, PE",
  contract_days: 89,
  contract_start_date: Date.new(2025, 9, 24)
)

Project.create!(
  name: "Taxiway Z Rehabilitation",
  contract_number: "9000.12",
  project_manager: "Anthony Lum, PE",
  construction_manager: "Joshua Alcantara, PE",
  contract_days: 120,
  contract_start_date: Date.new(2025, 10, 1)
)

Project.create!(
  name: "Gate 17 Apron Rehabilitation",
  contract_number: "7555.05",
  project_manager: "Sarah Engineer, PE",
  construction_manager: "Mike Builder",
  contract_days: 45,
  contract_start_date: Date.new(2026, 1, 15)
)

puts "ðŸ“… Maestro: Building Phases..."
(1..6).each { |i| Phase.create!(name: "Phase #{i}") }

puts "ðŸ“˜ Maestro: Building FAA Spec Library (AC 150/5370-10H)..."

# Default Checklist Questions
default_questions = [
  "Material submittals approved?",
  "Weather conditions acceptable?",
  "Equipment clean and functional?",
  "Grade and alignment checked?",
  "Safety requirements met?",
  "Photos taken?"
]

# The FAA Master List (Simplified for Seed)
faa_specs = {
  "Part 6 â€“ Flexible Pavements" => {
    "P-401" => "Asphalt Mix Pavement",
    "P-403" => "Asphalt Mix Pavement [Base/Leveling/Surface]",
  },
  "Part 3 â€“ Sitework" => {
    "P-152" => "Excavation, Subgrade, and Embankment",
  },
  "Part 9 â€“ Miscellaneous" => {
    "P-620" => "Runway and Taxiway Marking",
    "P-603" => "Emulsified Asphalt Tack Coat"
  },
  "Part 11 â€“ Drainage" => {
    "D-701" => "Pipe for Storm Drains and Culverts"
  },
  "Part 13 â€“ Lighting Installation" => {
    "L-108" => "Underground Power Cable for Airports"
  }
}

faa_specs.each do |division, items|
  items.each do |code, desc|
    SpecItem.create!(
      code: code,
      description: desc,
      division: division,
      checklist_questions: default_questions
    )
  end
end

puts "ðŸ’° Maestro: Linking Bid Items (The Translation Layer)..."

# We link specific codes (e.g. "BID-P-401-01") to Project 1
# This simulates the "Project Library" concept
["P-401", "P-403", "P-152", "P-620", "D-701", "L-108"].each do |code|
  spec = SpecItem.find_by(code: code)
  next unless spec
  
  BidItem.create!(
    project: project_1,            # <--- The Critical Link
    code: "BID-#{code}-01",        # The Project-Specific Code
    description: "Install #{spec.description}",
    unit: "EA",
    spec_item: spec,               # <--- The Universal Definition
    checklist_questions: spec.checklist_questions
  )
end

puts "âœ… Maestro: Seeding Complete!"
puts "   Projects Created: #{Project.count}"
puts "   Bid Items (Project 1): #{project_1.bid_items.count}"

================================================================================
FILE: public/404.html
================================================================================
<!DOCTYPE html>
<html>
<head>
  <title>The page you were looking for doesn't exist (404)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
  .rails-default-error-page {
    background-color: #EFEFEF;
    color: #2E2F30;
    text-align: center;
    font-family: arial, sans-serif;
    margin: 0;
  }

  .rails-default-error-page div.dialog {
    width: 95%;
    max-width: 33em;
    margin: 4em auto 0;
  }

  .rails-default-error-page div.dialog > div {
    border: 1px solid #CCC;
    border-right-color: #999;
    border-left-color: #999;
    border-bottom-color: #BBB;
    border-top: #B00100 solid 4px;
    border-top-left-radius: 9px;
    border-top-right-radius: 9px;
    background-color: white;
    padding: 7px 12% 0;
    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
  }

  .rails-default-error-page h1 {
    font-size: 100%;
    color: #730E15;
    line-height: 1.5em;
  }

  .rails-default-error-page div.dialog > p {
    margin: 0 0 1em;
    padding: 1em;
    background-color: #F7F7F7;
    border: 1px solid #CCC;
    border-right-color: #999;
    border-left-color: #999;
    border-bottom-color: #999;
    border-bottom-left-radius: 4px;
    border-bottom-right-radius: 4px;
    border-top-color: #DADADA;
    color: #666;
    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
  }
  </style>
</head>

<body class="rails-default-error-page">
  <!-- This file lives in public/404.html -->
  <div class="dialog">
    <div>
      <h1>The page you were looking for doesn't exist.</h1>
      <p>You may have mistyped the address or the page may have moved.</p>
    </div>
    <p>If you are the application owner check the logs for more information.</p>
  </div>
</body>
</html>


================================================================================
FILE: public/422.html
================================================================================
<!DOCTYPE html>
<html>
<head>
  <title>The change you wanted was rejected (422)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
  .rails-default-error-page {
    background-color: #EFEFEF;
    color: #2E2F30;
    text-align: center;
    font-family: arial, sans-serif;
    margin: 0;
  }

  .rails-default-error-page div.dialog {
    width: 95%;
    max-width: 33em;
    margin: 4em auto 0;
  }

  .rails-default-error-page div.dialog > div {
    border: 1px solid #CCC;
    border-right-color: #999;
    border-left-color: #999;
    border-bottom-color: #BBB;
    border-top: #B00100 solid 4px;
    border-top-left-radius: 9px;
    border-top-right-radius: 9px;
    background-color: white;
    padding: 7px 12% 0;
    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
  }

  .rails-default-error-page h1 {
    font-size: 100%;
    color: #730E15;
    line-height: 1.5em;
  }

  .rails-default-error-page div.dialog > p {
    margin: 0 0 1em;
    padding: 1em;
    background-color: #F7F7F7;
    border: 1px solid #CCC;
    border-right-color: #999;
    border-left-color: #999;
    border-bottom-color: #999;
    border-bottom-left-radius: 4px;
    border-bottom-right-radius: 4px;
    border-top-color: #DADADA;
    color: #666;
    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
  }
  </style>
</head>

<body class="rails-default-error-page">
  <!-- This file lives in public/422.html -->
  <div class="dialog">
    <div>
      <h1>The change you wanted was rejected.</h1>
      <p>Maybe you tried to change something you didn't have access to.</p>
    </div>
    <p>If you are the application owner check the logs for more information.</p>
  </div>
</body>
</html>


================================================================================
FILE: public/500.html
================================================================================
<!DOCTYPE html>
<html>
<head>
  <title>We're sorry, but something went wrong (500)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
  .rails-default-error-page {
    background-color: #EFEFEF;
    color: #2E2F30;
    text-align: center;
    font-family: arial, sans-serif;
    margin: 0;
  }

  .rails-default-error-page div.dialog {
    width: 95%;
    max-width: 33em;
    margin: 4em auto 0;
  }

  .rails-default-error-page div.dialog > div {
    border: 1px solid #CCC;
    border-right-color: #999;
    border-left-color: #999;
    border-bottom-color: #BBB;
    border-top: #B00100 solid 4px;
    border-top-left-radius: 9px;
    border-top-right-radius: 9px;
    background-color: white;
    padding: 7px 12% 0;
    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
  }

  .rails-default-error-page h1 {
    font-size: 100%;
    color: #730E15;
    line-height: 1.5em;
  }

  .rails-default-error-page div.dialog > p {
    margin: 0 0 1em;
    padding: 1em;
    background-color: #F7F7F7;
    border: 1px solid #CCC;
    border-right-color: #999;
    border-left-color: #999;
    border-bottom-color: #999;
    border-bottom-left-radius: 4px;
    border-bottom-right-radius: 4px;
    border-top-color: #DADADA;
    color: #666;
    box-shadow: 0 3px 8px rgba(50, 50, 50, 0.17);
  }
  </style>
</head>

<body class="rails-default-error-page">
  <!-- This file lives in public/500.html -->
  <div class="dialog">
    <div>
      <h1>We're sorry, but something went wrong.</h1>
    </div>
    <p>If you are the application owner check the logs for more information.</p>
  </div>
</body>
</html>
